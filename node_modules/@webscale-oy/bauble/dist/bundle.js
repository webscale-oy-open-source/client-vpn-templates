!function(e){var t={};function n(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(i,a,function(t){return e[t]}.bind(null,a));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=73)}([function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1);var o;t.validateInput=(e,t)=>i(void 0,void 0,void 0,(function*(){const{error:n}=e.validate(t);if(n){const e=n.details.map(e=>`  - ${e.message}`).join("\n");throw new a.BaubleError(`${n.details.length} validation error(s) in arguments:\n\n${e}`)}return t})),function(e){e.SUCCESS="SUCCESS",e.FAILED="FAILED",e.CANCELLED="CANCELLED",e.SKIPPED="SKIPPED"}(o=t.CommandStatus||(t.CommandStatus={})),t.resolveCommandOutputBase=e=>{const t=void 0===e.find(e=>!e.success);return{status:t?o.SUCCESS:o.FAILED,message:t?"Success":"Failed",success:t}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class i extends Error{constructor(e,t){super(e),this.isBaubleError=!0,this.info=null==t?void 0:t.info,this.instructions=null==t?void 0:t.instructions,Object.setPrototypeOf(this,new.target.prototype)}}t.BaubleError=i},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(78)),s=a(n(19)),r=a(n(11)),c=a(n(79));t.sleep=e=>i(void 0,void 0,void 0,(function*(){return new Promise(t=>setTimeout(t,e))})),t.deepCopy=e=>JSON.parse(JSON.stringify(e)),t.indentLines=(e,t=2)=>{const n=" ".repeat(t);return e.split("\n").map(e=>`${n}${e}`).join("\n")},t.checksum=e=>c.default.createHash("sha256").update(e,"utf8").digest("hex"),t.getStringSizeInBytes=e=>Buffer.byteLength(e,"utf8"),t.isAwsMetaEndpointAvailable=()=>new Promise((e,t)=>{const n=o.default.request({method:"GET",host:"169.254.169.254",port:80,path:"/latest/meta-data/",timeout:200},t=>{e(200===t.statusCode)});n.on("timeout",()=>{n.destroy()}),n.on("error",()=>{e(!1)}),n.end()});class u{constructor(e){this.children=[],this.stopTime=0,this.startChild=e=>{const t=new u(e);return this.children.push(t),t},this.stop=e=>(0===this.stopTime&&(this.stopTime=e||Date.now()),this.children.forEach(t=>t.stop(e)),this),this.name=e,this.startTime=Date.now()}get secondsElapsed(){return 0===this.stopTime?Date.now()-this.startTime:this.stopTime-this.startTime}}t.StopWatch=u;const l=(e,t,n)=>{const i=" ".repeat(2*n);t.cell("Name",`${i}${e.name}`),t.cell("Time",s.default(e.secondsElapsed)),t.newRow(),e.children.forEach(e=>l(e,t,n+1))};t.printStopWatch=e=>{const t=new r.default;return l(e,t,0),t.toString()},t.identity=e=>e},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CONFIG_FILE_EXTENSION=".yml",t.TEMPLATES_DIR="templates",t.STACKS_DIR="stacks",t.PARTIALS_DIR="partials",t.HELPERS_DIR="helpers",t.HOOKS_DIR="hooks",t.RESOLVERS_DIR="resolvers",t.ORGANIZATION_DIR="organization",t.DEPLOYMENT_DIR="deployment",t.DEPLOYMENT_CONFIG_FILE="targets.yml",t.STACK_GROUP_CONFIG_FILE="config.yml",t.ORGANIZATION_CONFIG_FILE="organization.yml",t.ROOT_STACK_GROUP_PATH="/",t.DEFAULT_ORGANIZATION_ROLE_NAME="OrganizationAccountAccessRole",t.SERVICE_CONTROL_POLICY_MAX_SIZE_IN_BYTES=5120,t.TAG_POLICY_MAX_SIZE_IN_CHARACTERS=2500,t.REGIONS=["us-east-2","us-east-1","us-west-1","us-west-2","ap-east-1","ap-south-1","ap-northeast-3","ap-northeast-2","ap-southeast-1","ap-southeast-2","ap-northeast-1","ca-central-1","cn-north-1","cn-northwest-1","eu-central-1","eu-west-1","eu-west-2","eu-west-3","eu-north-1","me-south-1","sa-east-1","us-gov-east-1"],t.ORGANIZATION_SERVICE_PRINCIPALS=["aws-artifact-account-sync.amazonaws.com","cloudtrail.amazonaws.com","config.amazonaws.com","ds.amazonaws.com","fms.amazonaws.com","license-manager.amazonaws.com","ram.amazonaws.com","servicecatalog.amazonaws.com","ssm.amazonaws.com","sso.amazonaws.com","tagpolicies.tag.amazonaws.com"],t.SERVICE_CONTROL_POLICY_TYPE="SERVICE_CONTROL_POLICY",t.TAG_POLICY_TYPE="TAG_POLICY",t.ORGANIZATION_POLICY_TYPES=[t.SERVICE_CONTROL_POLICY_TYPE,t.TAG_POLICY_TYPE],t.DEFAULT_SERVICE_CONTROL_POLICY_NAME="FullAWSAccess",t.DEFAULT_SERVICE_CONTROL_POLICY_ID="p-FullAWSAccess"},function(e,t){e.exports=require("@hapi/joi")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(13)),s=a(n(34)),r=n(8),c=n(24),u=n(6),l=n(50),d=n(14),f=a(n(19)),h=n(2),m=a(n(11)),p=n(1),g=a(n(81)),v=a(n(82)),y=n(20),C=(e,t)=>i(void 0,void 0,void 0,(function*(){const n=o.default.join(e,t);if(!(yield r.fileExists(n)))throw new p.BaubleError(`Variable file ${n} not found`);if(n.endsWith(".json")){const e=yield r.readFileContents(n);return JSON.parse(e)}return n.endsWith(".yml")?yield c.parseYamlFile(n):(yield r.readFileContents(n)).trim()}));t.parseVarFileArgs=(e,t)=>i(void 0,void 0,void 0,(function*(){const n=t?Array.isArray(t)?t:[t]:[],i={};for(const t of n)if(/^([a-zA-Z][a-zA-Z0-9_]+)=/.test(t)){const[n,a]=t.split("=",2),o=yield C(e,a);s.default(i,{[n]:o})}else{const n=yield C(e,t);if("object"!=typeof n)throw new p.BaubleError(`Contents of variable file ${t} could not be deserialized to an object`);s.default(i,n)}return i})),t.parseVarArgs=(e,t)=>{const n=e?Array.isArray(e)?e:[e]:[];for(const e of n){if(!/^([a-zA-Z][a-zA-Z0-9_]+)=/.test(e))throw new p.BaubleError(`Invalid variable ${e}`);{const[n,i]=e.split("=",2);s.default(t,{[n]:i})}}return t};t.parseVariables=(e,n,a,s)=>i(void 0,void 0,void 0,(function*(){const c=yield t.parseVarFileArgs(e,n),u=t.parseVarArgs(a,c);return yield((e,t)=>i(void 0,void 0,void 0,(function*(){const n=t?Array.isArray(t)?t:[t]:[];for(const t of n){const n=o.default.join(e,t);if(!(yield r.fileExists(n)))throw new p.BaubleError(`Environment variables file ${n} not found`);const i=yield r.readFileContents(n),a=g.default.parse(i);v.default(a);for(const e in a)process.env[e]=a[e]}})))(e,s),{env:Object.keys(process.env).reduce((e,t)=>Object.assign(Object.assign({},e),{[t]:process.env[t]}),{}),vars:u,context:(e=>({projectDir:e}))(e)}}));t.initOptionsAndVariables=e=>i(void 0,void 0,void 0,(function*(){e.profile&&(process.env.AWS_PROFILE=e.profile),e["load-aws-sdk-config"]&&(process.env.AWS_SDK_LOAD_CONFIG="true");const n=(e=>{if(e){const t=e.toString();return t.startsWith("/")?t:o.default.join(process.cwd(),t)}return process.cwd()})(e.dir),i=(e=>{switch(e){case"trace":return l.LogLevel.TRACE;case"debug":return l.LogLevel.DEBUG;case"info":return l.LogLevel.INFO;case"warn":return l.LogLevel.WARN;case"error":return l.LogLevel.ERROR;default:return l.LogLevel.INFO}})(e.log);return{options:new u.Options({logLevel:i,projectDir:n,autoConfirm:!0===e.yes,stats:!0===e.stats,logConfidentialInfo:!0===e["log-confidential-info"]}),variables:yield t.parseVariables(n,e["var-file"],e.var,e["env-file"]),watch:new h.StopWatch("total")}})),t.onError=e=>{console.log(),console.log(y.red("ERROR")),console.log(y.red("-----")),e.isBaubleError?(console.log(y.red(e.message)),e.info&&(console.log(),console.log(y.red("[!] Additional info:")),console.log(),console.log(y.red(`  ${e.info}`))),e.instructions&&(console.log(),console.log(y.red("[!] How to fix:")),console.log(),e.instructions.forEach(e=>{console.log(y.red(`  - ${e}`))}))):console.log(y.red(e.stack)),console.log(),process.exit(1)};const w=e=>Math.round(e/1024/1024*100)/100;t.onComplete=(e,t)=>{if(e.isStatsEnabled()){const{heapUsed:e,heapTotal:n,external:i,rss:a}=process.memoryUsage(),o=new m.default;console.log(),console.log("Memory usage:"),console.log(),o.cell("Segment","rss"),o.cell("MB",w(a)),o.newRow(),o.cell("Segment","heap total"),o.cell("MB",w(n)),o.newRow(),o.cell("Segment","heap used"),o.cell("MB",w(e)),o.newRow(),o.cell("Segment","external"),o.cell("MB",w(i)),o.newRow(),console.log(h.indentLines(o.toString())),console.log("Execution times:"),console.log(),console.log(h.indentLines(h.printStopWatch(t.watch)))}console.log(),console.log(`Completed in ${f.default(t.watch.secondsElapsed)} with status: ${d.formatCommandStatus(t.status)}`),console.log(),t.success||process.exit(1)},t.handle=(e,n,a)=>i(void 0,void 0,void 0,(function*(){try{const i=yield t.initOptionsAndVariables(e),o=n(i),s=yield a(o);t.onComplete(i.options,s)}catch(e){t.onError(e)}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.YES=0]="YES",e[e.NO=1]="NO"}(t.ConfirmResult||(t.ConfirmResult={}));t.Options=class{constructor(e){this.getProjectDir=()=>this.projectDir,this.getLogLevel=()=>this.logLevel,this.isConfidentialInfoLoggingEnabled=()=>this.logConfidentialInfo,this.isAutoConfirmEnabled=()=>this.autoConfirm,this.isStatsEnabled=()=>this.stats,this.projectDir=e.projectDir,this.autoConfirm=e.autoConfirm,this.logLevel=e.logLevel,this.logConfidentialInfo=e.logConfidentialInfo,this.stats=e.stats}}},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(4)),o=n(3);t.accountId=a.default.string().regex(/^\d{12}$/),t.accountIds=a.default.array().items(t.accountId).unique(),t.variableName=a.default.string().min(1).max(60).regex(/^[a-zA-Z_]+[a-zA-Z0-9-_]*$/),t.vars=a.default.object().pattern(t.variableName,a.default.any()),t.iamRoleName=a.default.string().min(1).max(64).regex(/^[\w+=/,.@-]+$/),t.configSetName=a.default.string().min(1).max(60).regex(/^[a-zA-Z_]+[a-zA-Z0-9-_]*$/),t.commandPath=a.default.string().max(128).custom((e,t)=>{const n=/^\/$|^(\/[a-zA-Z][a-zA-Z0-9-]*)+(\.yml(\/([a-z0-9-]+))?)?$/;if(!n.test(e))return t.error("string.pattern.base",{regex:n});const i=e.match(n)[4];return i?o.REGIONS.includes(i)?e:t.error("invalidRegion",{region:i,regions:o.REGIONS.join(",")}):e},"command path").messages({invalidRegion:'"{{#label}}" with value "{{#value}}" has invalid region "{{#region}}". The region must be one of [{{#regions}}]'}),t.configSet=a.default.object({description:a.default.string(),commandPaths:a.default.array().items(t.commandPath).unique(),vars:t.vars}),t.iamRoleArn=a.default.string().regex(/^arn:aws:iam::\d{12}:role\/.+$/),t.project=a.default.string().min(1).max(60).regex(/^[a-zA-Z]+[a-zA-Z0-9-]*$/),t.region=a.default.string().valid(...o.REGIONS),t.regions=[t.region,a.default.array().items(t.region).unique()],t.data=t.vars,t.stackPath=a.default.string().max(100).regex(/^(\/[a-zA-Z][a-zA-Z0-9-]*)+\.yml\/?/).custom((e,t)=>{const[n,i]=e.split(".yml",2);if(!i)return e;const a=i.substr(1);return o.REGIONS.includes(a)?e:t.error("invalidRegion",{region:a,regions:o.REGIONS.join(",")})},"stack path").messages({invalidRegion:'"{{#label}}" with value "{{#value}}" has invalid region "{{#region}}". The region must be one of [{{#regions}}]'}),t.stackPaths=a.default.array().items(t.stackPath).unique(),t.stackGroupName=a.default.string().regex(/^[a-zA-Z][a-zA-Z0-9-]*$/),t.stackGroupPath=a.default.string().max(100).regex(/^\/$|^(\/[a-zA-Z][a-zA-Z0-9-]*)+$/),t.stackName=a.default.string().min(1).max(128).regex(/^[a-zA-Z][a-zA-Z0-9-]*$/)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const o=n(35),s=a(n(76)),r=o.promisify(s.default.stat),c=o.promisify(s.readFile);t.readFileContents=e=>i(void 0,void 0,void 0,(function*(){return c(e,{encoding:"UTF-8"}).then(e=>e.toString())})),t.fileExists=e=>i(void 0,void 0,void 0,(function*(){return r(e).then(e=>e.isFile()).catch(()=>!1)})),t.dirExists=e=>i(void 0,void 0,void 0,(function*(){return r(e).then(e=>e.isDirectory()).catch(()=>!1)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(123)),s=n(50),r=n(2);class c extends s.ConsoleLogger{constructor(e,t=null){super(e.getLogLevel(),t),this.header=(e,t=!1,n=!1)=>{this.message(e,t),this.message("=".repeat(e.length),!1,n)},this.message=(e="",t=!1,n=!1)=>{t&&console.log(),console.log(e),n&&console.log()},this.longMessage=(e,t=!1,n=!1)=>{t&&console.log(),console.log(e.join("\n")),n&&console.log()},this.multilineMessage=(e,t=!1,n=!1,i=0)=>{t&&console.log(),console.log(r.indentLines(e,i)),n&&console.log()},this.confirm=(e,t=!1)=>i(this,void 0,void 0,(function*(){t&&console.log();const{answer:n}=yield o.default.prompt([{message:e,name:"answer",type:"confirm"}]);return n})),this.question=(e,t=!1)=>i(this,void 0,void 0,(function*(){t&&console.log();const{answer:n}=yield o.default.prompt([{message:e,type:"input",name:"answer"}]);return n})),this.choose=(e,t,n=!1)=>i(this,void 0,void 0,(function*(){n&&console.log();const{answer:i}=yield o.default.prompt([{choices:t,message:e,name:"answer",type:"list"}]);return i})),this.options=e}}t.default=c},function(e,t){e.exports=require("lodash.flatten")},function(e,t){e.exports=require("easy-table")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.collectFromHierarchy=(e,n,i)=>{const a=(null==i?void 0:i.filter)||(()=>!0);if(!a(e))return[];const o=n(e).filter(a);return((null==i?void 0:i.sortSiblings)?o.slice().sort(null==i?void 0:i.sortSiblings):o).reduce((e,a)=>[...e,...t.collectFromHierarchy(a,n,i)],[e])}},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0),a=n(20);t.formatCommandStatus=e=>{switch(e){case i.CommandStatus.CANCELLED:return a.grey(e);case i.CommandStatus.FAILED:return a.red(e);case i.CommandStatus.SKIPPED:return a.grey(e);case i.CommandStatus.SUCCESS:return a.green(e);default:return e}},t.formatResourceStatus=e=>e.endsWith("COMPLETE")?a.green(e):e.endsWith("IN_PROGRESS")?a.yellow(e):e.endsWith("FAILED")?a.red(e):e.endsWith("SKIPPED")?a.grey(e):e,t.formatStackEvent=e=>[e.StackName,e.LogicalResourceId,e.ResourceType,t.formatResourceStatus(e.ResourceStatus),e.ResourceStatusReason].join(" "),t.formatResourceChange=(e,t,n)=>{switch(e){case"Add":return a.green(`  + ${n}`);case"Modify":return"True"===t?a.orange(`  ± ${n} (new resource required)`):"Conditional"===t?a.orange(`  ± ${n} (new resource required conditionally)`):a.yellow(`  ~ ${n}`);case"Remove":return a.red(`  - ${n}`);default:throw new Error(`Unsupported change action: ${e}`)}},t.formatAccountStatus=e=>{switch(e){case"ACTIVE":return a.green(e);case"SUSPENDED":return a.grey(e);default:throw new Error(`Unsupported account status state: ${e}`)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(84);t.prepareLaunchContext=i.prepareLaunchContext;const a=n(86);t.prepareDeleteContext=a.prepareDeleteContext;const o=n(88);t.buildConfigContext=o.buildConfigContext,t.ConfigContext=o.ConfigContext},function(e,t){e.exports=require("lodash.uniq")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(90)),s=n(1);t.TemplateEngine=class{constructor(){this.registerHelper=(e,t)=>{this.instance.registerHelper(e,t)},this.registerPartial=(e,t)=>{const n=this.instance.compile(t);this.instance.registerPartial(e,n)},this.renderTemplate=(e,t)=>this.instance.compile(e,{noEscape:!1,strict:!0})(t),this.instance=o.default.create()}},t.renderTemplate=(e,t,n,a)=>i(void 0,void 0,void 0,(function*(){try{return e.renderTemplate(n,a)}catch(e){throw new s.BaubleError(`An error occurred while rendering template: ${e.message}\n\n`+`File:        ${t}\n`+`Line number: ${e.lineNumber}\n`+`Column:      ${e.column}`)}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(21),o=n(31);class s extends o.AwsClient{constructor(e){super(e),this.getClient=(e,t)=>new a.SSM(Object.assign(Object.assign({},this.clientOptions()),{credentials:e,region:t})),this.putEncryptedParameter=(e,t,n)=>i(this,void 0,void 0,(function*(){return this.withClientPromise(i=>i.putParameter({Type:"SecureString",Value:t,Name:e,Overwrite:!0,Description:n}),()=>!0)})),this.getEncryptedParameter=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.getParameter({Name:e,WithDecryption:!0}),e=>e.Parameter.Value,e=>{if("ParameterNotFound"===e.code)return null;throw e})})),this.getParameterHistory=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.getParameterHistory({Name:e,WithDecryption:!0}),e=>e.Parameters)})),this.getParameterDescription=e=>i(this,void 0,void 0,(function*(){return this.getParameterHistory(e).then(e=>e[0].Description)})),this.deleteParameters=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.deleteParameters({Names:e}),()=>!0)})),this.getEncryptedParametersByPath=e=>i(this,void 0,void 0,(function*(){return this.withClient(t=>this.pagedOperation(e=>t.getParametersByPath(e),{Path:e,WithDecryption:!0,Recursive:!0},e=>e.Parameters))}))}}t.SSMClient=s},function(e,t){e.exports=require("pretty-ms")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(80);t.green=i.green,t.red=i.red,t.yellow=i.yellow,t.grey=i.grey,t.orange=i.keyword("orange")},function(e,t){e.exports=require("aws-sdk")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(25),s=n(2),r=n(62),c=a(n(13)),u=n(3),l=n(8),d=n(1),f=n(17),h=a(n(38)),m=n(46),p=n(12),g=n(164);class v{constructor(e){this.getClient=()=>new r.OrganizationsClient({region:"us-east-1",credentialProvider:this.organizationAdminCredentialProvider,logger:this.logger.childLogger("http")}),this.hasOrganizationalUnit=e=>void 0!==this.organizationalUnits.find(t=>t.path===e),this.getOrganizationalUnit=e=>{const t=this.organizationalUnits.find(t=>t.path===e);if(!t)throw new Error(`No such organizational unit: '${e}'`);return t},this.getOptions=()=>this.options,this.getLogger=()=>this.logger,this.getVariables=()=>s.deepCopy(this.variables),this.getDefaultCredentialProvider=()=>this.defaultCredentialProvider,this.getOrganizationConfigFile=()=>this.organizationConfigFile,this.getConfigSet=e=>{const t=this.organizationConfigFile.configSets.find(t=>t.name===e);if(!t)throw new Error(`No such config set: ${e}`);return t},this.defaultCredentialProvider=e.defaultCredentialProvider,this.organizationAdminCredentialProvider=e.organizationAdminCredentialProvider,this.logger=e.logger,this.options=e.options,this.variables=e.variables,this.organizationConfigFile=e.organizationConfigFile,this.organizationalUnits=p.collectFromHierarchy(e.organizationConfigFile.organizationalUnits.Root,e=>e.children)}}t.OrganizationContext=v;t.buildOrganizationContext=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const a=yield o.initDefaultCredentialProviderChain(),s=new o.DefaultCredentialProvider(a);n.info("Validate credentials"),yield(e=>i(void 0,void 0,void 0,(function*(){return e.getCallerIdentity()})))(s);const p=e.getProjectDir();n.debug(`Current project dir: ${p}`);const y=c.default.join(p,u.ORGANIZATION_DIR);if(!(yield l.dirExists(y)))throw new d.BaubleError(`Bauble organization dir '${u.ORGANIZATION_DIR}' not found from the project dir ${p}`);const C=c.default.join(y,u.ORGANIZATION_CONFIG_FILE);if(!(yield l.fileExists(C)))throw new d.BaubleError(`Bauble organization configuration file '${u.ORGANIZATION_CONFIG_FILE}' not found from the organization dir ${y}`);const w=new f.TemplateEngine;var P,_,S;yield(P=y,_=n,S=w,i(void 0,void 0,void 0,(function*(){const e=c.default.join(P,u.PARTIALS_DIR);if(yield l.dirExists(e)){_.debug(`Found partials dir: ${e}`);const t=yield h.default.promise(e,{alwaysStat:!0,depth:100,type:"files"});for(const n of t){const t=n.fullPath.substr(e.length+1);_.debug(`Register partial: ${t}`);const i=yield l.readFileContents(n.fullPath);S.registerPartial(t,i)}}else _.debug("Partials dir not found")})));const b=yield g.parseOrganizationConfigFile(n,e,t,C,w),O=yield((e,t,n)=>i(void 0,void 0,void 0,(function*(){if(t.organizationAdminRoleName){const i=`arn:aws:iam::${t.masterAccountId}:role/${t.organizationAdminRoleName}`;return e.debug(`Using role '${i}' to manage the organization`),n.createCredentialProviderForCommandRole({iamRoleArn:i})}return e.debug("Using default credential provider to manage the organization"),n})))(n,b,s),E=new r.OrganizationsClient({region:"us-east-1",credentialProvider:O,logger:n.childLogger("http")}),[A,k]=yield Promise.all([O.getCallerIdentity(),E.describeOrganization()]);return m.validateOrganizationConfigFile(b,A,k),new v({variables:t,options:e,logger:n,defaultCredentialProvider:s,organizationAdminCredentialProvider:O,organizationConfigFile:b})}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.DEPLOY="deploy",e.UNDEPLOY="undeploy"}(t.DeploymentOperation||(t.DeploymentOperation={}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(77)),s=n(8);t.parseYaml=e=>o.default.safeLoad(e),t.parseYamlFile=e=>i(void 0,void 0,void 0,(function*(){return s.readFileContents(e).then(t.parseYaml)})),t.formatYaml=e=>o.default.safeDump(e,{skipInvalid:!0,lineWidth:300,noRefs:!0})},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(21),o=n(2),s=n(1);class r{constructor(e,t){this.durationSeconds=3600,this.credentials=null,this.credentialsRefreshed=0,this.callerIdentity=null,this.getName=()=>`command-role: ${this.commandRole.iamRoleArn}`,this.getCredentials=()=>i(this,void 0,void 0,(function*(){if(this.credentials)return this.credentials;const e={RoleArn:this.commandRole.iamRoleArn,RoleSessionName:"bauble",DurationSeconds:this.durationSeconds};return this.sts.assumeRole(e).promise().then(e=>e.Credentials).then(e=>new a.Credentials(e.AccessKeyId,e.SecretAccessKey,e.SessionToken)).then(e=>(this.credentials=e,this.credentialsRefreshed=Date.now(),e)).catch(e=>{throw new s.BaubleError(`Failed to assume role ${this.commandRole.iamRoleArn}: ${e}`)})})),this.getCallerIdentity=()=>i(this,void 0,void 0,(function*(){return this.callerIdentity?this.callerIdentity:this.getCredentials().then(e=>new a.STS({region:"us-east-1",credentials:e})).then(e=>e.getCallerIdentity({}).promise()).then(e=>(this.callerIdentity={accountId:e.Account,arn:e.Arn,userId:e.UserId},this.callerIdentity))})),this.toString=()=>this.getName(),this.credentialProviderChain=e,this.commandRole=t,this.sts=new a.STS({region:"us-east-1",credentials:null,credentialProvider:e})}}t.CommandRoleCredentialProvider=r;t.DefaultCredentialProvider=class{constructor(e){this.callerIdentity=null,this.getName=()=>"default",this.createCredentialProviderForCommandRole=e=>new r(this.credentialProviderChain,e),this.getCredentials=()=>i(this,void 0,void 0,(function*(){return this.credentialProviderChain.resolvePromise()})),this.getCallerIdentity=()=>i(this,void 0,void 0,(function*(){return this.callerIdentity?this.callerIdentity:this.sts.getCallerIdentity({}).promise().then(e=>(this.callerIdentity={accountId:e.Account,arn:e.Arn,userId:e.UserId},this.callerIdentity))})),this.toString=()=>this.getName(),this.credentialProviderChain=e,this.sts=new a.STS({region:"us-east-1",credentials:null,credentialProvider:e})}},t.initDefaultCredentialProviderChain=()=>i(void 0,void 0,void 0,(function*(){const e=[()=>new a.EnvironmentCredentials("AWS"),()=>new a.EnvironmentCredentials("AMAZON"),()=>new a.ECSCredentials,()=>new a.SharedIniFileCredentials,()=>new a.ProcessCredentials];return(yield o.isAwsMetaEndpointAvailable())&&e.push(()=>new a.EC2MetadataCredentials),new a.CredentialProviderChain(e)}))},function(e,t){e.exports=require("uuid")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.CREATE=0]="CREATE",e[e.UPDATE=1]="UPDATE"}(t.StackLaunchType||(t.StackLaunchType={}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(9)),o=n(20);var s;!function(e){e[e.ADD=0]="ADD",e[e.REMOVE=1]="REMOVE"}(s=t.SecretOperation||(t.SecretOperation={}));class r extends a.default{constructor(){super(...arguments),this.printSecret=(e,t)=>{this.message(`  ${(e=>{switch(e){case s.ADD:return`${o.green("+")} `;case s.REMOVE:return`${o.red("-")} `;default:return""}})(t)}${e.name}`,!0),this.message(`    parameter name: ${e.ssmParameterName}`),this.message(`    description:    ${e.description}`)},this.printSecretsDiff=e=>e.forEach(e=>{0===e.add.length&&0===e.remove.length||(this.message(e.stack.getPath(),!0),e.add.forEach(e=>{this.printSecret(e,s.ADD)}),e.remove.forEach(e=>{this.printSecret(e,s.REMOVE)}))})}}t.default=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultCapabilities=["CAPABILITY_IAM","CAPABILITY_NAMED_IAM","CAPABILITY_AUTO_EXPAND"];t.StackGroup=class{constructor(e){this.getName=()=>this.name,this.getProject=()=>this.project,this.getRegions=()=>[...this.regions],this.getAccountIds=()=>[...this.accountIds],this.getCommandRole=()=>this.commandRole,this.getPath=()=>this.path,this.isRoot=()=>this.root,this.getTemplateBucket=()=>this.templateBucket,this.getChildren=()=>[...this.children],this.getStacks=()=>[...this.stacks],this.getTimeout=()=>this.timeout,this.getTags=()=>new Map(this.tags),this.getHooks=()=>[...this.hooks],this.getData=()=>this.data,this.getCapabilities=()=>this.capabilities,this.toProps=()=>({name:this.getName(),project:this.getProject(),regions:this.getRegions(),accountIds:this.getAccountIds(),commandRole:this.getCommandRole(),path:this.getPath(),isRoot:this.isRoot(),templateBucket:this.getTemplateBucket(),children:this.getChildren(),stacks:this.getStacks(),timeout:this.getTimeout(),tags:this.getTags(),hooks:this.getHooks(),data:this.getData(),capabilities:this.getCapabilities()}),this.name=e.name,this.project=e.project,this.regions=e.regions,this.accountIds=e.accountIds,this.commandRole=e.commandRole,this.path=e.path,this.root=e.isRoot,this.templateBucket=e.templateBucket,this.children=e.children,this.stacks=e.stacks,this.timeout=e.timeout,this.tags=e.tags,this.hooks=e.hooks,this.data=e.data,this.capabilities=e.capabilities}};t.Stack=class{constructor(e){this.getProject=()=>this.project,this.getPath=()=>this.path,this.getName=()=>this.name,this.getTemplate=()=>this.template,this.getTemplateBucket=()=>this.templateBucket,this.getRegion=()=>this.region,this.getAccountIds=()=>[...this.accountIds],this.getCommandRole=()=>this.commandRole,this.getTags=()=>new Map(this.tags),this.getTimeout=()=>this.timeout,this.getParameters=()=>new Map(this.parameters),this.getDependencies=()=>[...this.dependencies],this.getDependants=()=>[...this.dependants],this.getData=()=>this.data,this.getHooks=()=>[...this.hooks],this.getSecrets=()=>new Map(this.secrets),this.getSecretsPath=()=>this.secretsPath,this.getCredentialProvider=()=>this.credentialProvider,this.getCapabilities=()=>this.capabilities,this.toProps=()=>({project:this.getProject(),path:this.getPath(),name:this.getName(),template:this.getTemplate(),templateBucket:this.getTemplateBucket(),region:this.getRegion(),accountIds:this.getAccountIds(),commandRole:this.getCommandRole(),tags:this.getTags(),timeout:this.getTimeout(),parameters:this.getParameters(),dependencies:this.getDependencies(),dependants:this.getDependants(),data:this.getData(),hooks:this.getHooks(),secrets:this.getSecrets(),secretsPath:this.getSecretsPath(),credentialProvider:this.getCredentialProvider(),capabilities:this.getCapabilities()}),this.project=e.project,this.path=e.path,this.name=e.name,this.template=e.template,this.templateBucket=e.templateBucket,this.region=e.region,this.accountIds=e.accountIds,this.commandRole=e.commandRole,this.tags=e.tags,this.timeout=e.timeout,this.parameters=e.parameters,this.dependencies=e.dependencies,this.dependants=e.dependants,this.data=e.data,this.hooks=e.hooks,this.secrets=e.secrets,this.secretsPath=e.secretsPath,this.credentialProvider=e.credentialProvider,this.capabilities=e.capabilities}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(21),s=a(n(94)),r=a(n(95)),c=n(2),u=a(n(26)),l=n(31);class d extends l.AwsClient{constructor(e){super(e),this.getClient=(e,t)=>new o.CloudFormation(Object.assign(Object.assign({},this.clientOptions()),{credentials:e,region:t})),this.validateTemplate=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.validateTemplate(e),()=>!0)})),this.describeStack=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.describeStacks({StackName:e}),e=>e.Stacks[0],t=>{if("ValidationError"===t.code&&t.message===`Stack with id ${e} does not exist`)return null;throw t})})),this.getCurrentTemplate=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.getTemplate({StackName:e}),e=>e.TemplateBody)})),this.initiateStackDeletion=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.deleteStack(e),()=>!0)})),this.createChangeSet=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.createChangeSet(e),e=>e.Id)})),this.deleteChangeSet=(e,t)=>i(this,void 0,void 0,(function*(){const n={StackName:e,ChangeSetName:t};return this.withClientPromise(e=>e.deleteChangeSet(n),()=>!0)})),this.describeChangeSet=(e,t)=>i(this,void 0,void 0,(function*(){const n={ChangeSetName:t,StackName:e};return this.withClientPromise(e=>e.describeChangeSet(n),e=>e)})),this.describeStackEvents=e=>i(this,void 0,void 0,(function*(){return this.withClient(t=>this.pagedOperation(e=>t.describeStackEvents(e),{StackName:e},e=>e.StackEvents))})),this.cancelStackUpdate=e=>i(this,void 0,void 0,(function*(){const t={StackName:e,ClientRequestToken:u.default.v4()};return this.withClientPromise(e=>e.cancelUpdateStack(t),()=>t.ClientRequestToken)})),this.createStack=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.createStack(e),e=>e.StackId)})),this.updateStack=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.updateStack(e),()=>!0,e=>{if("ValidationError"===e.code&&"No updates are to be performed."===e.message)return!1;throw e})})),this.waitUntilStackCreateOrUpdateCompletes=(e,t,n,a,o=null,u=[])=>i(this,void 0,void 0,(function*(){yield c.sleep(3e3);const i=yield this.describeStack(e);if(null===i)throw new Error(`Stack ${e} with name ${e} does not exists`);const l=yield this.describeStackEvents(i.StackId),d=s.default(l,e=>e.EventId!==o).filter(e=>e.ClientRequestToken===t);d.forEach(n);const f=[...u,...d];switch(i.StackStatus){case"CREATE_COMPLETE":case"DELETE_COMPLETE":case"ROLLBACK_COMPLETE":case"UPDATE_COMPLETE":case"ROLLBACK_FAILED":case"CREATE_FAILED":case"DELETE_FAILED":case"UPDATE_ROLLBACK_COMPLETE":case"UPDATE_ROLLBACK_FAILED":return Promise.resolve({events:f,stackStatus:i.StackStatus,timeoutConfig:a});default:const s=r.default(l),c=s?s.EventId:o;if(0!==a.timeout){if(Date.now()-a.startTime>60*a.timeout*1e3){if("UPDATE_IN_PROGRESS"===i.StackStatus){const t=yield this.cancelStackUpdate(e);return this.waitUntilStackCreateOrUpdateCompletes(e,t,n,{timeout:0,timeoutOccurred:!0,startTime:a.startTime},c,f)}console.log(`Timeout exceeded but stack update can't be cancelled because stack status ${i.StackStatus} != UPDATE_IN_PROGRESS`)}}return this.waitUntilStackCreateOrUpdateCompletes(e,t,n,a,c,f)}})),this.waitUntilStackIsDeleted=(e,t,n,a=(()=>{}),o=null,u=[])=>i(this,void 0,void 0,(function*(){yield c.sleep(3e3);const i=yield this.describeStack(t);if(null===i)throw new Error(`Stack ${e} with arn ${t} does not exists`);const l=yield this.describeStackEvents(t),d=s.default(l,e=>e.EventId!==o).filter(e=>e.ClientRequestToken===n);d.forEach(a);const f=[...u,...d];switch(i.StackStatus){case"DELETE_COMPLETE":case"DELETE_FAILED":return Promise.resolve({events:f,stackStatus:i.StackStatus});default:const s=r.default(l),c=s?s.EventId:o;return this.waitUntilStackIsDeleted(e,t,n,a,c,f)}}))}waitUntilChangeSetIsReady(e,t){return i(this,void 0,void 0,(function*(){const n=yield this.describeChangeSet(e,t);switch(n.Status){case"CREATE_COMPLETE":return n;case"DELETE_COMPLETE":throw new Error(`Unexpected change set status: ${n.Status}`);case"CREATE_IN_PROGRESS":case"CREATE_PENDING":return yield c.sleep(1e3),this.waitUntilChangeSetIsReady(e,t);case"FAILED":return null;default:throw new Error(`Unsupported change set status: ${n.Status}`)}}))}}t.CloudFormationClient=d},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(96));t.AwsClient=class{constructor(e){this.clientOptions=()=>({retryDelayOptions:{base:200},maxRetries:7,httpOptions:{agent:new o.default.Agent({keepAlive:!0})},logger:{log:(...e)=>e.forEach(e=>this.logger.trace(e))}}),this.withClient=e=>i(this,void 0,void 0,(function*(){return this.credentialProvider.getCredentials().then(e=>this.getClient(e,this.region)).then(e)})),this.withClientPromise=(e,t,n)=>i(this,void 0,void 0,(function*(){return this.credentialProvider.getCredentials().then(e=>this.getClient(e,this.region)).then(t=>e(t).promise()).then(t).catch(e=>{if(n)return n(e);throw e})})),this.pagedOperation=(e,t,n,a)=>i(this,void 0,void 0,(function*(){const i=yield e(Object.assign(Object.assign({},t),{NextToken:a})).promise(),o=n(i)||[];return i.NextToken?[...o,...yield this.pagedOperation(e,t,n,i.NextToken)]:o})),this.credentialProvider=e.credentialProvider,this.region=e.region,this.logger=e.logger}}},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(4));t.accountName=a.default.string().min(1).max(50),t.accountEmail=a.default.string().email(),t.stackCapability=a.default.string().valid("CAPABILITY_IAM","CAPABILITY_NAMED_IAM","CAPABILITY_AUTO_EXPAND"),t.stackCapabilities=[t.stackCapability,a.default.array().items(t.stackCapability).unique()],t.timeoutInMinutes=a.default.number().integer().min(0),t.timeoutObject=a.default.object({create:t.timeoutInMinutes,update:t.timeoutInMinutes}),t.timeout=[t.timeoutInMinutes,t.timeoutObject],t.templateBucket=a.default.object({name:a.default.string().required(),keyPrefix:a.default.string()}),t.hookName=a.default.string().min(1).max(60).regex(/^[a-zA-Z]+[a-zA-Z0-9-_]*$/),t.hookType=a.default.string().min(1).max(60).regex(/^[a-zA-Z]+[a-zA-Z0-9-_]*$/),t.hookStage=a.default.string().valid("before","after"),t.hookOperation=a.default.string().valid("create","update","delete"),t.hookResult=a.default.string().valid("success","failed","cancelled","skipped");const o=a.default.object({name:t.hookName.required(),type:t.hookType.required(),operation:[t.hookOperation,a.default.array().items(t.hookOperation).unique()],stage:[t.hookStage,a.default.array().items(t.hookStage).unique()],status:[t.hookResult,a.default.array().items(t.hookResult).unique()]}).unknown(!0);t.hooks=a.default.array().items(o),t.tagName=a.default.string().min(1).max(127),t.tagValue=a.default.string().min(1).max(255),t.tags=a.default.object().pattern(t.tagName,t.tagValue),t.template=a.default.string().min(1),t.parameterName=a.default.string().min(1).max(255).regex(/^[a-zA-Z0-9]+$/),t.staticStringParameterValue=a.default.string().required(),t.staticNumberParameterValue=a.default.number().required(),t.staticBooleanParameterValue=a.default.boolean().required(),t.resolverParameterValue=a.default.object({resolver:a.default.string().required().min(1).max(60).regex(/^[a-zA-Z]+[a-zA-Z0-9-_]*$/),confidential:a.default.boolean()}).unknown(!0),t.listParameterValue=a.default.array().items(t.staticStringParameterValue.optional(),t.staticNumberParameterValue.optional(),t.staticBooleanParameterValue.optional(),t.resolverParameterValue.optional()),t.parameters=a.default.object().pattern(t.parameterName,[t.staticStringParameterValue,t.staticNumberParameterValue,t.staticBooleanParameterValue,t.resolverParameterValue,t.listParameterValue]),t.secretName=a.default.string().min(1).max(255).regex(/^[a-zA-Z0-9-_]+$/),t.secretDescription=a.default.string().min(1).max(255),t.secret=a.default.object({description:t.secretDescription.required()}).unknown(!1),t.secrets=a.default.object().pattern(t.secretName,t.secret)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.ACTIVE="active",e.DISABLED="disabled",e.SUSPENDED="suspended"}(t.OrganizationAccountStatus||(t.OrganizationAccountStatus={})),function(e){e.ACTIVE="active",e.DISABLED="disabled"}(t.OrganizationalUnitStatus||(t.OrganizationalUnitStatus={}))},function(e,t){e.exports=require("lodash.merge")},function(e,t){e.exports=require("util")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(83);t.launchStacksCommand=i.launchStacksCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1);t.validate=(e,t,n)=>{const{error:i}=e.validate(t,{abortEarly:!1,errors:{label:!1}});if(i){const e=i.details.map(e=>`  - ${e.message}`).join("\n");throw new a.BaubleError(`${n}:\n\n${e}`)}},t.validateStackCredentialProvidersWithAllowedAccountIds=e=>i(void 0,void 0,void 0,(function*(){(yield Promise.all(e.map(e=>i(void 0,void 0,void 0,(function*(){const t=yield e.getCredentialProvider().getCallerIdentity();return{stack:e,identity:t}}))))).forEach(({stack:e,identity:t})=>{if(e.getAccountIds().length>0&&!e.getAccountIds().includes(t.accountId)){const n=e.getAccountIds().map(e=>`- ${e}`).join("\n");throw new a.BaubleError(`Credentials associated with the stack ${e.getPath()} point to an AWS account with id ${t.accountId} which is not allowed in stack configuration.\n\nList of allowed account ids:\n\n${n}`)}})}))},function(e,t){e.exports=require("readdirp")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1);t.parseVars=e=>e||{},t.parseCommandRole=e=>null==e?null:{iamRoleArn:e},t.parseRegex=(e,t)=>{try{return t?new RegExp(t):null}catch(n){throw new i.BaubleError(`Invalid regex pattern ${t} provided in ${e}`)}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(27),o=n(0),s=n(115),r=n(41);t.isStackDeletedSuccessfully=e=>"DELETE_COMPLETE"===e,t.waitForDependenciesToComplete=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,dependencies:n,watch:i,logger:a}=e,r=i.startChild("wait-dependencies");a.debug(`Wait ${n.length} dependencies to complete`);try{return void 0===(yield Promise.all(n)).find(e=>!e.success)?(r.stop(),a.debug("Dependencies completed successfully"),s.describeExistingCloudFormationStack(e)):(a.debug("Some dependencies failed"),{stack:t,message:"Dependencies failed",reason:"DEPENDENCIES_FAILED",status:o.CommandStatus.CANCELLED,events:[],success:!1,watch:i.stop()})}catch(e){return a.error("An error occurred while waiting dependencies to complete",e),{stack:t,message:e.message,reason:"DEPENDENCIES_FAILED",status:o.CommandStatus.FAILED,events:[],success:!1,watch:i.stop()}}})),t.waitStackDeletionToComplete=e=>i(void 0,void 0,void 0,(function*(){const{stack:n,current:i,cloudFormationClient:s,io:c,watch:u,clientToken:l,logger:d}=e;d.debug("Wait for delete to complete");const f=u.startChild("wait-stack-deletion");try{const{events:h,stackStatus:m}=yield s.waitUntilStackIsDeleted(n.getName(),i.stackId,l,e=>c.printStackEvent(n.getPath(),e));return t.isStackDeletedSuccessfully(m)?(f.stop(),d.debug("Stack deleted successfully"),yield r.executeBeforeLaunchHooks(Object.assign(Object.assign({},e),{launchType:a.StackLaunchType.CREATE}))):(d.debug("Failed to delete stack"),{stack:n,message:"Stack deletion failed",reason:"DELETE_STACK_FAILED",status:o.CommandStatus.FAILED,events:h,success:!1,watch:u.stop()})}catch(e){return d.error("Failed to delete stack",e),{stack:n,message:"Stack deletion failed",reason:"DELETE_STACK_FAILED",status:o.CommandStatus.FAILED,events:[],success:!1,watch:u.stop()}}})),t.waitForStackCreateOrUpdateToComplete=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,cloudFormationClient:n,clientToken:i,launchType:s,io:c,watch:u,logger:l}=e,d=u.startChild("wait-update-completion");l.debug("Wait for stack launch to complete");const f=s===a.StackLaunchType.UPDATE?t.getTimeout().update:0;try{const{stackStatus:h,events:m}=yield n.waitUntilStackCreateOrUpdateCompletes(t.getName(),i,e=>c.printStackEvent(t.getPath(),e),{timeout:f,startTime:Date.now(),timeoutOccurred:!1});l.info(`Stack launch completed with status: ${h}`),d.stop();const p="UPDATE_COMPLETE"===h||"CREATE_COMPLETE"===h,g=p?"Success":"Failure",v=p?o.CommandStatus.SUCCESS:o.CommandStatus.FAILED,y=(e=>s===a.StackLaunchType.UPDATE&&e?"UPDATE_SUCCESS":s!==a.StackLaunchType.UPDATE||e?s===a.StackLaunchType.CREATE&&e?"CREATE_SUCCESS":"CREATE_FAILED":"UPDATE_FAILED")(p),C={stack:t,message:g,reason:y,status:v,events:m,success:p,watch:u.stop()};return r.executeAfterLaunchHooks(Object.assign(Object.assign({},e),{result:C}))}catch(e){return l.error("Failed to wait for stack launch to complete",e),{stack:t,message:e.message,reason:"ERROR",status:o.CommandStatus.FAILED,events:[],success:!1,watch:u.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(27),s=n(59),r=n(117),c=e=>{switch(e){case o.StackLaunchType.CREATE:return"create";case o.StackLaunchType.UPDATE:return"update";default:throw new Error(`Unsupported launch type: ${e}`)}};t.executeBeforeLaunchHooks=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,watch:n,launchType:i,ctx:o,variables:u,logger:l}=e,d=n.startChild("before-hooks");l.debug("Execute before launch hooks");const{success:f,message:h}=yield s.executeHooks(o,u,t.getHooks(),c(i),"before",l);return f?(d.stop(),l.debug("Execute before launch hooks completed"),r.prepareCloudFormationTemplate(e)):(l.error(`Before launch hooks failed with message: ${h}`),{stack:t,message:h,status:a.CommandStatus.FAILED,reason:"BEFORE_HOOKS_FAILED",events:[],success:!1,watch:n.stop()})})),t.executeAfterLaunchHooks=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,watch:n,launchType:i,result:o,ctx:r,variables:u,logger:l}=e,d=n.startChild("after-hooks");l.debug("Execute after launch hooks");const{success:f,message:h}=yield s.executeHooks(r,u,t.getHooks(),c(i),"after",l,(e=>{switch(e){case a.CommandStatus.CANCELLED:return"cancelled";case a.CommandStatus.SKIPPED:return"skipped";case a.CommandStatus.SUCCESS:return"success";case a.CommandStatus.FAILED:return"failed";default:throw new Error(`Unsupported command status: ${e}`)}})(o.status));return d.stop(),f?(l.debug("Execute after launch hooks completed"),Object.assign(Object.assign({},o),{watch:n.stop()})):(l.error(`After launch hooks failed with message: ${h}`),Object.assign(Object.assign({},o),{message:h,status:a.CommandStatus.FAILED,reason:"AFTER_HOOKS_FAILED",success:!1,watch:n.stop()}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(11)),s=a(n(9)),r=n(6),c=n(124),u=a(n(19)),l=n(14),d=n(20);class f extends s.default{constructor(e,t=null){super(e,t),this.confirmLaunch=e=>i(this,void 0,void 0,(function*(){if(this.autoConfirm)return r.ConfirmResult.YES;const t=yield e.getDefaultCredentialProvider().getCallerIdentity();this.debugObject("Default credentials:",t),this.message("Stacks to launch:",!0);for(const t of e.getStacks()){const n=yield t.getCredentialProvider().getCallerIdentity();this.longMessage([`  ${t.getPath()}`,`    name:          ${t.getName()}`,`    account id:    ${n.accountId}`,`    region:        ${t.getRegion()}`,"    credentials:",`      user id:     ${n.userId}`,`      account id:  ${n.accountId}`,`      arn:         ${n.arn}`],!0),t.getDependencies().length>0?(this.message("    dependencies:"),this.printStackDependencies(t,e,1)):this.message("    dependencies: []")}return(yield this.confirm("Continue to launch the above stacks?",!0))?r.ConfirmResult.YES:r.ConfirmResult.NO})),this.confirmDeleteOfFailedStack=e=>i(this,void 0,void 0,(function*(){return this.autoConfirm?r.ConfirmResult.YES:(this.message(`The previous attempt to create stack ${e.getName()} failed. The stack must be removed before it can be created`,!0,!0),(yield this.confirm(`Remove stack ${e.getName()}?`))?r.ConfirmResult.YES:r.ConfirmResult.NO)})),this.printOutput=e=>{const t=e.results.filter(e=>e.success),n=e.results.filter(e=>!e.success),i=[...t,...n],a=new o.default;return i.forEach(e=>{a.cell("Stack path",e.stack.getPath()),a.cell("Stack name",e.stack.getName()),a.cell("Status",l.formatCommandStatus(e.status)),a.cell("Reason",e.reason),a.cell("Time",u.default(e.watch.secondsElapsed)),a.cell("Message",e.message),a.newRow()}),this.message(a.toString(),!0),n.length>0&&(this.message("Events for failed stacks",!0),this.message("------------------------"),n.forEach(e=>{if(this.message(e.stack.getPath(),!0,!0),0===e.events.length)this.message("  <No events>");else{const t=e=>this.message("  "+l.formatStackEvent(e));e.events.forEach(t)}})),e},this.printChangeSet=(e,t)=>{const n=t.Changes||[],i=new Map([["Add",0],["Modify",0],["Remove",0]]);this.message(`Changes to stack: ${e}`,!0),n.forEach(e=>{const{LogicalResourceId:t,Action:n,Replacement:a,Scope:o,PhysicalResourceId:s,ResourceType:r,Details:c}=e.ResourceChange;i.set(n,i.get(n)+1),this.message(l.formatResourceChange(n,a,t),!0),this.message(`      type:                      ${r}`),this.message(`      physical id:               ${s}`),this.message(`      replacement:               ${a}`),this.message(`      scope:                     ${o}`),this.message("      details:"),(c||[]).forEach(e=>{this.message(`        - causing entity:        ${e.CausingEntity}`),this.message(`          evaluation:            ${e.Evaluation}`),this.message(`          change source:         ${e.ChangeSource}`),this.message("          target:"),this.message(`            attribute:           ${e.Target.Attribute}`),this.message(`            name:                ${e.Target.Name}`),this.message(`            require recreation:  ${e.Target.RequiresRecreation}`)})});const a=i.get("Add").toString(),o=i.get("Modify").toString(),s=i.get("Remove").toString();this.message(`Add: ${d.green(a)}, Modify: ${d.yellow(o)}, Remove: ${d.red(s)}`,!0,!0)},this.confirmStackLaunch=(e,t,n,a)=>i(this,void 0,void 0,(function*(){if(this.autoConfirm)return r.ConfirmResult.YES;this.printChangeSet(e.getPath(),t);const i=yield this.choose("Launch stack?",[{name:"yes",value:"y"},{name:"no",value:"n"},{name:"view template diff",value:"d"},{name:"yes to all",value:"a"}],!0);if("d"===i){const t=yield a.getCurrentTemplate(e.getName()),i=c.diffLines(t,n).map(e=>e.added?d.green(e.value):e.removed?d.red(e.value):e.value).join("");return this.message(i,!0,!0),(yield this.confirm("Launch stack"))?r.ConfirmResult.YES:r.ConfirmResult.NO}return"a"===i?(this.autoConfirm=!0,r.ConfirmResult.YES):"y"===i?r.ConfirmResult.YES:r.ConfirmResult.NO})),this.printStackEvent=(e,t)=>this.info(e+" - "+l.formatStackEvent(t)),this.printStackDependencies=(e,t,n)=>{e.getDependencies().forEach((i,a)=>{const[o]=t.getStacksByPath(i),s=a<e.getDependencies().length-1?"├":"└",r=`    ${"  ".repeat(n)}${s}── ${o.getPath()}`;this.message(d.grey(r)),this.printStackDependencies(o,t,n+2)})},this.autoConfirm=e.isAutoConfirmEnabled()}}t.default=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(126);t.deleteStacksCommand=i.deleteStacksCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(30),s=n(128),r=a(n(26)),c=n(0),u=n(18),l=n(129);t.deleteStack=(e,t,n,a,r)=>i(void 0,void 0,void 0,(function*(){const i=n.childLogger(a.getPath());i.debugObject("Stack config:",a);const c=new o.CloudFormationClient({region:a.getRegion(),credentialProvider:a.getCredentialProvider(),logger:i}),u={ctx:t,stack:a,dependants:r,cloudFormationClient:c,io:n,logger:i,watch:e.startChild(a.getPath()),variables:t.getVariables()};return s.waitForDependantsToComplete(u)})),t.initiateCloudFormationStackDeletion=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,current:n,cloudFormationClient:i,watch:a,logger:o}=e,u=a.startChild("initiate-stack-deletion"),l=r.default.v4();try{o.debug(`Initiate stack deletion with client token ${l}`),yield i.initiateStackDeletion({StackName:n.stackId,ClientRequestToken:l})}catch(e){return o.error("An error occurred while initiating stack deletion",e),{stack:t,message:"Initiate stack deletion failed",reason:"INITIATE_DELETE_STACK_FAILED",status:c.CommandStatus.FAILED,events:[],success:!1,watch:a.stop()}}return o.debug("Stack delete initiated successfully"),u.stop(),yield s.waitCloudFormationStackDeletionToComplete(Object.assign(Object.assign({},e),{clientToken:l}))})),t.deleteSecrets=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,watch:n,logger:i}=e,a=n.startChild("delete-secrets");i.debug("Delete secrets");try{const e=new u.SSMClient({credentialProvider:t.getCredentialProvider(),region:t.getRegion(),logger:i}),n=yield e.getEncryptedParametersByPath(t.getSecretsPath());if(i.debug(`Found ${n.length} secret(s)`),n.length>0){const t=n.map(e=>e.Name);i.debugObject("Delete following SSM parameter(s) used to store secrets:",t),yield e.deleteParameters(t),i.debug("SSM parameter(s) deleted")}}catch(e){return i.error("An error occurred while deleting secrets",e),{stack:t,message:e.message,reason:"DELETE_SECRETS_FAILED",status:c.CommandStatus.FAILED,events:[],success:!1,watch:n.stop()}}return a.stop(),l.describeExistingCloudFormationStack(e)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(11)),s=a(n(9)),r=n(6),c=n(14),u=a(n(19)),l=n(20);class d extends s.default{constructor(e,t=null){super(e,t),this.confirmDelete=e=>i(this,void 0,void 0,(function*(){if(this.options.isAutoConfirmEnabled())return r.ConfirmResult.YES;const t=yield e.getDefaultCredentialProvider().getCallerIdentity();this.debugObject("Default credentials:",t),this.message("Stacks to delete:",!0);for(const t of e.getStacks()){const n=yield t.getCredentialProvider().getCallerIdentity();this.longMessage([`  ${t.getPath()}`,`    name:          ${t.getName()}`,`    account id:    ${n.accountId}`,`    region:        ${t.getRegion()}`,"    credentials:",`      user id:     ${n.userId}`,`      account id:  ${n.accountId}`,`      arn:         ${n.arn}`],!0),t.getDependants().length>0?(this.message("    dependants:"),this.printStackDependants(t,e,1)):this.message("    dependants: []")}return(yield this.confirm("Continue to delete the above stacks?",!0))?r.ConfirmResult.YES:r.ConfirmResult.NO})),this.printStackEvent=(e,t)=>this.info(e+" - "+c.formatStackEvent(t)),this.printOutput=e=>{const t=e.results.filter(e=>e.success),n=e.results.filter(e=>!e.success),i=[...t,...n],a=new o.default;return i.forEach(e=>{a.cell("Stack path",e.stack.getPath()),a.cell("Stack name",e.stack.getName()),a.cell("Status",c.formatCommandStatus(e.status)),a.cell("Reason",e.reason),a.cell("Time",u.default(e.watch.secondsElapsed)),a.cell("Message",e.message),a.newRow()}),this.message(a.toString(),!0),n.length>0&&(this.message("Events for failed stacks",!0),this.message("------------------------"),n.forEach(e=>{if(this.message(e.stack.getPath(),!0,!0),0===e.events.length)this.message("  <No events>");else{const t=e=>this.message("  "+c.formatStackEvent(e));e.events.forEach(t)}})),e},this.printStackDependants=(e,t,n)=>{e.getDependants().forEach((i,a)=>{const[o]=t.getStacksByPath(i),s=a<e.getDependants().length-1?"├":"└",r=`    ${"  ".repeat(n)}${s}── ${o.getPath()}`;this.message(l.grey(r)),this.printStackDependants(o,t,n+2)})}}}t.default=d},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(33),s=n(1),r=a(n(10)),c=n(163),u=n(12),l=e=>e?e.map(e=>e.name):[];t.validateOrganizationConfigFile=(e,t,n)=>{const{serviceControlPolicies:i,tagPolicies:a,configSets:o,organizationalUnits:{Root:r}}=e;if(e.masterAccountId!==t.accountId)throw new s.BaubleError(`Current credentials refer to an account ${t.accountId} which does not match with the master account id ${e.masterAccountId} defined in the organization configuration file`);if("ALL"!==n.FeatureSet){if(e.serviceControlPolicies.enabled)throw new s.BaubleError("Local configuration must not contain 'serviceControlPolicies' configuration when the organization does not have all features enabled");if(e.tagPolicies.enabled)throw new s.BaubleError("Local configuration must not contain 'tagPolicies' configuration when the organization does not have all features enabled");if(e.trustedAwsServices)throw new s.BaubleError("Local configuration must not contain 'trustedAwsServices' configuration when the organization does not have all features enabled")}if("ALL"===n.FeatureSet&&i.enabled){if(0===i.policies.length)throw new s.BaubleError("Local configuration must contain at least one service control policy when the organization has service control policies enabled",{instructions:["Add at least one service control policy to 'policies.serviceControlPolicy'"]});if(0===r.serviceControlPolicies.length)throw new s.BaubleError("Root organizational unit must have at least one service control policy attached when the organization has service control policies enabled")}const c=l(i.policies),d=l(a.policies),f=(e=>e.map(e=>e.name))(o),h=e=>{e.serviceControlPolicies.forEach(t=>{if(!c.includes(t))throw new s.BaubleError(`Organizational unit '${e.path}' refers to a non-existing service control policy '${t}'`)}),e.tagPolicies.forEach(t=>{if(!d.includes(t))throw new s.BaubleError(`Organizational unit '${e.path}' refers to a non-existing tag policy '${t}'`)}),e.configSets.forEach(t=>{if(!f.includes(t))throw new s.BaubleError(`Organizational unit '${e.path}' refers to a non-existing config set '${t}'`)}),e.children.forEach(h)},m=u.collectFromHierarchy(r,e=>e.children);m.forEach(h),m.reduce((e,t)=>{const n=t.accounts.map(e=>e.id);return n.forEach(t=>{if(e.includes(t))throw new s.BaubleError(`Account ${t} is defined more than once`)}),[...e,...n]},new Array)},t.validateCommonLocalConfiguration=(e,t)=>i(void 0,void 0,void 0,(function*(){const n=r.default(u.collectFromHierarchy(e.getOrganizationalUnit("Root"),e=>e.children).map(e=>e.accounts)),i=n.map(e=>e.id),a=t.map(e=>e.Id),l=i.filter(e=>!a.includes(e));if(l.length>0)throw new c.NonExistingAccountsInLocalConfigError(l);const d=t.filter(e=>"SUSPENDED"===e.Status).map(e=>e.Id),f=n.filter(e=>d.includes(e.id)&&e.status!==o.OrganizationAccountStatus.SUSPENDED).map(e=>e.id);if(f.length>0)throw new c.SuspendedAccountsInLocalConfigError(f);const h=t.filter(e=>!i.includes(e.Id));if(h.length>0)throw new c.AccountsMissingFromLocalConfigError(h);const m=new Map(t.map(e=>[e.Id,e]));n.forEach(e=>{const t=m.get(e.id);if(e.email&&e.email!==t.Email)throw new s.BaubleError(`Account email '${e.email}' configured in local config does not match with the current email '${t.Email}' for account ${e.id}`);if(e.name&&e.name!==t.Name)throw new s.BaubleError(`Account name '${e.name}' configured in local config does not match with the current name '${t.Name}' for account ${e.id}`)})}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(4)),o=n(7),s=n(3);t.organizationRoleName=a.default.string().min(1).max(64).regex(/^[\w+=/,.@-]+$/);const r=a.default.object({iamUserAccessToBilling:a.default.boolean(),roleName:t.organizationRoleName}),c=a.default.object({namePattern:a.default.string(),emailPattern:a.default.string()});t.accountCreation=a.default.object({defaults:r,constraints:c});const u=a.default.string().valid("active","disabled","suspended"),l=a.default.string().min(1).max(128).regex(/^[a-zA-Z0-9_-]+$/).required(),d=a.default.object({description:a.default.string().min(1).max(512).required(),awsManaged:a.default.boolean()}),f=a.default.object({id:o.accountId.required(),name:a.default.string(),email:a.default.string().email(),accountAdminRoleName:t.organizationRoleName,configSets:[a.default.array().items(o.configSetName).unique(),o.configSetName],serviceControlPolicies:[l,a.default.array().items(l).unique()],tagPolicies:[l,a.default.array().items(l).unique()],status:u,description:a.default.string(),vars:o.vars});t.organizationalUnitName=a.default.string().min(1).max(128).regex(/^[a-zA-Z0-9-_ ]+$/).custom((e,t)=>{const n=`${e}`;return n.startsWith(" ")?t.error("startsWithWhitespace"):n.endsWith(" ")?t.error("endsWithWhitespace"):n.includes("  ")?t.error("subsequentWhitespace"):e}).messages({startsWithWhitespace:'"{{#label}}" must not start with whitespace',endsWithWhitespace:'"{{#label}}" must not end with whitespace',subsequentWhitespace:'"{{#label}}" must not contain subsequent whitespace'}),t.organizationalUnitPath=a.default.string().min(1).max(644).custom((e,t)=>{const n=/^Root(\/[a-zA-Z0-9-_/ ]+)?$/;return n.test(e)?e.endsWith(" ")?t.error("endsWithWhitespace"):e.includes("  ")?t.error("subsequentWhitespace"):e.includes("//")?t.error("subsequentSeparators"):e.endsWith("/")?t.error("endsWithSeparator"):e.split("/").length>5?t.error("maxDepth"):e:t.error("string.pattern.base",{regex:n})}).messages({maxDepth:'"{{#label}}" hierarchy depth must not exceed 5',endsWithWhitespace:'"{{#label}}" must not end with whitespace',endsWithSeparator:'"{{#label}}" must not end with path separator (/)',subsequentSeparators:'"{{#label}}" must not contain subsequent path separators (/)',subsequentWhitespace:'"{{#label}}" must not contain subsequent whitespace'});const h=a.default.object({vars:o.vars,accountAdminRoleName:t.organizationRoleName,status:a.default.string().valid("active","disabled"),priority:a.default.number().integer().min(0),configSets:[a.default.array().items(o.configSetName).unique(),o.configSetName],accounts:a.default.array().items(f,o.accountId),serviceControlPolicies:[l,a.default.array().items(l).unique()],tagPolicies:[l,a.default.array().items(l).unique()]});t.policies=a.default.object().pattern(l,d),t.organizationalUnits=a.default.object().pattern(t.organizationalUnitPath,h,{matches:a.default.array().has(a.default.string().valid("Root"))}),t.configSets=a.default.object().pattern(o.configSetName,o.configSet),t.trustedAwsServices=a.default.array().items(a.default.string().valid(...s.ORGANIZATION_SERVICE_PRINCIPALS)).unique(),t.organizationConfigFileSchema=a.default.object({vars:o.vars,accountCreation:t.accountCreation,serviceControlPolicies:[t.policies,a.default.boolean()],tagPolicies:[t.policies,a.default.boolean()],organizationalUnits:t.organizationalUnits.required(),configSets:t.configSets,trustedAwsServices:t.trustedAwsServices,organizationAdminRoleName:t.organizationRoleName,accountAdminRoleName:t.organizationRoleName,masterAccountId:o.accountId.required()})},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(10)),o=n(12),s=n(2);!function(e){e[e.ACTIVE=0]="ACTIVE",e[e.DISABLED=1]="DISABLED"}(t.DeploymentStatus||(t.DeploymentStatus={}));t.DeploymentTargetsContext=class{constructor(e){this.getConfigFile=()=>this.configFile,this.getRootDeploymentGroups=()=>[...this.rootDeploymentGroups],this.getOptions=()=>this.options,this.getLogger=()=>this.logger,this.getVariables=()=>s.deepCopy(this.variables),this.getDefaultCredentialProvider=()=>this.defaultCredentialProvider,this.getDeploymentGroup=e=>{const t=this.deploymentGroups.find(t=>t.path===e);if(!t)throw new Error(`No such deployment group: '${e}'`);return t},this.hasDeploymentGroup=e=>void 0!==this.deploymentGroups.find(t=>t.path===e),this.getConfigSet=e=>{const t=this.configFile.configSets.find(t=>t.name===e);if(!t)throw new Error(`No such config set: ${e}`);return t},this.defaultCredentialProvider=e.defaultCredentialProvider,this.logger=e.logger,this.options=e.options,this.variables=e.variables,this.configFile=e.configFile,this.rootDeploymentGroups=e.configFile.deploymentGroups,this.deploymentGroups=a.default(this.rootDeploymentGroups.map(e=>o.collectFromHierarchy(e,e=>e.children)))}}},function(e,t){e.exports=require("lodash.uniqby")},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(51)),o=n(2),s=n(24);var r;!function(e){e.TRACE="trace",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error"}(r=t.LogLevel||(t.LogLevel={}));const c=e=>e,u=e=>{switch(e){case r.TRACE:return 0;case r.DEBUG:return 1;case r.INFO:return 2;case r.WARN:return 3;case r.ERROR:return 4;default:throw new Error(`Unknown log level: ${e}`)}};class l{constructor(e=r.INFO,t=null){this.logLevel=e,this.logLevelNumber=u(e),this.name=t}meta(e){return a.default.format(new Date,"YYYY-MM-DD HH:mm:ss Z")+" "+(e=>{switch(e){case r.TRACE:return"[trace]";case r.DEBUG:return"[debug]";case r.INFO:return"[info ]";case r.WARN:return"[warn ]";case r.ERROR:return"[error]";default:throw new Error(`Unknown log level: ${e}`)}})(e)+(this.name?` - ${this.name}`:"")}log(e,...t){this.logLevelNumber<=u(e)&&console.log(`${this.meta(e)} -`,...t)}logObject(e,t,n,i){if(this.logLevelNumber<=u(e)){const a=i(n);console.log(`${this.meta(e)} - ${t}\n\n${o.indentLines(s.formatYaml(a))}`)}}logText(e,t,n){this.logLevelNumber<=u(e)&&(""===n?console.log(`${this.meta(e)} - ${t} <empty>`):console.log(`${this.meta(e)} - ${t}\n\n${o.indentLines(n)}`))}trace(...e){this.log(r.TRACE,...e)}traceObject(e,t,n=c){this.logObject(r.TRACE,e,t,n)}traceText(e,t){this.logText(r.TRACE,e,t)}debug(...e){this.log(r.DEBUG,...e)}debugObject(e,t,n=c){this.logObject(r.DEBUG,e,t,n)}debugText(e,t){this.logText(r.DEBUG,e,t)}info(...e){this.log(r.INFO,...e)}infoText(e,t){this.logText(r.INFO,e,t)}infoObject(e,t,n=c){this.logObject(r.INFO,e,t,n)}warn(...e){this.log(r.WARN,...e)}warnObject(e,t,n=c){this.logObject(r.WARN,e,t,n)}warnText(e,t){this.logText(r.WARN,e,t)}error(...e){this.log(r.ERROR,...e)}childLogger(e){const t=this.name?`${this.name} - ${e}`:e;return new l(this.logLevel,t)}}t.ConsoleLogger=l},function(e,t){e.exports=require("date-and-time")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(2);t.StdCommandContext=class{constructor(e){this.getStacks=()=>[...this.stacks],this.getLogger=()=>this.logger,this.getOptions=()=>this.options,this.getVariables=()=>i.deepCopy(this.variables),this.getTemplateEngine=()=>this.templateEngine,this.getDefaultCredentialProvider=()=>this.defaultCredentialProvider,this.getStacksByPath=e=>Array.from(this.stacksMap.values()).filter(t=>t.getPath().startsWith(e)),this.defaultCredentialProvider=e.defaultCredentialProvider,this.options=e.options,this.stacks=e.stacks,this.logger=e.logger,this.variables=e.variables,this.templateEngine=e.templateEngine,this.stacksMap=new Map(e.stacks.map(e=>[e.getPath(),e]))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isStackGroupPath=e=>!e.includes(".yml")},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1),o=i(n(16)),s=i(n(10)),r=n(29);t.checkCyclicDependenciesForStack=(e,n,i)=>{0!==e.getDependencies().length&&e.getDependencies().forEach(e=>{if(i.includes(e))throw new a.BaubleError(`Cyclic dependency detected: ${i.join(" -> ")} -> ${e}`);t.checkCyclicDependenciesForStack(n.get(e),n,[...i,e])})},t.checkCyclicDependencies=e=>{e.forEach(n=>t.checkCyclicDependenciesForStack(n,e,[n.getPath()]))},t.collectAllDependants=(e,n)=>{const i=n.find(t=>t.getPath()===e);return o.default(i.getDependants().reduce((e,i)=>[...e,...t.collectAllDependants(i,n),i],new Array))},t.collectStackDirectDependants=(e,t)=>t.filter(t=>t.path!==e).reduce((t,n)=>n.dependencies.includes(e)?[...t,n.path]:t,new Array),t.populateDependants=e=>e.reduce((n,i)=>{const a=t.collectStackDirectDependants(i.path,e);return[...n,Object.assign(Object.assign({},i),{dependants:a})]},new Array),t.processStackDependencies=e=>{const n=e.map(e=>e.toProps()).map(t=>{const n=t.dependencies.map(n=>{const i=e.filter(e=>e.getPath().startsWith(n)).map(e=>e.getPath());if(0===i.length)throw new a.BaubleError(`Dependency ${n} in stack ${t.path} refers to a non-existing stack`);return i}),i=Array.from(t.parameters.entries()).reduce((n,[i,o])=>{const r=o.getDependencies().map(n=>{const o=e.filter(e=>e.getPath().startsWith(n)).map(e=>e.getPath());if(0===o.length)throw new a.BaubleError(`Dependency ${n} in parameter ${i} of stack ${t.path} refers to a non-existing stack`);return o});return[...n,...s.default(r)]},new Array);return Object.assign(Object.assign({},t),{dependencies:o.default(s.default([...n,...i]))})});return t.populateDependants(n).map(e=>new r.Stack(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ConfigContext=class{constructor(e){this.getStackGroupConfig=e=>this.stackGroups.get(e),this.getStackByExactPath=e=>{const t=this.stackConfigsByPath.get(e);if(!t)throw new Error(`No stack config found with path: ${e}`);return t},this.getStacksByPath=e=>Array.from(this.stackConfigsByPath.values()).filter(t=>t.getPath().startsWith(e)),this.options=e.options,this.variables=e.variables,this.defaultCredentialProvider=e.defaultCredentialProvider,this.rootStackGroup=e.rootStackGroup,this.stackGroups=e.stackGroups,this.stackConfigsByPath=e.stackConfigsByPath,this.logger=e.logger,this.templateEngine=e.templateEngine}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(92);t.CmdResolver=i.CmdResolver;var a=n(93);t.ExternalStackOutputResolver=a.ExternalStackOutputResolver;var o=n(97);t.ListResolver=o.ListResolver;var s=n(98);t.SecretResolver=s.SecretResolver;var r=n(99);t.StackOutputResolver=r.StackOutputResolver;var c=n(100);t.StaticResolver=c.StaticResolver},function(e,t){e.exports=require("child_process")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(41),o=n(119),s=n(0),r=n(120);t.hasPreviousStackCreateFailed=e=>["CREATE_FAILED","ROLLBACK_COMPLETE"].includes(e),t.isStackReadyForLaunch=e=>["CREATE_COMPLETE","UPDATE_COMPLETE","UPDATE_ROLLBACK_COMPLETE","REVIEW_IN_PROGRESS"].includes(e),t.validateCloudFormationStackStatus=e=>i(void 0,void 0,void 0,(function*(){const{stack:n,current:i,watch:r,logger:c}=e;return c.debug("Validate stack status"),t.isStackReadyForLaunch(i.status)?(c.debug(`Stack status ${i.status} is valid`),yield a.executeBeforeLaunchHooks(e)):t.hasPreviousStackCreateFailed(i.status)?(c.debug("Previous stack create has failed"),yield o.initiateFailedCloudFormationStackDeletion(e)):(c.warn(`Stack status ${i.status} is not valid`),{stack:n,message:`Stack status '${i.status}' does not allow launch`,reason:"CHECK_STACK_STATUS_FAILED",status:s.CommandStatus.FAILED,events:[],success:!1,watch:r.stop()})})),t.validateTemplate=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,templateS3Url:n,templateBody:i,cloudFormationClient:a,io:o,watch:c}=e,u=c.startChild("validate-template");o.debug(`${t.getPath()} - Validate template`);const l=n||i,d=n?"TemplateURL":"TemplateBody";try{return yield a.validateTemplate({[d]:l}),u.stop(),r.prepareParameters(e)}catch(e){return o.error(`${t.getPath()} - Failed to validate template`,e),{stack:t,message:e.message,reason:"TEMPLATE_VALIDATION_FAILED",status:s.CommandStatus.FAILED,events:[],success:!1,watch:c.stop()}}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(116);t.executeHooks=i.executeHooks},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(27),s=a(n(26)),r=n(29),c=n(0),u=n(40);t.createOrUpdateStack=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,launchType:n,cloudFormationClient:i,parameters:a,tags:l,templateS3Url:d,templateBody:f,watch:h,logger:m}=e,p=s.default.v4(),g=d||f,v=d?"TemplateURL":"TemplateBody",y=t.getCapabilities()||r.defaultCapabilities;switch(n){case o.StackLaunchType.UPDATE:m.info("Update stack");const s=h.startChild("update-stack");try{if(!(yield i.updateStack({Capabilities:y,ClientRequestToken:p,Parameters:a,Tags:l,StackName:t.getName(),[v]:g})))return m.info("No changes"),{stack:t,message:"No changes",reason:"SKIPPED",status:c.CommandStatus.SKIPPED,events:[],success:!0,watch:h.stop()}}catch(e){return m.error("Failed to update stack",e),{stack:t,message:e.message,reason:"UPDATE_FAILED",status:c.CommandStatus.FAILED,events:[],success:!1,watch:h.stop()}}return s.stop(),u.waitForStackCreateOrUpdateToComplete(Object.assign(Object.assign({},e),{clientToken:p}));case o.StackLaunchType.CREATE:m.info("Create stack");const r=h.startChild("create-stack");try{yield i.createStack({Capabilities:y,ClientRequestToken:p,DisableRollback:!1,EnableTerminationProtection:!1,Parameters:a,Tags:l,StackName:t.getName(),TimeoutInMinutes:t.getTimeout().create||void 0,[v]:g})}catch(e){return m.error("Failed to create stack",e),{stack:t,message:e.message,reason:"CREATE_FAILED",status:c.CommandStatus.FAILED,events:[],success:!1,watch:h.stop()}}return r.stop(),yield u.waitForStackCreateOrUpdateToComplete(Object.assign(Object.assign({},e),{clientToken:p}));default:throw new Error(`Unknown launch type: ${n}`)}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(59),s=n(44);t.executeBeforeDeleteHooks=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,watch:n,ctx:i,variables:r,logger:c}=e,u=n.startChild("before-hooks");c.debug("xecute before delete hooks");const{success:l,message:d}=yield o.executeHooks(i,r,t.getHooks(),"delete","before",c);return l?(c.debug("Execute before delete hooks completed"),u.stop(),s.initiateCloudFormationStackDeletion(e)):(c.debug(`Before delete hooks failed with message: ${d}`),{stack:t,message:d,reason:"BEFORE_HOOKS_FAILED",status:a.CommandStatus.FAILED,events:[],success:!1,watch:n.stop()})})),t.executeAfterDeleteHooks=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,watch:n,result:i,ctx:s,variables:r,logger:c}=e;n.startChild("after-hooks"),c.debug("Execute after delete hooks");const{success:u,message:l}=yield o.executeHooks(s,r,t.getHooks(),"delete","after",c,(e=>{switch(e){case a.CommandStatus.CANCELLED:return"cancelled";case a.CommandStatus.SKIPPED:return"skipped";case a.CommandStatus.SUCCESS:return"success";case a.CommandStatus.FAILED:return"failed";default:throw new Error(`Unsupported command status: ${e}`)}})(i.status));return u?(c.debug("Execute after delete hooks completed"),Object.assign(Object.assign({},i),{watch:n.stop()})):(c.debug(`After delete hooks failed with message: ${l}`),Object.assign(Object.assign({},i),{message:l,status:a.CommandStatus.FAILED,reason:"AFTER_HOOKS_FAILED",success:!1,watch:n.stop()}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(21),s=n(2),r=n(31),c=n(3),u=a(n(10));class l extends r.AwsClient{constructor(e){super(e),this.getClient=(e,t)=>new o.Organizations(Object.assign(Object.assign({},this.clientOptions()),{credentials:e,region:t})),this.listAccounts=()=>i(this,void 0,void 0,(function*(){return this.withClient(e=>this.pagedOperation(t=>e.listAccounts(t),{},e=>e.Accounts))})),this.describeAccount=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.describeAccount({AccountId:e}),e=>e.Account)})),this.listPolicies=e=>i(this,void 0,void 0,(function*(){return this.withClient(t=>this.pagedOperation(e=>t.listPolicies(e),{Filter:e},e=>e.Policies))})),this.listDetailedPolicies=e=>i(this,void 0,void 0,(function*(){return this.listPolicies(e).then(e=>Promise.all(e.map(e=>e.Id).map(this.getDetailedPolicy)))})),this.getDetailedPolicy=e=>i(this,void 0,void 0,(function*(){return Promise.all([this.describePolicy(e),this.listTargetsAttachedToPolicy(e)]).then(([e,t])=>({policy:e,targets:t}))})),this.listAllPoliciesForTarget=e=>i(this,void 0,void 0,(function*(){return u.default(yield Promise.all(c.ORGANIZATION_POLICY_TYPES.map(t=>this.listPoliciesForTarget(e,t))))})),this.listPoliciesForTarget=(e,t)=>i(this,void 0,void 0,(function*(){return this.withClient(n=>this.pagedOperation(e=>n.listPoliciesForTarget(e),{TargetId:e,Filter:t},e=>e.Policies))})),this.listTargetsAttachedToPolicy=e=>i(this,void 0,void 0,(function*(){return this.withClient(t=>this.pagedOperation(e=>t.listTargetsForPolicy(e),{PolicyId:e},e=>e.Targets))})),this.describePolicy=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.describePolicy({PolicyId:e}),e=>e.Policy)})),this.deletePolicy=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.deletePolicy({PolicyId:e}),()=>!0)})),this.createPolicy=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.createPolicy(e),e=>e.Policy)})),this.updatePolicy=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.updatePolicy(e),e=>e.Policy)})),this.attachPolicy=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.attachPolicy(e),()=>!0)})),this.detachPolicy=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.detachPolicy(e),()=>!0)})),this.createAccount=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.createAccount(e),e=>{var t;return null===(t=e.CreateAccountStatus)||void 0===t?void 0:t.Id})})),this.describeOrganization=()=>i(this,void 0,void 0,(function*(){return this.withClientPromise(e=>e.describeOrganization(),e=>e.Organization)})),this.listAccountsForParent=e=>i(this,void 0,void 0,(function*(){return this.withClient(t=>this.pagedOperation(e=>t.listAccountsForParent(e),{ParentId:e},e=>e.Accounts))})),this.moveAccount=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.moveAccount(e),()=>!0)})),this.listOrganizationalUnitsForParent=e=>i(this,void 0,void 0,(function*(){return this.withClient(t=>this.pagedOperation(e=>t.listOrganizationalUnitsForParent(e),{ParentId:e},e=>e.OrganizationalUnits))})),this.listOrganizationRoots=()=>i(this,void 0,void 0,(function*(){return this.withClient(e=>this.pagedOperation(t=>e.listRoots(t),{},e=>e.Roots))})),this.listAllOrganizationUnitsWithDetails=()=>i(this,void 0,void 0,(function*(){const e=yield this.listOrganizationRoots();return Promise.all(e.map(e=>this.enrichOrganizationalUnit(e)))})),this.enrichOrganizationalUnit=e=>i(this,void 0,void 0,(function*(){const[t,n]=yield Promise.all([this.listOrganizationalUnitsForParent(e.Id),this.listAccountsForParent(e.Id)]),i=yield Promise.all(t.map(e=>this.enrichOrganizationalUnit(e)));return{ou:e,children:i,accounts:n}})),this.createOrganizationalUnit=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.createOrganizationalUnit(e),e=>e.OrganizationalUnit)})),this.deleteOrganizationalUnit=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.deleteOrganizationalUnit({OrganizationalUnitId:e}),()=>!0)})),this.listAWSServiceAccessForOrganization=()=>i(this,void 0,void 0,(function*(){return this.withClientPromise(e=>e.listAWSServiceAccessForOrganization(),e=>e.EnabledServicePrincipals)})),this.disableAWSServiceAccess=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.disableAWSServiceAccess({ServicePrincipal:e}),()=>!0)})),this.enableAWSServiceAccess=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.enableAWSServiceAccess({ServicePrincipal:e}),()=>!0)})),this.enablePolicyType=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.enablePolicyType(e),()=>!0)})),this.disablePolicyType=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.disablePolicyType(e),()=>!0)})),this.waitUntilPolicyTypeIsEnabled=(e,t)=>i(this,void 0,void 0,(function*(){const n=yield this.listOrganizationRoots().then(e=>e[0]).then(t=>t.PolicyTypes.find(t=>t.Type===e));if(n&&"ENABLED"===n.Status)return;yield s.sleep(3e3);const i=t-3e3;if(i<0)throw new Error(`Maximum wait time exceeded when waiting for policy type ${e} to become enabled`);return this.waitUntilPolicyTypeIsEnabled(e,i)})),this.waitUntilPolicyTypeIsDisabled=(e,t)=>i(this,void 0,void 0,(function*(){if(!(yield this.listOrganizationRoots().then(e=>e[0]).then(t=>t.PolicyTypes.find(t=>t.Type===e))))return;yield s.sleep(3e3);const n=t-3e3;if(n<0)throw new Error(`Maximum wait time exceeded when waiting for policy type ${e} to become disabled`);return this.waitUntilPolicyTypeIsDisabled(e,n)})),this.describeAccountCreationStatus=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.describeCreateAccountStatus({CreateAccountRequestId:e}),e=>e.CreateAccountStatus)})),this.waitAccountCreationToComplete=e=>i(this,void 0,void 0,(function*(){for(;;){const t=yield this.describeAccountCreationStatus(e);switch(t.State){case"IN_PROGRESS":yield s.sleep(5e3);break;case"FAILED":case"SUCCEEDED":return t;default:throw new Error(`Unknown account creation state: ${t.State}`)}}})),this.createOrganization=e=>i(this,void 0,void 0,(function*(){return this.withClientPromise(t=>t.createOrganization({FeatureSet:e}),e=>e.Organization)}))}}t.OrganizationsClient=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(166);t.parseDeploymentConfigFile=i.parseDeploymentConfigFile,t.parseConfigSets=i.parseConfigSets},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(4)),o=n(7);t.deploymentGroupPath=a.default.string().min(1).max(250).custom((e,t)=>{const n=/^[_a-zA-Z0-9][a-zA-Z0-9-_/ ]+$/;return n.test(e)?e.endsWith(" ")?t.error("endsWithWhitespace"):e.includes("  ")?t.error("subsequentWhitespace"):e.includes("//")?t.error("subsequentSeparators"):e.endsWith("/")?t.error("endsWithSeparator"):e.split("/").length>10?t.error("maxDepth"):e:t.error("string.pattern.base",{regex:n})}).messages({maxDepth:'"{{#label}}" hierarchy depth must not exceed 10',endsWithWhitespace:'"{{#label}}" must not end with whitespace',endsWithSeparator:'"{{#label}}" must not end with path separator (/)',subsequentSeparators:'"{{#label}}" must not contain subsequent path separators (/)',subsequentWhitespace:'"{{#label}}" must not contain subsequent whitespace'}),t.deploymentTargetName=a.default.string().min(1).max(60).regex(/^[a-zA-Z_]+[a-zA-Z0-9-_]*$/);const s=a.default.object({vars:o.vars,name:t.deploymentTargetName.required(),description:a.default.string(),status:a.default.string().valid("active","disabled"),configSets:[a.default.array().items(o.configSetName).unique(),o.configSetName]}),r=a.default.array().items(s),c=a.default.object().pattern(o.configSetName,o.configSet),u=a.default.object({vars:o.vars,targets:r,description:a.default.string(),status:a.default.string().valid("active","disabled"),priority:a.default.number().integer().min(0),configSets:[a.default.array().items(o.configSetName).unique(),o.configSetName]}),l=a.default.object().pattern(t.deploymentGroupPath,u).required();t.deploymentGroupsConfigFileSchema=a.default.object({vars:o.vars,deploymentGroups:l,configSets:c})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(174);t.accountsOperationCommand=i.accountsOperationCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(3),o=e=>{const t=new Map;return e.forEach(({policy:e,targets:n})=>{n.forEach(n=>{const i=t.get(n.TargetId);i?i.push(e.PolicySummary.Name):t.set(n.TargetId,[e.PolicySummary.Name])})}),t};t.loadOrganizationData=(e,t)=>i(void 0,void 0,void 0,(function*(){const n=e.getClient();t.info("Load organization data");const i=yield n.describeOrganization(),s="ALL"===i.FeatureSet,[r,c,u,l,d,f]=yield Promise.all([n.listDetailedPolicies(a.TAG_POLICY_TYPE),n.listDetailedPolicies(a.SERVICE_CONTROL_POLICY_TYPE),n.listAllOrganizationUnitsWithDetails(),n.listAccounts(),s?n.listAWSServiceAccessForOrganization():[],n.listOrganizationRoots()]),h=c.map(e=>e.policy),m=r.map(e=>e.policy);t.debugObject("Current service control policies:",h),t.debugObject("Current tag policies:",m),t.debugObject("Trusted AWS services:",d);const p=u.find(e=>"Root"===e.ou.Name),g=d.map(e=>e.ServicePrincipal);return{currentServiceControlPolicies:h,currentTagPolicies:m,currentServiceControlPoliciesByTarget:o(c),currentTagPoliciesByTarget:o(r),currentRootOrganizationalUnit:p,currentAccounts:l,currentTrustedAwsServices:g,currentEnabledPolicies:f[0].PolicyTypes.filter(e=>"ENABLED"===e.Status).map(e=>e.Type),currentOrganization:i,currentOrganizationHasAllFeaturesEnabled:"ALL"===i.FeatureSet}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(178),o=n(180),s=n(181);t.planOrganizationLaunch=(e,t)=>i(void 0,void 0,void 0,(function*(){const[n,i,r]=yield Promise.all([a.planPoliciesDeployment(e,t),o.planOrganizationUnitsDeployment(e,t),s.planOrganizationBasicConfigDeployment(e,t)]);return{policiesPlan:n,organizationalUnitsPlan:i,organizationBasicConfigPlan:r,hasChanges:n.hasChanges||i.hasChanges||r.hasChanges}}))},function(e,t){e.exports=require("lodash.without")},function(e,t){e.exports=require("lodash.intersection")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(9)),s=n(6),r=a(n(11)),c=n(14),u=a(n(19));class l extends o.default{constructor(e,t){super(e),this.confirmLaunch=e=>i(this,void 0,void 0,(function*(){return this.header(this.messages.confirmHeader,!0),e.organizationalUnits.forEach(e=>{this.message(`  ${e.path}:`,!0),e.accounts.forEach(({account:e,config:t})=>{this.message(`    - id:       ${t.id}`,!0),this.message(`      name:     ${e.Name}`),this.message(`      email:    ${e.Email}`),this.message("      config sets:"),t.configSets.forEach(e=>{this.message(`        - ${e}`)})})}),(yield this.confirm(this.messages.confirmQuestion,!0))?s.ConfirmResult.YES:s.ConfirmResult.NO})),this.printOutput=e=>{if(this.header(this.messages.outputHeader,!0),0===e.results.length)return this.message(this.messages.outputNoAccounts,!0),e;const t=new r.default;return e.results.forEach(e=>{e.results.forEach(n=>{n.results.forEach(i=>{i.results.forEach(a=>{a.result.results.length>0?a.result.results.forEach(o=>{t.cell("Organizational unit",e.path),t.cell("Account",n.accountId),t.cell("Config set",i.configSetName),t.cell("Command path",a.commandPath),t.cell("Stack path",o.stack.getPath()),t.cell("Stack name",o.stack.getName()),t.cell("Status",c.formatCommandStatus(o.status)),t.cell("Reason",o.reason),t.cell("Time",u.default(o.watch.secondsElapsed)),t.cell("Message",o.message),t.newRow()}):(t.cell("Organizational unit",e.path),t.cell("Account",n.accountId),t.cell("Config set",i.configSetName),t.cell("Command path",a.commandPath),t.cell("Stack path","-"),t.cell("Stack name","-"),t.cell("Status",c.formatCommandStatus(a.status)),t.cell("Reason","-"),t.cell("Time",u.default(a.result.watch.secondsElapsed)),t.cell("Message",a.result.message),t.newRow())})})})}),this.message(t.toString(),!0),e},this.messages=t}}t.CliAccountsOperationIO=l},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(9)),s=a(n(11)),r=n(14),c=a(n(19));class u extends o.default{constructor(e,t,n=null){super(e,n),this.printOutput=e=>{if(this.header("DEPLOYMENT SUMMARY"),0===e.results.length)return this.message("No targets",!0),e;const t=new s.default;return e.results.forEach(e=>{e.results.forEach(n=>{n.results.forEach(i=>{i.results.forEach(a=>{a.result.results.length>0?a.result.results.forEach(o=>{t.cell("Deployment group",e.path),t.cell("Target",n.name),t.cell("Config set",i.configSetName),t.cell("Command path",a.commandPath),t.cell("Stack path",o.stack.getPath()),t.cell("Stack name",o.stack.getName()),t.cell("Status",r.formatCommandStatus(o.status)),t.cell("Reason",o.reason),t.cell("Time",c.default(o.watch.secondsElapsed)),t.cell("Message",o.message),t.newRow()}):(t.cell("Deployment group",e.path),t.cell("Target",n.name),t.cell("Config set",i.configSetName),t.cell("Command path",a.commandPath),t.cell("Stack path","-"),t.cell("Stack name","-"),t.cell("Status",r.formatCommandStatus(a.status)),t.cell("Reason","-"),t.cell("Time",c.default(a.result.watch.secondsElapsed)),t.cell("Message",a.result.message),t.newRow())})})})}),this.message(t.toString(),!0),e},this.confirmOperation=e=>i(this,void 0,void 0,(function*(){return this.header("Deployment plan",!0),e.groups.forEach(e=>{this.message(`  ${e.path}:`,!0),e.targets.forEach(e=>{this.message(`    - name: ${e.name}`,!0),this.message(`      description: ${e.description||"-"}`),this.message("      config sets:"),e.configSets.forEach(e=>{this.message(`        - ${e}`)})})}),this.confirm("Continue to deploy the targets?",!0)})),this.operation=t}}t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(226);t.deploymentTargetsOperationCommand=i.deploymentTargetsOperationCommand},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(74)),o=i(n(75)),s=i(n(125)),r=i(n(131)),c=i(n(157)),u=i(n(224));a.default.command(o.default).command(s.default).command(r.default).command(c.default).command(u.default).option("profile",{alias:"p",description:"AWS profile",string:!0,global:!0}).option("log",{description:"Set logging level",string:!0,default:"info",choices:["trace","debug","info","warn","error"],global:!0}).option("log-confidential-info",{description:"Log confidential information",boolean:!0,default:!1,global:!0}).option("yes",{alias:"y",description:"Assume yes to all questions",boolean:!0,default:!1,global:!0}).option("stats",{description:"Print statistics after command execution",boolean:!0,default:!1,global:!0}).option("load-aws-sdk-config",{description:"Prefer loading credentials from configuration file over the credentials file",boolean:!0,default:!1,global:!0}).option("dir",{alias:"d",description:"Path to project dir",string:!0,global:!0}).option("var",{description:"Variable",string:!0,global:!0}).option("var-file",{description:"Variable file",string:!0,global:!0}).option("env-file",{description:"Environment variables file",string:!0,global:!0}).demandCommand(1,"Provide command").strict(!0).help().argv},function(e,t){e.exports=require("yargs")},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(3),s=n(36),r=i(n(42));t.default={command:"launch [commandPath]",desc:"Launch stacks within the given command path",builder:{commandPath:{default:o.ROOT_STACK_GROUP_PATH},ignoreDependencies:{default:!1}},handler:e=>a.handle(e,t=>Object.assign(Object.assign({},t),{ignoreDependencies:!1,commandPath:e.commandPath}),e=>s.launchStacksCommand(e,new r.default(e.options)))}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("js-yaml")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("dotenv-expand")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),s=n(15),r=a(n(4)),c=n(7),u=n(113),l=r.default.object({commandPath:c.commandPath.required()}).unknown(!0);t.launchStacksCommand=(e,t,n=null)=>i(void 0,void 0,void 0,(function*(){return o.validateInput(l,e).then(e=>s.buildConfigContext(e.options,e.variables,t,n)).then(t=>s.prepareLaunchContext(t,e.commandPath)).then(n=>u.executeLaunchContext(n,e,t)).then(t.printOutput)}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(85);t.prepareLaunchContext=i.prepareLaunchContext},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(52),s=a(n(16)),r=n(53),c=n(1),u=n(37),l=(e,t)=>{const n=[];for(const i of t.getStacksByPath(e)){n.push(i.getPath());for(const e of i.getDependencies())for(const i of l(e,t))n.push(i)}return s.default(n)},d=(e,t)=>{const n=e.getStacks().reduce((e,n)=>[...e,...l(n.getPath(),t)],new Array),i=e.getChildren().reduce((e,n)=>[...d(n,t),...e],new Array);return s.default([...n,...i])};t.collectStacksToLaunch=(e,t)=>{if(r.isStackGroupPath(t)){const n=e.getStackGroupConfig(t);return n?d(n,e).map(e.getStackByExactPath):[]}return l(t,e).map(e.getStackByExactPath)},t.sortStacksForLaunch=e=>e.slice().sort((e,t)=>0===e.getDependencies().length?-1:0===t.getDependencies().length?1:t.getDependencies().includes(e.getPath())?-1:e.getDependencies().includes(t.getPath())?1:0),t.prepareLaunchContext=(e,n)=>i(void 0,void 0,void 0,(function*(){const{defaultCredentialProvider:a,options:s,variables:r,logger:l,templateEngine:d}=e;l.info("Prepare context");const f=t.collectStacksToLaunch(e,n);if(0===f.length)throw new c.BaubleError(`No stacks found within the given command path: ${n}`);const h=f.reduce((e,t)=>e.find(e=>e.getName()===t.getCredentialProvider().getName())?e:[...e,t.getCredentialProvider()],new Array);l.debugObject("Stacks to launch contain the following credential providers",h.map(e=>e.getName())),yield Promise.all(h.map(e=>i(void 0,void 0,void 0,(function*(){return e.getCallerIdentity()}))));const m=t.sortStacksForLaunch(f);return yield u.validateStackCredentialProvidersWithAllowedAccountIds(m),new o.StdCommandContext({stacks:m,defaultCredentialProvider:a,options:s,variables:r,logger:l,templateEngine:d})}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(87);t.prepareDeleteContext=i.prepareDeleteContext},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(16)),s=n(54),r=n(53),c=n(52),u=n(1),l=n(37),d=(e,t)=>{const n=[];for(const i of t.getStacksByPath(e)){n.push(i.getPath());for(const e of i.getDependants())for(const i of d(e,t))n.push(i)}return o.default(n)},f=(e,t)=>{const n=e.getStacks().reduce((e,n)=>[...e,...d(n.getPath(),t)],new Array),i=e.getChildren().reduce((e,n)=>[...f(n,t),...e],new Array);return o.default([...n,...i])};t.sortStacksForDeletion=e=>e.slice().sort((t,n)=>0===t.getDependants().length&&n.getDependants().length>0?-1:0===n.getDependants().length&&t.getDependants().length>0||s.collectAllDependants(t.getPath(),e).includes(n.getPath())?1:s.collectAllDependants(n.getPath(),e).includes(t.getPath())?-1:t.getPath().localeCompare(n.getPath())),t.collectStacksToDelete=(e,t)=>{if(r.isStackGroupPath(t)){const n=e.getStackGroupConfig(t);return n?f(n,e).map(e.getStackByExactPath):[]}return d(t,e).map(e.getStackByExactPath)},t.prepareDeleteContext=(e,n)=>i(void 0,void 0,void 0,(function*(){const{defaultCredentialProvider:i,options:a,variables:o,logger:s,templateEngine:r}=e,d=t.collectStacksToDelete(e,n);if(0===d.length)throw new u.BaubleError(`No stacks found within the given command path: ${n}`);const f=t.sortStacksForDeletion(d);return yield l.validateStackCredentialProvidersWithAllowedAccountIds(f),new c.StdCommandContext({stacks:f,defaultCredentialProvider:i,options:a,variables:o,logger:s,templateEngine:r})}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(55);t.ConfigContext=i.ConfigContext;var a=n(89);t.buildConfigContext=a.buildConfigContext},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(38)),s=n(25),r=a(n(13)),c=n(3),u=n(8),l=n(1),d=n(17),f=n(91),h=n(54),m=n(101),p=n(37),g=n(104),v=a(n(16)),y=a(n(10)),C=n(106),w=n(108),P=n(55),_=n(109),S=n(29),b=n(7);t.createRootStackGroup=()=>new S.StackGroup({name:c.ROOT_STACK_GROUP_PATH,isRoot:!0,regions:[],commandRole:null,project:null,timeout:null,templateBucket:null,tags:new Map,path:c.ROOT_STACK_GROUP_PATH,children:new Array,stacks:new Array,data:{},hooks:[],capabilities:null,accountIds:[]}),t.makeStackGroupPath=(e,t)=>{const n=r.default.basename(e);return t.isRoot()?`/${n}`:`${t.getPath()}/${n}`};const O=(e,t=new Map)=>(t.set(e.getPath(),e),e.getChildren().forEach(e=>O(e,t)),t),E=(e,t,n)=>{if(!e)return t;const i=n.get(e.iamRoleArn);if(i)return i;const a=t.createCredentialProviderForCommandRole(e);return n.set(e.iamRoleArn,a),a};t.createStackGroupFromParent=(e,n)=>new S.StackGroup({name:r.default.basename(e),isRoot:!1,regions:n.getRegions(),commandRole:n.getCommandRole(),project:n.getProject(),timeout:n.getTimeout(),templateBucket:n.getTemplateBucket(),tags:n.getTags(),path:t.makeStackGroupPath(e,n),children:new Array,stacks:new Array,data:n.getData(),hooks:n.getHooks(),capabilities:n.getCapabilities(),accountIds:n.getAccountIds()});const A=(e,n,a,o,s,r)=>i(void 0,void 0,void 0,(function*(){const l=s?t.createStackGroupFromParent(o,s):t.createRootStackGroup();return((e,t,n,a,o,s)=>i(void 0,void 0,void 0,(function*(){const i=`${o}/${c.STACK_GROUP_CONFIG_FILE}`;if(!(yield u.fileExists(i)))return a;const r=yield m.parseStackGroupConfigFile(e.childLogger(a.getPath()),t,n,i,s),l=a.toProps();return r.project&&(l.project=r.project),r.templateBucket&&(l.templateBucket=r.templateBucket),r.regions.length>0&&(l.regions=r.regions),r.commandRole&&(l.commandRole=r.commandRole),r.capabilities&&(l.capabilities=r.capabilities),r.tags.forEach((e,t)=>{l.tags.set(t,e)}),l.data=Object.assign(Object.assign({},a.getData()),r.data),l.hooks=[...a.getHooks(),...r.hooks],l.accountIds=v.default([...a.getAccountIds(),...r.accountIds]),new S.StackGroup(l)})))(e,n,a,l,o,r)})),k=(e,t,n,a,s,u,d,f,h,C)=>i(void 0,void 0,void 0,(function*(){p.validate(b.stackGroupName,r.default.basename(f),`Directory ${f} name is not suitable for a stack group`);const P=yield A(e,u,d,f,h,C),O=yield o.default.promise(f,{alwaysStat:!0,depth:0,fileFilter:e=>e.basename.endsWith(c.CONFIG_FILE_EXTENSION),type:"files_directories"}),D=O.filter(e=>e.stats.isDirectory()),I=P.toProps();I.children=yield Promise.all(D.map(o=>i(void 0,void 0,void 0,(function*(){return yield k(e,t,n,a,s,u,d,o.fullPath,P,C)}))));const T=O.filter(e=>e.stats.isFile()&&e.basename!==c.STACK_GROUP_CONFIG_FILE),R=yield Promise.all(T.map(o=>i(void 0,void 0,void 0,(function*(){return yield((e,t,n,a,o,s,c,u,d,f)=>i(void 0,void 0,void 0,(function*(){const i={project:d.getProject(),regions:d.getRegions(),commandRole:d.getCommandRole(),path:d.getPath(),isRoot:d.isRoot(),templateBucket:d.getTemplateBucket(),timeout:d.getTimeout(),tags:d.getTags(),data:d.getData(),capabilities:d.getCapabilities()},h=r.default.basename(u),C=((e,t)=>t.isRoot()?`/${e}`:`${t.getPath()}/${e}`)(h,d),P=Object.assign(Object.assign({},c),{stackGroup:i}),O=yield m.parseStackConfigFile(e.childLogger(C),s,P,u,f),A=O.name||((e,t)=>`${t?`${t}-`:""}${e.substr(1)}`.replace(/\//g,"-").replace(/\.yml$/,""))(C,O.project||d.getProject()),k=O.regions.length>0?O.regions:d.getRegions();if(0===k.length)throw new l.BaubleError(`Stack ${C} has no regions`);const D=O.template||h;if(p.validate(b.stackName,A,`Name of stack ${C} is not valid`),!D)throw new l.BaubleError(`Stack ${C} has no template`);const I=yield g.buildParameters(O.parameters,a);v.default(y.default(Array.from(I.values()).reduce((e,t)=>[...e,t.getIamRoleArns()],new Array))).map(e=>({iamRoleArn:e})).forEach(e=>{E(e,t,n)});const T=v.default([...d.getAccountIds(),...O.accountIds]),R=[...d.getHooks(),...O.hooks],x=yield _.initializeHooks(R,o),j=O.commandRole||d.getCommandRole(),L=E(j,t,n),M=O.capabilities||d.getCapabilities();return k.map(e=>{const t=`${C}/${e}`,n=w.makeSecretsPath(t,O.project||d.getProject()),i={name:A,template:D,secretsPath:n,region:e,parameters:I,commandRole:j,credentialProvider:L,hooks:x,path:t,project:O.project||d.getProject(),tags:d.getTags(),timeout:O.timeout||d.getTimeout()||{create:0,update:0},dependencies:O.depends,dependants:[],templateBucket:O.templateBucket||d.getTemplateBucket(),data:d.getData(),secrets:w.buildSecrets(n,O.secrets),capabilities:M,accountIds:T};return O.tags.forEach((e,t)=>{i.tags.set(t,e)}),i.data=Object.assign(Object.assign({},i.data),O.data),new S.Stack(i)})})))(e,t,n,a,s,u,d,o.fullPath,P,C)}))));return I.stacks=y.default(R),new S.StackGroup(I)}));t.buildConfigContext=(e,t,n,a=null)=>i(void 0,void 0,void 0,(function*(){const o=yield((e=null)=>i(void 0,void 0,void 0,(function*(){if(e)return e;const t=yield s.initDefaultCredentialProviderChain();return new s.DefaultCredentialProvider(t)})))(a);var m;n.info("Validate credentials"),yield(m=o,i(void 0,void 0,void 0,(function*(){return m.getCallerIdentity()}))),n.info("Build configuration");const p=e.getProjectDir();n.debug(`Current project dir: ${p}`);const g=r.default.join(p,c.STACKS_DIR);if(!(yield u.dirExists(g)))throw new l.BaubleError(`Bauble stacks dir ${c.STACKS_DIR} not found from the project dir ${p}`);const v=r.default.join(p,c.TEMPLATES_DIR);if(!(yield u.dirExists(v)))throw new l.BaubleError(`Bauble templates dir ${c.TEMPLATES_DIR} not found from the project dir ${p}`);const y=new d.TemplateEngine,w=_.coreHookInitializers(),S=f.coreResolverInitializers();yield C.loadExtensions(p,n,S,w,y);const b=new Map,E=yield k(n,o,b,S,w,e,t,g,null,y),A=O(E),D=(I=A,Array.from(I.values()).reduce((e,t)=>[...e,...t.getStacks()],new Array));var I;const T=h.processStackDependencies(D),R=new Map(T.map(e=>[e.getPath(),e]));return h.checkCyclicDependencies(R),new P.ConfigContext({rootStackGroup:E,stackGroups:A,defaultCredentialProvider:o,options:e,variables:t,logger:n,stackConfigsByPath:R,templateEngine:y})}))},function(e,t){e.exports=require("handlebars")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(56);t.coreResolverInitializers=()=>new Map([["stack-output",e=>i(void 0,void 0,void 0,(function*(){return new a.StackOutputResolver(e)}))],["external-stack-output",e=>i(void 0,void 0,void 0,(function*(){return new a.ExternalStackOutputResolver(e)}))],["cmd",e=>i(void 0,void 0,void 0,(function*(){return new a.CmdResolver(e)}))],["secret",e=>i(void 0,void 0,void 0,(function*(){return new a.SecretResolver(e)}))],["static",e=>i(void 0,void 0,void 0,(function*(){return new a.StaticResolver(e)}))]])},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(35),o=n(57),s=a.promisify(o.exec);t.CmdResolver=class{constructor(e){if(this.isConfidential=()=>!1,this.getDependencies=()=>[],this.getIamRoleArns=()=>[],this.resolve=({logger:e,parameterName:t})=>i(this,void 0,void 0,(function*(){e.debug(`Resolving value for parameter '${t}' with command: ${this.command}`);const{stdout:n,stderr:i}=yield s(this.command);return(n||"").trim()})),!e.command)throw new Error("command is required property");this.command=e.command}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(30);t.ExternalStackOutputResolver=class{constructor(e){this.iamRoleArns=[],this.isConfidential=()=>!1,this.getDependencies=()=>[],this.getIamRoleArns=()=>this.iamRoleArns,this.resolve=({ctx:e,stack:t,logger:n,parameterName:o})=>i(this,void 0,void 0,(function*(){const i=this.commandRole?e.getDefaultCredentialProvider().createCredentialProviderForCommandRole(this.commandRole):t.getCredentialProvider(),s=this.region||t.getRegion();n.debugObject(`Resolving value for parameter '${o}' using external-stack-output resolver:`,{stack:this.stack,region:s,output:this.output});const r=new a.CloudFormationClient({credentialProvider:i,region:s,logger:n}),c=yield r.describeStack(this.stack);if(!c)throw new Error(`No such stack: ${this.stack}`);const u=c.Outputs.find(e=>e.OutputKey===this.output);if(!u)throw new Error(`Stack ${this.stack} does not have output: ${this.output}`);return u.OutputValue})),this.stack=e.stack,this.output=e.output,this.region=e.region,this.commandRole=e.commandRole?{iamRoleArn:e.commandRole}:null,this.iamRoleArns=this.commandRole?[this.commandRole.iamRoleArn]:[]}}},function(e,t){e.exports=require("lodash.takerightwhile")},function(e,t){e.exports=require("lodash.last")},function(e,t){e.exports=require("https")},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(10));t.ListResolver=class{constructor(e){this.isConfidential=()=>!1,this.getDependencies=()=>o.default(this.resolvers.map(e=>e.getDependencies())),this.getIamRoleArns=()=>o.default(this.resolvers.map(e=>e.getIamRoleArns())),this.resolve=e=>i(this,void 0,void 0,(function*(){return Promise.all(this.resolvers.map((t,n)=>i(this,void 0,void 0,(function*(){return t.resolve(Object.assign(Object.assign({},e),{listParameterIndex:n}))}))))})),this.resolvers=e}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(18);t.SecretResolver=class{constructor(e){this.isConfidential=()=>!0,this.getDependencies=()=>this.dependencies,this.getIamRoleArns=()=>[],this.resolve=({ctx:e,stack:t})=>i(this,void 0,void 0,(function*(){const[n,...i]=this.stack?e.getStacksByPath(this.stack):[t];if(!n)throw new Error(`Stack not found with path: ${this.stack}`);if(i.length>0)throw new Error(`More than one stack found with path: ${this.stack}`);const o=new a.SSMClient({credentialProvider:n.getCredentialProvider(),region:n.getRegion(),logger:e.getLogger()}),s=n.getSecrets().get(this.secret);if(!s)throw new Error(`Stack ${t.getPath()} does not have secret: ${this.secret}`);return o.getEncryptedParameter(s.ssmParameterName)})),this.stack=e.stack,this.secret=e.secret,this.dependencies=this.stack?[this.stack]:[]}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(30);t.StackOutputResolver=class{constructor(e){this.isConfidential=()=>!1,this.getDependencies=()=>this.dependencies,this.getIamRoleArns=()=>[],this.resolve=({ctx:e,logger:t,parameterName:n})=>i(this,void 0,void 0,(function*(){t.debugObject(`Resolving value for parameter '${n}' using stack-output resolver:`,{stack:this.stack,output:this.output});const[i,...o]=e.getStacksByPath(this.stack);if(!i)throw new Error(`Stack not found with path: ${this.stack}`);if(o.length>0)throw new Error(`More than one stack found with path: ${this.stack}`);const s=new a.CloudFormationClient({credentialProvider:i.getCredentialProvider(),region:i.getRegion(),logger:t}),r=yield s.describeStack(i.getName());if(!r)throw new Error(`No such stack: ${i.getName()}`);const c=r.Outputs.find(e=>e.OutputKey===this.output);if(!c)throw new Error(`Stack ${i.getName()} does not have output ${this.output}`);return c.OutputValue})),this.stack=e.stack,this.output=e.output,this.dependencies=[this.stack]}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});t.StaticResolver=class{constructor(e){this.isConfidential=()=>!1,this.getDependencies=()=>[],this.getIamRoleArns=()=>[],this.resolve=e=>i(this,void 0,void 0,(function*(){return this.value})),this.value=`${e}`}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(102);t.parseStackGroupConfigFile=i.parseStackGroupConfigFile,t.parseStackConfigFile=i.parseStackConfigFile},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(17),o=n(8),s=n(24),r=n(103),c=n(1),u=n(39),l=e=>{if(!e)return null;const{name:t,keyPrefix:n}=e;return{name:t||null,keyPrefix:n||null}},d=e=>e?"number"==typeof e?{create:e,update:e}:{create:e.create,update:e.update}:null,f=e=>null==e?new Map:new Map(Object.entries(e).map(e=>{const[t,n]=e;return[t,`${n}`]})),h=e=>null==e?new Map:new Map(Object.keys(e).map(t=>[t,{name:t,description:e[t].description}])),m=e=>null==e?[]:Array.isArray(e)?e:[e],p=e=>null==e?null:Array.isArray(e)?e:[e],g=e=>null==e?[]:Array.isArray(e)?e.map(e=>e.toString()):[e.toString()];t.parseStackConfigFile=(e,t,n,v,y)=>i(void 0,void 0,void 0,(function*(){const i=t.isConfidentialInfoLoggingEnabled(),C=yield o.readFileContents(v);e.traceText("Raw stack config file:",C);const w=i?e=>e:e=>Object.assign(Object.assign({},e),{env:"<concealed>"});e.traceObject("Render stack config file using variables:",n,w);const P=yield a.renderTemplate(y,v,C,n);e.traceText("Final rendered stack config file:",P);const _=(yield s.parseYaml(P))||{},{error:S}=r.stackConfigFileSchema.validate(_,{abortEarly:!1});if(S){const e=S.details.map(e=>`  - ${e.message}`).join("\n");throw new c.BaubleError(`${S.details.length} validation error(s) in stack config file ${v}:\n\n${e}`)}const b=_.parameters?new Map(Object.entries(_.parameters)):new Map,O=_.data||{},E=p(_.capabilities),A=g(_.accountIds);return{project:_.project||null,commandRole:u.parseCommandRole(_.commandRole),regions:m(_.regions),name:_.name||null,template:_.template||null,timeout:d(_.timeout),depends:(k=_.depends,null==k?[]:Array.isArray(k)?k:[k]),templateBucket:l(_.templateBucket),tags:f(_.tags),secrets:h(_.secrets),hooks:_.hooks||[],accountIds:A,capabilities:E,parameters:b,data:O};var k})),t.parseStackGroupConfigFile=(e,t,n,h,v)=>i(void 0,void 0,void 0,(function*(){const i=t.isConfidentialInfoLoggingEnabled(),y=yield o.readFileContents(h),C=i?e=>e:e=>Object.assign(Object.assign({},e),{env:"<concealed>"});e.traceText("Raw stack group config file:",y),e.traceObject("Render stack group config file using variables:",n,C);const w=yield a.renderTemplate(v,h,y,n);e.traceText("Final rendered stack group config file:",w);const P=(yield s.parseYaml(w))||{},{error:_}=r.stackGroupConfigFileSchema.validate(P,{abortEarly:!1});if(_){const e=_.details.map(e=>`  - ${e.message}`).join("\n");throw new c.BaubleError(`${_.details.length} validation error(s) in stack group config file ${h}:\n\n${e}`)}const S=P.data||{},b=p(P.capabilities),O=g(P.accountIds);return{project:P.project||null,commandRole:u.parseCommandRole(P.commandRole),regions:m(P.regions),templateBucket:l(P.templateBucket),tags:f(P.tags),timeout:d(P.timeout),hooks:P.hooks||[],accountIds:O,capabilities:b,data:S}}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(4)),o=n(7),s=n(32);t.stackGroupConfigFileSchema=a.default.object({project:o.project,templateBucket:s.templateBucket,tags:s.tags,hooks:s.hooks,data:o.data,regions:o.regions,accountIds:[o.accountId,o.accountIds],timeout:s.timeout,commandRole:o.iamRoleArn,capabilities:s.stackCapabilities}),t.stackConfigFileSchema=a.default.object({project:o.project,regions:o.regions,accountIds:[o.accountId,o.accountIds],commandRole:o.iamRoleArn,templateBucket:s.templateBucket,tags:s.tags,hooks:s.hooks,data:o.data,template:s.template,parameters:s.parameters,secrets:s.secrets,timeout:s.timeout,name:o.stackName,depends:[o.stackPath,o.stackPaths],capabilities:s.stackCapabilities})},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(105),o=n(56),s=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const i="string"==typeof t||"number"==typeof t||"boolean"==typeof t?"static":t.resolver;if(!i)throw new Error(`Parameter ${e} has no resolver property`);if("string"!=typeof i)throw new Error(`Parameter ${e} has resolver property of invalid type, expected string`);const o=n.get(i);if(!o)throw new Error(`Parameter ${e} has unknown resolver ${i}`);const s=yield o(t);return new a.ResolverExecutor(i,s,t)}));t.buildParameters=(e,t)=>i(void 0,void 0,void 0,(function*(){const n=new Map;for(const[i,r]of Array.from(e.entries()))if(Array.isArray(r)){const e=yield Promise.all(r.map((e,n)=>s(`${i}[${n}]`,e,t)));n.set(i,new a.ResolverExecutor("list",new o.ListResolver(e),r))}else{const e=yield s(i,r,t);n.set(i,e)}return n}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});t.ResolverExecutor=class{constructor(e,t,n){this.resolve=e=>i(this,void 0,void 0,(function*(){return this.resolver.resolve(e)})),this.isConfidential=()=>!0===this.overrideConfidential||!1!==this.overrideConfidential&&(!!this.resolver.isConfidential&&this.resolver.isConfidential()),this.getDependencies=()=>this.resolver.getDependencies?this.resolver.getDependencies():[],this.getIamRoleArns=()=>this.resolver.getIamRoleArns?this.resolver.getIamRoleArns():[],this.getName=()=>this.name,this.name=e,this.resolver=t,this.overrideConfidential=n.confidential}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(13)),s=n(3),r=n(8),c=a(n(38)),u=a(n(107)),l=n(1),d=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const i=o.default.join(e,s.RESOLVERS_DIR);if(yield r.dirExists(i)){t.debug(`Found resolvers dir: ${i}`);const e=yield c.default.promise(i,{alwaysStat:!0,depth:100,type:"files",fileFilter:e=>e.basename.endsWith(".js")});for(const i of e){const{name:e,init:a}=u.default(i.fullPath);if(!e)throw new l.BaubleError(`Resolver name not defined in ${i.fullPath}`);if(n.has(e))throw new l.BaubleError(`Resolver name '${e}' defined in ${i.fullPath} is already registered`);if(!a)throw new l.BaubleError(`Resolver init not defined in ${i.fullPath}`);t.debug(`Register resolver: ${e}`),n.set(e,a)}}else t.debug("Resolvers dir not found")})),f=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const i=o.default.join(e,s.HELPERS_DIR);if(yield r.dirExists(i)){t.debug(`Found helpers dir: ${i}`);const e=yield c.default.promise(i,{alwaysStat:!0,depth:100,type:"files",fileFilter:e=>e.basename.endsWith(".js")});for(const i of e){const e=u.default(i.fullPath);if(!e.name)throw new l.BaubleError(`Helper name not defined in ${i.fullPath}`);if(!e.fn)throw new l.BaubleError(`Helper fn not defined in ${i.fullPath}`);t.debug(`Register helper: ${e.name}`),n.registerHelper(e.name,e.fn)}}else t.debug("Helpers dir not found")})),h=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const i=o.default.join(e,s.HOOKS_DIR);if(yield r.dirExists(i)){t.debug(`Found hooks dir: ${i}`);const e=yield c.default.promise(i,{alwaysStat:!0,depth:100,type:"files",fileFilter:e=>e.basename.endsWith(".js")});for(const i of e){const{type:e,init:a}=u.default(i.fullPath);if(!e)throw new l.BaubleError(`Hook type not defined in ${i.fullPath}`);if(n.has(e))throw new l.BaubleError(`Hook type '${e}' defined in ${i.fullPath} is already registered`);if(!a)throw new l.BaubleError(`Hook init not defined in ${i.fullPath}`);t.debug(`Register hook: ${e}`),n.set(e,a)}}else t.debug("Hooks dir not found")})),m=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const i=o.default.join(e,s.PARTIALS_DIR);if(yield r.dirExists(i)){t.debug(`Found partials dir: ${i}`);const e=yield c.default.promise(i,{alwaysStat:!0,depth:100,type:"files"});for(const a of e){const e=a.fullPath.substr(i.length+1);t.debug(`Register partial: ${e}`);const o=yield r.readFileContents(a.fullPath);n.registerPartial(e,o)}}else t.debug("Partials dir not found")}));t.loadExtensions=(e,t,n,a,o)=>i(void 0,void 0,void 0,(function*(){yield Promise.all([d(e,t,n),f(e,t,o),h(e,t,a),m(e,t,o)])}))},function(e,t){e.exports=require},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildSecrets=(e,t)=>new Map(Array.from(t.entries()).map(([t,n])=>[t,{name:t,description:n.description,ssmParameterName:`${e}${t}`}])),t.makeSecretsPath=(e,t)=>`${t?`/${t}`:""}${e}/`},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1),o=n(110),s=n(112);t.coreHookInitializers=()=>new Map([["cmd",e=>Promise.resolve(new o.CmdHook(e))]]),t.initializeHooks=(e,t)=>i(void 0,void 0,void 0,(function*(){return Promise.all(e.map(e=>i(void 0,void 0,void 0,(function*(){const n=t.get(e.type);if(!n)throw new a.BaubleError(`Unknown hook type: ${e.type}`);const i=yield n(e);return new s.HookExecutor(e,i)}))))}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(111);t.CmdHook=i.CmdHook},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(35),o=n(57),s=n(2),r=a.promisify(o.exec);t.CmdHook=class{constructor(e){if(this.config=e,!e.command)throw new Error("command is required property");this.command=e.command,this.cwd=e.cwd||null,this.register=e.register||null}execute(e){return i(this,void 0,void 0,(function*(){try{const{ctx:t,variables:n,status:i,operation:a,stage:o}=e,c=this.cwd||t.getOptions().getProjectDir(),u=Object.assign(Object.assign({},s.deepCopy(process.env)),{BL_COMMAND_STAGE:o,BL_COMMAND_OPERATION:a});i&&(u.BL_COMMAND_STATUS=i);const{stdout:l}=yield r(this.command,{cwd:c,env:u});return console.log(l),this.register&&(n[this.register]=l.trim()),{message:"Success",success:!0}}catch(e){return{message:e.message,success:!1}}}))}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});t.HookExecutor=class{constructor(e,t){this.match=e=>!(this.config.stage&&!this.config.stage.includes(e.stage))&&(!(this.config.operation&&!this.config.operation.includes(e.operation))&&!(e.status&&this.config.status&&!this.config.status.includes(e.status))),this.execute=e=>i(this,void 0,void 0,(function*(){return this.hook.execute(e)})),this.config=e,this.hook=t}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(2),o=n(6),s=n(0),r=n(114);t.executeLaunchContext=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const i=e.getOptions().isAutoConfirmEnabled(),{watch:c}=t;if(n.info("Launch context"),!i&&(yield n.confirmLaunch(e))!==o.ConfirmResult.YES)return{success:!1,results:[],status:s.CommandStatus.CANCELLED,message:"Cancelled",watch:c.stop()};if(i){const t=e.getStacks().reduce((t,i)=>{const a=i.getDependencies().map(e=>t.get(e)),o=r.launchStack(c,e,n,i,a);return t.set(i.getPath(),o),t},new Map),i=yield Promise.all(Array.from(t.values())),a=void 0===i.find(e=>!e.success);return{success:a,results:i,status:a?s.CommandStatus.SUCCESS:s.CommandStatus.FAILED,message:a?"Success":"Failed",watch:c.stop()}}{const t=new Map,i=e.getStacks();let o=!1,u=!1;for(let l=0;l<i.length;l++){const d=i[l],f=d.getDependencies().map(e=>Promise.resolve(t.get(e)));if(o||u){t.set(d.getPath(),{status:s.CommandStatus.CANCELLED,watch:new a.StopWatch("launch").stop(),stack:d,success:!1,events:[],message:"Cancelled",reason:"CANCELLED"});continue}const h=yield r.launchStack(c,e,n,d,f);h.status===s.CommandStatus.CANCELLED&&(o=!0),h.status===s.CommandStatus.FAILED&&(u=!0),t.set(d.getPath(),h)}const l=Array.from(t.values()),d=void 0===l.find(e=>!e.success);return{success:d,results:l,status:d?s.CommandStatus.SUCCESS:s.CommandStatus.FAILED,message:d?"Success":"Failed",watch:c.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(30),o=n(40);t.launchStack=(e,t,n,s,r)=>i(void 0,void 0,void 0,(function*(){const i=n.childLogger(s.getPath()),c=new a.CloudFormationClient({logger:i,region:s.getRegion(),credentialProvider:s.getCredentialProvider()});i.debug("Launch stack"),i.debugObject("Stack config:",s);const u={ctx:t,stack:s,dependencies:r,cloudFormationClient:c,io:n,logger:i,watch:e.startChild(s.getPath()),variables:t.getVariables()};return o.waitForDependenciesToComplete(u)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(27),o=n(58),s=n(41),r=n(0);t.resolveStackLaunchType=e=>{switch(e){case"CREATE_COMPLETE":case"UPDATE_COMPLETE":case"UPDATE_ROLLBACK_COMPLETE":return a.StackLaunchType.UPDATE;case"CREATE_FAILED":case"ROLLBACK_COMPLETE":case"REVIEW_IN_PROGRESS":return a.StackLaunchType.CREATE;default:throw new Error(`Unsupported stack status: ${e}`)}},t.describeExistingCloudFormationStack=e=>i(void 0,void 0,void 0,(function*(){const{stack:n,cloudFormationClient:i,watch:c,logger:u}=e,l=c.startChild("describe-existing-stack");u.debug("Describe existing stack");try{const r=yield i.describeStack(n.getName());if(r){const{StackId:n,StackStatus:i}=r;return u.debugObject("Found existing stack:",{stackId:n,status:i}),l.stop(),o.validateCloudFormationStackStatus(Object.assign(Object.assign({},e),{launchType:t.resolveStackLaunchType(i),current:{stackId:n,status:i}}))}return u.debug("Stack does not exists"),s.executeBeforeLaunchHooks(Object.assign(Object.assign({},e),{launchType:a.StackLaunchType.CREATE}))}catch(e){return u.error("An error occurred while describing existing stack",e),{stack:n,message:e.message,reason:"DESCRIBE_STACK_FAILED",status:r.CommandStatus.FAILED,events:[],success:!1,watch:c.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.executeHooks=(e,t,n,a,o,s,r=null)=>i(void 0,void 0,void 0,(function*(){s.debug(`About to execute hooks (operation: ${a}, stage: ${o}, status: ${r})`);const i={ctx:e,variables:t,stage:o,operation:a,status:r},c=n.filter(e=>e.match(i));s.debug(`Found ${c.length} matching hook(s)`);for(const e of c){s.debug(`Execute hook (name: ${e.config.name}, type: ${e.config.type})`);try{const t=yield e.execute(i);if(s.debug(`Hook (name: ${e.config.name}, type: ${e.config.type}) executed with success: ${t.success}, message: ${t.message}`),!t.success)return t}catch(t){return s.error(`An error occurred while executing hook (name: ${e.config.name}, type: ${e.config.type})`,t),{message:t.message,success:!1}}}return{message:"Success",success:!0}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(58),s=n(118),r=n(0),c=a(n(13)),u=n(3),l=n(8),d=n(17);t.uploadTemplate=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,templateBody:n,io:i,watch:a,logger:c}=e,u=a.startChild("upload-template"),l=t.getTemplateBucket();if(!l)return c.debug("No template bucket configured"),u.stop(),o.validateTemplate(Object.assign(Object.assign({},e),{templateS3Url:null}));const d=`${l.keyPrefix||""}${t.getName()}-${Date.now()}.yml`,f=`https://s3.amazonaws.com/${l.name}/${d}`;c.debugObject("Template bucket configured:",l);const h=new s.S3Client({credentialProvider:t.getCredentialProvider(),region:t.getRegion(),logger:i});c.debug(`Upload template to: ${f}`);try{return yield h.putObject(l.name,d,n),u.stop(),o.validateTemplate(Object.assign(Object.assign({},e),{templateS3Url:f}))}catch(e){return c.error("Failed to upload template to S3",e),{stack:t,message:e.message,reason:"TEMPLATE_UPLOAD_FAILED",status:r.CommandStatus.FAILED,events:[],success:!1,watch:a.stop()}}})),t.prepareCloudFormationTemplate=e=>i(void 0,void 0,void 0,(function*(){const{ctx:n,stack:i,watch:a,variables:o,logger:s}=e;s.debug("Prepare CloudFormation template");const f=a.startChild("prepare-template"),h=Object.assign(Object.assign({},o),{stack:{project:i.getProject(),path:i.getPath(),name:i.getName(),template:i.getTemplate(),templateBucket:i.getTemplateBucket(),commandRole:i.getCommandRole(),region:i.getRegion(),tags:i.getTags(),timeout:i.getTimeout(),depends:i.getDependencies(),data:i.getData()}}),m=c.default.join(n.getOptions().getProjectDir(),u.TEMPLATES_DIR,i.getTemplate());s.debug(`Path to CloudFormation template: ${m}`);try{const i=yield l.readFileContents(m);if(s.traceText("Raw template body:",i),!m.endsWith(".hbs"))return f.stop(),yield t.uploadTemplate(Object.assign(Object.assign({},e),{templateBody:i}));s.traceObject("Render template using variables:",h);const a=yield d.renderTemplate(n.getTemplateEngine(),m,i,h);return s.traceText("Final rendered template:",a),f.stop(),t.uploadTemplate(Object.assign(Object.assign({},e),{templateBody:a}))}catch(e){return s.error("Failed to prepare template",e),{stack:i,message:e.message,reason:"PREPARE_TEMPLATE_FAILED",status:r.CommandStatus.FAILED,events:[],success:!1,watch:a.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(21),o=n(31);class s extends o.AwsClient{constructor(e){super(e),this.getClient=(e,t)=>new a.S3(Object.assign(Object.assign({},this.clientOptions()),{credentials:e,region:t})),this.putObject=(e,t,n)=>i(this,void 0,void 0,(function*(){return this.withClientPromise(i=>i.putObject({Bucket:e,Key:t,Body:n}),()=>!0)}))}}t.S3Client=s},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(6),s=n(0),r=a(n(26)),c=n(40);t.initiateFailedCloudFormationStackDeletion=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,stack:n,current:i,cloudFormationClient:a,io:u,watch:l,logger:d}=e;if(d.debug("Previous attempt to create the stack has failed and stack needs to be re-created"),!t.getOptions().isAutoConfirmEnabled()&&(yield u.confirmDeleteOfFailedStack(n))!==o.ConfirmResult.YES)return d.debug("Deletion of failed stack cancelled"),{stack:n,message:"Launch cancelled",reason:"CANCELLED",status:s.CommandStatus.FAILED,events:[],success:!1,watch:l.stop()};const f=l.startChild("initiate-failed-stack-deletion"),h=r.default.v4();try{return d.debug(`Initiate stack deletion with client token ${h}`),yield a.initiateStackDeletion({StackName:i.stackId,ClientRequestToken:h}),d.debug("Stack deletion initiated successfully"),f.stop(),yield c.waitStackDeletionToComplete(Object.assign({clientToken:h},e))}catch(e){return d.error("Failed to initiate deletion of stack",e),{stack:n,message:"Initiate stack deletion failed",reason:"INITIATE_DELETE_STACK_FAILED",status:s.CommandStatus.FAILED,events:[],success:!1,watch:l.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(121),o=n(0);t.prepareParameters=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,ctx:n,io:s,watch:r,logger:c}=e,u=n.getOptions().isConfidentialInfoLoggingEnabled(),l=r.startChild("prepare-parameters");c.debug("Prepare parameters");try{const o=yield Promise.all(Array.from(t.getParameters().entries()).map(([e,a])=>i(void 0,void 0,void 0,(function*(){const i=yield a.resolve({ctx:n,stack:t,parameterName:e,listParameterIndex:0,logger:n.getLogger().childLogger(t.getPath())}),o=((e,t,n)=>t?n?e:"<concealed>":e)(i,a.isConfidential(),u);s.debugObject("Parameter:",{name:e,value:o,resolver:a.getName(),confidential:a.isConfidential()});const r=Array.isArray(i)?i.map(e=>`${e}`).join(","):`${i}`;return{UsePreviousValue:!1,ParameterKey:e,ParameterValue:r}}))));return l.stop(),a.prepareTags(Object.assign(Object.assign({},e),{parameters:o}))}catch(e){return c.error("Failed to prepare parameters",e),{stack:t,message:e.message,reason:"PREPARE_PARAMETERS_FAILED",status:o.CommandStatus.FAILED,events:[],success:!1,watch:r.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(60),o=n(122);t.prepareTags=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,watch:n,ctx:i,logger:s}=e,r=n.startChild("prepare-tags");s.debug("Prepare tags");const c=Array.from(t.getTags().entries()).map(([e,t])=>(s.debugObject("Tag:",{key:e,value:t}),{Key:e,Value:t}));return r.stop(),i.getOptions().isAutoConfirmEnabled()?a.createOrUpdateStack(Object.assign(Object.assign({},e),{tags:c})):o.reviewChanges(Object.assign(Object.assign({},e),{tags:c}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(6),s=n(27),r=a(n(26)),c=n(29),u=n(0),l=n(60);t.resolveChangeSetType=e=>{switch(e){case s.StackLaunchType.UPDATE:return"UPDATE";case s.StackLaunchType.CREATE:return"CREATE";default:throw new Error(`Unsupported stack launch type: ${e}`)}},t.reviewChanges=e=>i(void 0,void 0,void 0,(function*(){const{ctx:n,stack:i,launchType:a,templateS3Url:s,templateBody:d,parameters:f,tags:h,cloudFormationClient:m,io:p,watch:g,logger:v}=e,y=g.startChild("review-changes"),C=r.default.v4(),w=`change-${C}`,P=t.resolveChangeSetType(a),_=s||d,S=s?"TemplateURL":"TemplateBody";v.debugObject("Create change set:",{clientToken:C,name:w,type:P});try{const t=yield m.createChangeSet({StackName:i.getName(),ChangeSetType:P,[S]:_,ChangeSetName:w,Capabilities:i.getCapabilities()||c.defaultCapabilities,Parameters:f,Tags:h});v.debug(`Change set created successfully with id ${t}`);const a=yield m.waitUntilChangeSetIsReady(i.getName(),w);return a?(v.debug("Change set contains changes"),n.getOptions().isAutoConfirmEnabled()||(yield p.confirmStackLaunch(i,a,d,m))===o.ConfirmResult.YES?("CREATE"===P?(v.debug("Initiate deletion of the created temporary stack"),yield m.initiateStackDeletion({StackName:i.getName()}),yield m.waitUntilStackIsDeleted(i.getName(),a.StackId,r.default.v4()),v.debug("Temporary stack deleted successfully")):(v.debug("Delete change set"),yield m.deleteChangeSet(i.getName(),w)),y.stop(),l.createOrUpdateStack(e)):("CREATE"===P?(v.debug("Initiate deletion of the created temporary stack"),yield m.initiateStackDeletion({StackName:i.getName()}),yield m.waitUntilStackIsDeleted(i.getName(),a.StackId,r.default.v4()),v.debug("Temporary stack deleted successfully")):(v.debug("Delete change set"),yield m.deleteChangeSet(i.getName(),w)),{stack:i,message:"Launch cancelled",reason:"CANCELLED",status:u.CommandStatus.CANCELLED,events:[],success:!1,watch:g.stop()})):(v.debug("Change set contains no changes"),{stack:i,message:"No changes",reason:"SKIPPED",status:u.CommandStatus.SKIPPED,events:[],success:!0,watch:g.stop()})}catch(e){return v.error("Failed to create change set",e),{stack:i,message:"Create change set failed",reason:"CREATE_CHANGE_SET_FAILED",status:u.CommandStatus.FAILED,events:[],success:!1,watch:g.stop()}}}))},function(e,t){e.exports=require("inquirer")},function(e,t){e.exports=require("diff")},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(3),s=n(43),r=i(n(45));t.default={command:"delete [commandPath]",desc:"Delete stacks within the given command path",builder:{commandPath:{default:o.ROOT_STACK_GROUP_PATH},ignoreDependencies:{default:!1}},handler:e=>a.handle(e,t=>Object.assign(Object.assign({},t),{ignoreDependencies:!1,commandPath:e.commandPath}),e=>s.deleteStacksCommand(e,new r.default(e.options)))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),s=n(15),r=a(n(4)),c=n(7),u=n(127),l=r.default.object({commandPath:c.commandPath.required()}).unknown(!0);t.deleteStacksCommand=(e,t,n=null)=>i(void 0,void 0,void 0,(function*(){return o.validateInput(l,e).then(e=>s.buildConfigContext(e.options,e.variables,t,n)).then(t=>s.prepareDeleteContext(t,e.commandPath)).then(n=>u.executeDeleteContext(n,e,t)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(6),o=n(0),s=n(44);t.executeDeleteContext=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const i=e.getOptions().isAutoConfirmEnabled(),r=e.getStacks(),{watch:c}=t;if(!i&&(yield n.confirmDelete(e))!==a.ConfirmResult.YES)return n.info("Deletion cancelled"),{success:!0,status:o.CommandStatus.CANCELLED,message:"Cancelled",results:[],watch:c.stop()};n.debugObject(`Delete ${r.length} stack(s) in following order:`,r.map(e=>e.getPath()));const u=r.reduce((t,i)=>{const a=i.getDependants().map(e=>t.get(e)),o=s.deleteStack(c,e,n,i,a);return t.set(i.getPath(),o),t},new Map),l=yield Promise.all(Array.from(u.values())),d=void 0===l.find(e=>!e.success);return{success:d,results:l,status:d?o.CommandStatus.SUCCESS:o.CommandStatus.FAILED,message:d?"Success":"Failed",watch:c.stop()}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(44),s=n(61);t.waitForDependantsToComplete=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,dependants:n,watch:i,logger:s}=e,r=i.startChild("wait-dependants");s.debug(`Wait ${n.length} dependants to complete`);try{if(!(void 0===(yield Promise.all(n)).find(e=>!e.success)))return s.warn("Some dependants failed"),{stack:t,message:"Dependants failed",reason:"DEPENDANTS_FAILED",status:a.CommandStatus.CANCELLED,events:[],success:!1,watch:i.stop()};s.debug("Dependants completed successfully")}catch(e){return s.error("An error occurred while waiting dependants to complete",e),{stack:t,message:e.message,reason:"DEPENDANTS_FAILED",status:a.CommandStatus.FAILED,events:[],success:!1,watch:i.stop()}}return r.stop(),o.deleteSecrets(e)})),t.waitCloudFormationStackDeletionToComplete=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,current:n,cloudFormationClient:i,io:o,watch:r,clientToken:c}=e,u=r.startChild("wait-deletion-to-complete");o.debug(`${t.getPath()} -Wait for stack delete to complete`);try{const{events:l,stackStatus:d}=yield i.waitUntilStackIsDeleted(t.getName(),n.stackId,c,e=>o.printStackEvent(t.getPath(),e));o.debug(`${t.getPath()} -Stack delete completed with status ${d}`);const f="DELETE_COMPLETE"===d,h=f?"DELETE_SUCCESS":"DELETE_FAILED",m=f?"Success":"Failed",p=f?a.CommandStatus.SUCCESS:a.CommandStatus.FAILED,g={stack:t,message:m,status:p,reason:h,events:l,success:f,watch:r};return u.stop(),s.executeAfterDeleteHooks(Object.assign(Object.assign({},e),{result:g}))}catch(e){return o.error(`${t.getPath()} -An error occurred while waiting for stack deletion to complete`,e),{stack:t,message:"Stack deletion failed",reason:"DELETE_STACK_FAILED",status:a.CommandStatus.FAILED,events:[],success:!1,watch:r.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(130);t.describeExistingCloudFormationStack=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,cloudFormationClient:n,watch:i,logger:s}=e,r=i.startChild("describe-stack");s.debug("Describe existing stack");try{const c=yield n.describeStack(t.getName());if(!c)return s.debug("No existing stack found"),{stack:t,message:"Stack not found",reason:"DELETE_SKIPPED",status:a.CommandStatus.SKIPPED,events:[],success:!0,watch:i.stop()};const{StackId:u,StackStatus:l}=c;return s.debugObject("Found existing stack:",{stackId:u,status:l}),r.stop(),o.validateCloudFormationStackStatus(Object.assign(Object.assign({},e),{current:{stackId:u,status:l}}))}catch(e){return s.error("An error occurred while describing the existing stack",e),{stack:t,message:e.message,reason:"DESCRIBE_STACK_FAILED",status:a.CommandStatus.FAILED,events:[],success:!1,watch:i.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(61);t.validateCloudFormationStackStatus=e=>i(void 0,void 0,void 0,(function*(){const{stack:t,current:n,watch:i,logger:s}=e,r=i.startChild("validate-stack-status");s.debug("Validate stack status");return["ROLLBACK_COMPLETE","CREATE_FAILED","DELETE_FAILED","CREATE_COMPLETE","ROLLBACK_FAILED","UPDATE_COMPLETE","UPDATE_ROLLBACK_COMPLETE","REVIEW_IN_PROGRESS"].includes(n.status)?(r.stop(),s.debug(`Stack status ${n.status} is valid`),o.executeBeforeDeleteHooks(e)):(s.warn(`Stack status ${n.status} is not valid`),{stack:t,message:`Invalid stack status ${n.status}`,reason:"CHECK_STACK_STATUS_FAILED",status:a.CommandStatus.FAILED,events:[],success:!1,watch:i.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(132)),o=i(n(137)),s=i(n(142)),r=i(n(147)),c=i(n(152));t.default={command:"secrets <command>",desc:"Manage secrets",builder:e=>e.command(a.default).command(o.default).command(s.default).command(r.default).command(c.default),handler:e=>{}}},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(133),s=i(n(136));t.default={command:"get <stackPath> <secretName>",desc:"Get stack secret value by name",builder:{},handler:e=>a.handle(e,t=>Object.assign(Object.assign({},t),{stackPath:e.stackPath,secretName:e.secretName}),e=>o.getSecretCommand(e,new s.default(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(134);t.getSecretCommand=i.getSecretCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),s=n(15),r=n(2),c=n(135),u=a(n(4)),l=n(32),d=n(7),f=u.default.object({stackPath:d.stackPath.required(),secretName:l.secretName.required()}).unknown(!0);t.getSecretCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return o.validateInput(f,e).then(e=>s.buildConfigContext(e.options,e.variables,t)).then(t=>s.prepareLaunchContext(t,e.stackPath)).then(t=>c.getSecretValue(t,e.stackPath,e.secretName)).then(e=>({success:!0,message:"Success",value:e,status:o.CommandStatus.SUCCESS,watch:new r.StopWatch("total").stop()})).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1),o=n(18);t.getSecretValue=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const[i,...s]=e.getStacksByPath(t);if(!i)throw new a.BaubleError(`Stack not found with command path: ${t}`);if(s.length>0)throw new a.BaubleError(`More than one stack found with command path: ${t}`);const r=i.getSecrets().get(n);if(!r)throw new a.BaubleError(`Stack ${i.getPath()} does not contain secret: ${n}`);return new o.SSMClient({region:i.getRegion(),credentialProvider:i.getCredentialProvider(),logger:e.getLogger()}).getEncryptedParameter(r.ssmParameterName)}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(28));class o extends a.default{constructor(e){super(e),this.printOutput=e=>(this.message(e.value),e)}}t.default=o},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(138),s=i(n(141));t.default={command:"set <stackPath> <secretName>",desc:"Set stack secret value by name",builder:{},handler:e=>a.handle(e,t=>Object.assign(Object.assign({},t),{stackPath:e.stackPath,secretName:e.secretName}),e=>o.setSecretCommand(e,new s.default(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(139);t.setSecretCommand=i.setSecretCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(4)),s=n(0),r=n(15),c=n(32),u=n(140),l=n(7),d=o.default.object({stackPath:l.stackPath.required(),secretName:c.secretName.required()}).unknown(!0);t.setSecretCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return s.validateInput(d,e).then(e=>r.buildConfigContext(e.options,e.variables,t)).then(t=>r.prepareLaunchContext(t,e.stackPath)).then(n=>u.setSecretValue(n,e,t)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1),o=n(18),s=n(0);t.setSecretValue=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const i=t.watch,[r,...c]=e.getStacksByPath(t.stackPath);if(!r)throw new a.BaubleError(`Stack not found with stack path: ${t.stackPath}`);if(c.length>0)throw new a.BaubleError(`More than one stack found with stack path: ${t.stackPath}`);const{secretName:u}=t,l=r.getSecrets().get(u);if(!l)throw new a.BaubleError(`Stack ${r.getPath()} does not contain secret: ${u}`);const d=yield n.promptSecretValue(l),f=new o.SSMClient({credentialProvider:r.getCredentialProvider(),region:r.getRegion(),logger:e.getLogger()});return yield f.putEncryptedParameter(l.ssmParameterName,d,l.description),{success:!0,message:"Success",status:s.CommandStatus.SUCCESS,watch:i.stop()}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(28));class s extends o.default{constructor(e){super(e),this.promptSecretValue=e=>i(this,void 0,void 0,(function*(){return this.printSecret(e,o.SecretOperation.ADD),this.question("Enter value",!0)})),this.printOutput=e=>(this.message(e.success),e)}}t.default=s},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(3),s=n(143),r=i(n(146));t.default={command:"list [commandPath]",desc:"List stack secrets within the given command path",builder:{commandPath:{default:o.ROOT_STACK_GROUP_PATH}},handler:e=>a.handle(e,t=>Object.assign(Object.assign({},t),{commandPath:e.commandPath}),e=>s.listSecretsCommand(e,new r.default(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(144);t.listSecretsCommand=i.listSecretsCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),s=n(15),r=n(145),c=a(n(4)),u=n(7),l=c.default.object({commandPath:u.commandPath.required()}).unknown(!0);t.listSecretsCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return o.validateInput(l,e).then(e=>s.buildConfigContext(e.options,e.variables,t)).then(t=>s.prepareLaunchContext(t,e.commandPath)).then(r.listSecrets).then(t=>({success:!0,message:"Success",stacks:t,status:o.CommandStatus.SUCCESS,watch:e.watch.stop()})).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(18);t.listSecrets=e=>i(void 0,void 0,void 0,(function*(){return Promise.all(e.getStacks().map(t=>i(void 0,void 0,void 0,(function*(){if(0===t.getSecrets().size)return{stack:t,secrets:[]};const n=new a.SSMClient({region:t.getRegion(),credentialProvider:t.getCredentialProvider(),logger:e.getLogger()}),o=yield Promise.all(Array.from(t.getSecrets().entries()).map(e=>i(void 0,void 0,void 0,(function*(){const[t,i]=e,a=yield n.getEncryptedParameter(i.ssmParameterName);return{name:t,ssmParameterName:i.ssmParameterName,description:i.description,value:a}}))));return{stack:t,secrets:o}}))))}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(28));class o extends a.default{constructor(e){super(e),this.printOutput=e=>(e.stacks.forEach(e=>{0!==e.secrets.length&&(this.message(e.stack.getPath(),!0),e.secrets.forEach(e=>this.printSecret(e)))}),e)}}t.default=o},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(3),s=n(148),r=i(n(151));t.default={command:"diff [commandPath]",desc:"Show differences between the locally configured secrets and the ones in parameter store",builder:{path:{default:o.ROOT_STACK_GROUP_PATH}},handler:e=>a.handle(e,t=>Object.assign(Object.assign({},t),{commandPath:e.commandPath}),e=>s.diffSecretsCommand(e,new r.default(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(149);t.diffSecretsCommand=i.diffSecretsCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),s=n(15),r=a(n(4)),c=n(7),u=n(150),l=r.default.object({commandPath:c.commandPath.required()}).unknown(!0);t.diffSecretsCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return o.validateInput(l,e).then(e=>s.buildConfigContext(e.options,e.variables,t)).then(t=>s.prepareLaunchContext(t,e.commandPath)).then(u.diffSecrets).then(t=>({success:!0,message:"Success",stacks:t,status:o.CommandStatus.SUCCESS,watch:e.watch.stop()})).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(18);t.diffSecrets=e=>i(void 0,void 0,void 0,(function*(){return(yield Promise.all(e.getStacks().map(t=>i(void 0,void 0,void 0,(function*(){const n=new a.SSMClient({credentialProvider:t.getCredentialProvider(),region:t.getRegion(),logger:e.getLogger()}),o=yield n.getEncryptedParametersByPath(t.getSecretsPath()),s=o.map(e=>e.Name);if(0===t.getSecrets().size&&0===o.length)return{stack:t,add:[],remove:[]};const r=Array.from(t.getSecrets().values()).filter(e=>!s.includes(e.ssmParameterName)),c=yield Promise.all(o.filter(e=>!Array.from(t.getSecrets().values()).map(e=>e.ssmParameterName).includes(e.Name)).map(e=>i(void 0,void 0,void 0,(function*(){return{name:e.Name.split("/").reverse()[0],ssmParameterName:e.Name,description:yield n.getParameterDescription(e.Name)}}))));return{stack:t,add:r,remove:c}}))))).filter(e=>e.add.length+e.remove.length>0)}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(28));class o extends a.default{constructor(e){super(e),this.printOutput=e=>0===e.stacks.length?(this.message("All secrets in sync",!0,!0),e):(this.message("Found secrets to sync",!0),this.printSecretsDiff(e.stacks),e)}}t.default=o},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(3),s=n(153),r=i(n(156));t.default={command:"sync [commandPath]",desc:"Sync stack secrets within the given command path",builder:{commandPath:{default:o.ROOT_STACK_GROUP_PATH}},handler:e=>a.handle(e,t=>Object.assign(Object.assign({},t),{commandPath:e.commandPath}),e=>s.syncSecretsCommand(e,new r.default(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(154);t.syncSecretsCommand=i.syncSecretsCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),s=n(15),r=a(n(4)),c=n(7),u=n(155),l=r.default.object({commandPath:c.commandPath.required()}).unknown(!0);t.syncSecretsCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return o.validateInput(l,e).then(e=>s.buildConfigContext(e.options,e.variables,t)).then(t=>s.prepareLaunchContext(t,e.commandPath)).then(n=>u.syncSecrets(n,e,t)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(18),o=n(0);t.syncSecrets=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const s=t.watch,r=t.options.isAutoConfirmEnabled(),c=(yield Promise.all(e.getStacks().map(e=>i(void 0,void 0,void 0,(function*(){const t=new a.SSMClient({credentialProvider:e.getCredentialProvider(),region:e.getRegion(),logger:n}),o=yield t.getEncryptedParametersByPath(e.getSecretsPath()),s=o.map(e=>e.Name);if(0===e.getSecrets().size&&0===o.length)return{stack:e,add:[],remove:[]};const r=Array.from(e.getSecrets().values()).filter(e=>!s.includes(e.ssmParameterName)).map(e=>({name:e.name,ssmParameterName:e.ssmParameterName,description:e.description})),c=yield Promise.all(o.filter(t=>!Array.from(e.getSecrets().values()).map(e=>e.ssmParameterName).includes(t.Name)).map(e=>i(void 0,void 0,void 0,(function*(){return{name:e.Name.split("/").reverse()[0],ssmParameterName:e.Name,description:yield t.getParameterDescription(e.Name)}}))));return{stack:e,add:r,remove:c}}))))).filter(e=>e.add.length+e.remove.length>0);if(0===c.length)return{success:!0,stacks:[],message:"Success",status:o.CommandStatus.SUCCESS,watch:s};if(!r&&!n.confirmSync(c))return{success:!0,message:"Cancelled",stacks:[],status:o.CommandStatus.CANCELLED,watch:s.stop()};yield Promise.all(c.map(e=>i(void 0,void 0,void 0,(function*(){const t=new a.SSMClient({credentialProvider:e.stack.getCredentialProvider(),region:e.stack.getRegion(),logger:n}),i=e.remove.map(e=>e.ssmParameterName);return i.length>0&&(yield t.deleteParameters(i)),!0}))));for(const t of c){if(0===t.add.length)break;n.info(`${t.stack.getPath()}`),n.info();const i=new a.SSMClient({credentialProvider:t.stack.getCredentialProvider(),region:t.stack.getRegion(),logger:e.getLogger()});for(const e of t.add){const t=yield n.promptSecretValue(e);yield i.putEncryptedParameter(e.ssmParameterName,t,e.description)}}return{success:!0,message:"Success",stacks:c,status:o.CommandStatus.SUCCESS,watch:s.stop()}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(28));class s extends o.default{constructor(e){super(e),this.printOutput=e=>(this.message(e.success),e),this.promptSecretValue=e=>i(this,void 0,void 0,(function*(){return this.printSecret(e,o.SecretOperation.ADD),this.question("Enter value",!0)})),this.confirmSync=e=>i(this,void 0,void 0,(function*(){return this.message("Found secrets to sync",!0),this.printSecretsDiff(e),this.longMessage(["The secrets that are found from the AWS parameter store but not","from the local stack configurations will be removed.","","You will need to provide values for the secrets found from","the local stack configurations but not from the AWS parameter store."],!0,!0),this.confirm("Continue sync?")}))}}t.default=s},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(158)),o=i(n(193)),s=i(n(209)),r=i(n(214)),c=i(n(219));t.default={command:"org <command>",desc:"Manage organization",builder:e=>e.command(o.default).command(s.default).command(r.default).command(a.default).command(c.default),handler:e=>{}}},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(159)),o=i(n(168)),s=i(n(173)),r=i(n(191));t.default={command:"accounts <command>",desc:"Manage accounts",builder:e=>e.command(a.default).command(o.default).command(s.default).command(r.default),handler:e=>{}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(5),a=n(160),o=n(161);t.default={command:"list",desc:"List accounts",builder:{},handler:e=>i.handle(e,e=>e,e=>o.listAccountsCommand(e,new a.CliListAccountsIO(e.options)))}},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(9)),o=i(n(11)),s=i(n(51)),r=n(14);class c extends a.default{constructor(e){super(e),this.printOutput=e=>{const t=new o.default;return e.accounts.forEach(e=>{t.cell("Id",e.Id),t.cell("Name",e.Name),t.cell("Email",e.Email),t.cell("Status",r.formatAccountStatus(e.Status)),t.cell("Joined",s.default.format(e.JoinedTimestamp,"YYYY-MM-DD HH:mm:ss Z")),t.newRow()}),this.message(t.toString(),!0),e}}}t.CliListAccountsIO=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(162);t.listAccountsCommand=i.listAccountsCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(4)),s=n(0),r=n(22),c=n(2),u=n(167),l=o.default.object({}).unknown(!0);t.listAccountsCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return s.validateInput(l,e).then(({options:e,variables:n})=>r.buildOrganizationContext(e,n,t)).then(e=>u.listAccounts(e)).then(({accounts:e,masterAccountId:t})=>({accounts:e,masterAccountId:t,success:!0,message:"Success",status:s.CommandStatus.SUCCESS,watch:new c.StopWatch("total").stop()})).then(t.printOutput)}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(1);class a extends i.BaubleError{constructor(e){super(`The organization has ${e.length} active account(s) that are not found from the local configuration:\n\n${e.map(e=>`  - id: ${e.Id}, email: ${e.Email}, name: ${e.Name}`).join("\n")}`,{info:"All active organization accounts need to be present in the local configuration.",instructions:["Add missing accounts under the appropriate organizational units."]})}}t.AccountsMissingFromLocalConfigError=a;class o extends i.BaubleError{constructor(e){super(`The local configuration contains ${e.length} account id(s) that refer to suspended accounts but are not marked as suspended:\n\n${e.map(e=>`  - ${e}`).join("\n")}`,{info:"All suspended accounts must be marked as suspended in the local configuration.",instructions:["Mark the suspended accounts in the local configuration with 'suspended: true'"]})}}t.SuspendedAccountsInLocalConfigError=o;class s extends i.BaubleError{constructor(e){super(`The local configuration contains ${e.length} account id(s) that refer to accounts not found from the organization:\n\n${e.map(e=>`  - ${e}`).join("\n")}`,{info:"The local configuration must contain only accounts that are found from the organization.",instructions:["Remove unknown accounts from the local configuration."]})}}t.NonExistingAccountsInLocalConfigError=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(165);t.parseOrganizationConfigFile=i.parseOrganizationConfigFile},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(33),s=n(1),r=n(3),c=a(n(16)),u=n(39),l=n(17),d=n(8),f=n(24),h=n(47),m=n(63),p=e=>{switch(e){case"active":return o.OrganizationAccountStatus.ACTIVE;case"disabled":return o.OrganizationAccountStatus.DISABLED;case"suspended":return o.OrganizationAccountStatus.SUSPENDED;default:return o.OrganizationAccountStatus.ACTIVE}},g=e=>{switch(e){case"active":return o.OrganizationalUnitStatus.ACTIVE;case"disabled":return o.OrganizationalUnitStatus.DISABLED;default:return o.OrganizationalUnitStatus.ACTIVE}},v=(e,t,n,i)=>null==e?[]:e.map(e=>((e,t,n,i)=>{if("string"==typeof e)return{configSets:t,id:`${e}`,name:null,email:null,description:null,vars:{},accountAdminRoleName:null,status:o.OrganizationAccountStatus.ACTIVE,tagPolicies:i,serviceControlPolicies:n};const a=e.configSets||[],s=c.default([...t,...a]),r=e.serviceControlPolicies||[],l=c.default([...n,...r]),d=e.tagPolicies||[];return{configSets:s,tagPolicies:c.default([...i,...d]),serviceControlPolicies:l,id:`${e.id}`,name:e.name||null,email:e.email||null,description:e.description||null,vars:u.parseVars(e.vars),accountAdminRoleName:e.accountAdminRoleName||null,status:p(e.status)}})(e,t,n,i)),y=e=>e?Object.keys(e).map(t=>({name:t,description:e[t].description,awsManaged:!0===e[t].awsManaged})):[],C=(e,t)=>null==t?{policyType:e,enabled:!1,policies:[]}:"boolean"==typeof t?{policyType:e,enabled:t,policies:[]}:{policyType:e,enabled:!0,policies:y(t)},w=e=>null==e?[]:"string"==typeof e?[e]:e,P=(e,t,n,i,a)=>{const o=t[e],s=e.split("/").length,r=Object.keys(t).filter(t=>t.startsWith(`${e}/`)),l=r.filter(e=>e.split("/").length===s+1),d=c.default(r.filter(e=>e.split("/").length>=s+2).map(e=>e.split("/").slice(0,s+1).join("/"))),f=w(null==o?void 0:o.serviceControlPolicies),h=w(null==o?void 0:o.tagPolicies),m=c.default([...n,...f]),p=c.default([...i,...h]),y=null==(C=null==o?void 0:o.configSets)?[]:"string"==typeof C?[C]:C;var C;const _=c.default([...a,...y]),S=[...d,...l].map(e=>P(e,t,m,p,_)),b=v(null==o?void 0:o.accounts,_,m,p);return{name:e.split("/").reverse()[0],children:S,accounts:b,serviceControlPolicies:m,tagPolicies:p,configSets:_,path:e,description:(null==o?void 0:o.description)||null,priority:(null==o?void 0:o.priority)||0,accountAdminRoleName:(null==o?void 0:o.accountAdminRoleName)||null,vars:u.parseVars(null==o?void 0:o.vars),status:g(null==o?void 0:o.status)}};t.parseOrganizationConfigFile=(e,t,n,a,o)=>i(void 0,void 0,void 0,(function*(){const i=t.isConfidentialInfoLoggingEnabled(),c=yield d.readFileContents(a),p=i?e=>e:e=>Object.assign(Object.assign({},e),{env:"<concealed>"});e.traceText("Raw organization config file:",c),e.traceObject("Render organization config file using variables:",n,p);const g=yield l.renderTemplate(o,a,c,n);e.traceText("Final rendered organization config file:",g);const v=(yield f.parseYaml(g))||{},{error:y}=h.organizationConfigFileSchema.validate(v,{abortEarly:!1});if(y){const e=y.details.map(e=>`  - ${e.message}`).join("\n");throw new s.BaubleError(`${y.details.length} validation error(s) in organization config file ${a}:\n\n${e}`)}const w=(e=>{if(null==e)return{defaults:{roleName:r.DEFAULT_ORGANIZATION_ROLE_NAME,iamUserAccessToBilling:!0},constraints:{emailPattern:null,namePattern:null}};const t=u.parseRegex("accountCreation.constraints.emailPattern",e.emailPattern),n=u.parseRegex("accountCreation.constraints.namePattern",e.namePattern);return{defaults:{roleName:e.accountAdminRoleName||r.DEFAULT_ORGANIZATION_ROLE_NAME,iamUserAccessToBilling:!1!==e.iamUserAccessToBilling},constraints:{emailPattern:t,namePattern:n}}})(v.accountCreation),_=m.parseConfigSets(v.configSets),S=C(r.SERVICE_CONTROL_POLICY_TYPE,v.serviceControlPolicies),b=C(r.TAG_POLICY_TYPE,v.tagPolicies),O=u.parseVars(v.vars);var E;return{accountCreation:w,configSets:_,serviceControlPolicies:S,tagPolicies:b,organizationalUnits:(E=v.organizationalUnits,{Root:P("Root",E,[],[],[])}),vars:O,trustedAwsServices:v.trustedAwsServices||null,organizationAdminRoleName:v.organizationAdminRoleName||null,accountAdminRoleName:v.accountAdminRoleName||null,masterAccountId:`${v.masterAccountId}`}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(48),s=a(n(16)),r=n(39),c=n(17),u=n(8),l=n(24),d=n(64),f=n(1),h=e=>{switch(e){case"active":return o.DeploymentStatus.ACTIVE;case"disabled":return o.DeploymentStatus.DISABLED;default:return o.DeploymentStatus.ACTIVE}};t.parseConfigSets=e=>null==e?[]:Object.keys(e).map(t=>{const{description:n,vars:i,commandPaths:a}=e[t];return{name:t,description:n,vars:i||{},commandPaths:a||[]}});const m=(e,t)=>null==e?[]:e.map(e=>((e,t)=>{const n=e.configSets||[],i=s.default([...t,...n]);return{name:e.name,description:e.description,configSets:i,status:h(e.status),vars:r.parseVars(e.vars)}})(e,t)),p=(e,t,n)=>{const i=t[e],a=e.split("/").length,o=Object.keys(t).filter(t=>t.startsWith(`${e}/`)),c=o.filter(e=>e.split("/").length===a+1),u=s.default(o.filter(e=>e.split("/").length>=a+2).map(e=>e.split("/").slice(0,a+1).join("/"))),l=null==(d=null==i?void 0:i.configSets)?[]:"string"==typeof d?[d]:d;var d;const f=s.default([...n,...l]),g=[...u,...c].map(e=>p(e,t,f)),v=m(null==i?void 0:i.targets,f);return{name:e.split("/").reverse()[0],children:g,targets:v,configSets:f,path:e,description:(null==i?void 0:i.description)||null,priority:(null==i?void 0:i.priority)||0,vars:r.parseVars(null==i?void 0:i.vars),status:h(null==i?void 0:i.status)}};t.parseDeploymentConfigFile=(e,n,a,o,s)=>i(void 0,void 0,void 0,(function*(){const i=n.isConfidentialInfoLoggingEnabled(),h=yield u.readFileContents(o),m=i?e=>e:e=>Object.assign(Object.assign({},e),{env:"<concealed>"});e.traceText("Raw deployment groups config file:",h),e.traceObject("Render deployment groups config file using variables:",a,m);const g=yield c.renderTemplate(s,o,h,a);e.traceText("Final rendered deployment groups config file:",g);const v=(yield l.parseYaml(g))||{},{error:y}=d.deploymentGroupsConfigFileSchema.validate(v,{abortEarly:!1});if(y){const e=y.details.map(e=>`  - ${e.message}`).join("\n");throw new f.BaubleError(`${y.details.length} validation error(s) in deployment groups config file ${o}:\n\n${e}`)}var C;return{vars:r.parseVars(v.vars),configSets:t.parseConfigSets(v.configSets),deploymentGroups:null==(C=v.deploymentGroups)?[]:Object.keys(C).map(e=>p(e,C,[]))}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.listAccounts=e=>i(void 0,void 0,void 0,(function*(){const t=e.getOrganizationConfigFile(),n=e.getClient();return{accounts:yield n.listAccounts(),masterAccountId:t.masterAccountId}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(5),a=n(169),o=n(172),s=n(3);t.default={command:"create",desc:"Create account",builder:e=>e.option("name",{description:"Account name",string:!0,global:!1,demandOption:!0}).option("email",{description:"Account email",string:!0,global:!1,demandOption:!0}).option("iam-user-access-to-billing",{description:"Enable IAM users to access account billing information",boolean:!0,global:!1,default:!0}).option("role-name",{description:"Name of the IAM role used to manage the new account",string:!0,global:!1,default:s.DEFAULT_ORGANIZATION_ROLE_NAME}),handler:e=>i.handle(e,t=>Object.assign(Object.assign({},t),{email:e.email,name:e.name,iamUserAccessToBilling:e["iam-user-access-to-billing"],roleName:e["role-name"]}),e=>a.createAccountCommand(e,new o.CliCreateAccountIO(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(170);t.createAccountCommand=i.createAccountCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(4)),s=n(32),r=n(47),c=n(0),u=n(22),l=n(171),d=o.default.object({name:s.accountName,email:s.accountEmail,roleName:r.organizationRoleName,iamUserAccessToBilling:o.default.boolean()}).unknown(!0);t.createAccountCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return c.validateInput(d,e).then(({options:e,variables:n})=>u.buildOrganizationContext(e,n,t)).then(n=>l.createAccount(n,t,e)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1),o=n(6),s=n(0),r=n(2);t.createAccount=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const{name:i,email:c,roleName:u,iamUserAccessToBilling:l,watch:d}=n,f=e.getOptions(),h=e.getOrganizationConfigFile().accountCreation.constraints.emailPattern;if(h&&!h.test(c))throw new a.BaubleError(`Provided email '${c}' does not match with required pattern ${h}`);const m=e.getOrganizationConfigFile().accountCreation.constraints.namePattern;if(m&&!m.test(i))throw new a.BaubleError(`Provided name '${i}' does not match with required pattern ${m}`);if(!f.isAutoConfirmEnabled()&&(yield t.confirmAccountCreation(c,i,l,u))!==o.ConfirmResult.YES)return{success:!1,createAccountStatus:null,status:s.CommandStatus.CANCELLED,message:"Cancelled",watch:new r.StopWatch("total").stop()};const p=e.getClient();t.info("Initiate account creation");const g=yield p.createAccount({AccountName:i,Email:c,IamUserAccessToBilling:l?"ALLOW":"DENY",RoleName:u});t.debug(`Account creation initiated with request id: ${g}`),t.info("Wait account creation to complete...");const v=yield p.waitAccountCreationToComplete(g),y="SUCCEEDED"===v.State;return{createAccountStatus:v,success:y,message:y?"Success":v.FailureReason,status:y?s.CommandStatus.SUCCESS:s.CommandStatus.FAILED,watch:d.stop()}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(9)),s=n(6),r=n(0);class c extends o.default{constructor(e){super(e),this.confirmAccountCreation=(e,t,n,a)=>i(this,void 0,void 0,(function*(){return this.longMessage(["Account information:","",`  name:                        ${e}`,`  email:                       ${t}`,`  role name:                   ${a}`,`  iam user access to billing:  ${n}`],!0),(yield this.confirm("Continue to create the account?",!0))?s.ConfirmResult.YES:s.ConfirmResult.NO})),this.printOutput=e=>{const t=e.createAccountStatus;switch(e.status){case r.CommandStatus.FAILED:t?this.message(`Account creation failed. Reason: ${t.FailureReason}`,!0):this.message("Account creation failed",!0);break;case r.CommandStatus.SUCCESS:const{AccountId:e,AccountName:n}=t;this.longMessage(["Account information:","",`  id:   ${e}`,`  name: ${n}`],!0)}return e}}}t.CliCreateAccountIO=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(5),a=n(65),o=n(190),s=n(23);t.default={command:"deploy [organizationalUnits..]",desc:"Deploy accounts",builder:e=>e.option("account-id",{description:"Account id to deploy",alias:"a",string:!0,global:!1,demandOption:!1}),handler:e=>i.handle(e,t=>{return Object.assign(Object.assign({},t),{organizationalUnits:e.organizationalUnits||[],accountIds:(n=e["account-id"],n?Array.isArray(n)?n:[n]:[]),operation:s.DeploymentOperation.DEPLOY});var n},e=>a.accountsOperationCommand(e,new o.CliDeployAccountsIO(e.options)))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(4)),s=n(47),r=n(7),c=n(0),u=n(22),l=n(175),d=o.default.object({organizationalUnits:o.default.array().items(s.organizationalUnitPath).unique(),accountIds:o.default.array().items(r.accountId).unique()}).unknown(!0);t.accountsOperationCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return c.validateInput(d,e).then(({options:e,variables:n})=>u.buildOrganizationContext(e,n,t)).then(n=>l.deployAccounts(n,t,e)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(1),o=n(176);t.deployAccounts=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const{watch:i,organizationalUnits:s}=n;return s.length>0&&s.forEach(t=>{if(!e.hasOrganizationalUnit(t))throw new a.BaubleError(`Organizational unit '${t}' not found`)}),o.loadData({ctx:e,watch:i,io:t,input:n})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(66),o=n(177);t.loadData=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,io:n,watch:i}=e,s=i.startChild("load-data"),r=yield a.loadOrganizationData(t,n);return s.stop(),o.validateLocalConfiguration(Object.assign(Object.assign({},e),{organizationData:r}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(33),s=a(n(10)),r=n(12),c=a(n(49)),u=n(1),l=n(46),d=n(67),f=n(182);t.validateLocalConfiguration=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,io:n,watch:i,input:{organizationalUnits:a,accountIds:h},organizationData:m}=e,p=i.startChild("validate");if(n.info("Validate configuration"),yield l.validateCommonLocalConfiguration(t,m.currentAccounts),(yield d.planOrganizationLaunch(t,m)).hasChanges)throw new u.BaubleError("Local configuration does not match with the current organization state");return((e,t,n)=>{const i=0===t.length?[e.getOrganizationalUnit("Root")]:t.reduce((t,n)=>[...t,e.getOrganizationalUnit(n)],new Array),a=s.default(i.map(e=>s.default(r.collectFromHierarchy(e,e=>e.children)))),l=c.default(a,e=>e.path).filter(e=>e.status===o.OrganizationalUnitStatus.ACTIVE);if(n.length>0){const e=s.default(l.map(e=>s.default(r.collectFromHierarchy(e,e=>e.children).map(e=>e.accounts.map(e=>e.id)))));n.forEach(t=>{if(!e.includes(t))throw new u.BaubleError(`Account ${t} not found from any organizational unit chosen to be deployed`)})}})(t,a,h),p.stop(),f.planLaunch(e)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(13)),s=n(1),r=n(8),c=n(2),u=n(3),l=n(179);t.planPoliciesByType=(e,t,n,a)=>i(void 0,void 0,void 0,(function*(){var i;const u=new Array;for(const d of t){const t=n.get(d.name);if(d.awsManaged){const n={currentContent:t.Content,currentDescription:t.PolicySummary.Description,id:t.PolicySummary.Id,name:d.name,newContent:"",awsManaged:!0,newDescription:d.description,operation:"skip",type:e};u.push(n);continue}if(t&&(null===(i=t.PolicySummary)||void 0===i?void 0:i.AwsManaged))throw new s.BaubleError(`Local policy '${d.name}' conflicts with an AWS managed policy with the same name`);const f=o.default.join(a,`${d.name}.json`),h=yield r.readFileContents(f),m=l.compactJson(h);if(t){const n=c.checksum(m+d.description)!==c.checksum(t.Content+t.PolicySummary.Description)?"update":"skip",i={currentContent:t.Content,currentDescription:t.PolicySummary.Description,id:t.PolicySummary.Id,name:d.name,awsManaged:!1,newContent:m,newDescription:d.description,operation:n,type:e};u.push(i)}else{const t={currentContent:null,currentDescription:null,id:null,name:d.name,awsManaged:!1,newContent:m,newDescription:d.description,operation:"add",type:e};u.push(t)}}return u})),t.createPoliciesDeploymentPlan=(e,n,a,s,r)=>i(void 0,void 0,void 0,(function*(){const i=new Map(a.map(e=>[e.PolicySummary.Name,e])),c=new Map(s.map(e=>[e.PolicySummary.Name,e])),[l,d]=yield Promise.all([t.planPoliciesByType(u.SERVICE_CONTROL_POLICY_TYPE,e.policies,i,o.default.join(r,"service-control-policies")),t.planPoliciesByType(u.TAG_POLICY_TYPE,n.policies,c,o.default.join(r,"tag-policies"))]),f=[...l,...d],h=f.map(e=>e.name),m=a.filter(e=>{var t;return!(null===(t=e.PolicySummary)||void 0===t?void 0:t.AwsManaged)}).filter(e=>!h.includes(e.PolicySummary.Name)).map(e=>{var t;return{currentContent:e.Content,currentDescription:e.PolicySummary.Description,id:e.PolicySummary.Id,name:e.PolicySummary.Name,awsManaged:null===(t=e.PolicySummary)||void 0===t?void 0:t.AwsManaged,newContent:null,newDescription:null,operation:"delete",type:e.PolicySummary.Type}}),p=s.filter(e=>{var t;return!(null===(t=e.PolicySummary)||void 0===t?void 0:t.AwsManaged)}).filter(e=>!h.includes(e.PolicySummary.Name)).map(e=>{var t;return{currentContent:e.Content,currentDescription:e.PolicySummary.Description,id:e.PolicySummary.Id,name:e.PolicySummary.Name,awsManaged:null===(t=e.PolicySummary)||void 0===t?void 0:t.AwsManaged,newContent:null,newDescription:null,operation:"delete",type:e.PolicySummary.Type}}),g=[...f,...m,...p];return{hasChanges:g.filter(e=>"skip"===e.operation).length!==g.length,skip:!1,serviceControlPolicies:[...l,...m],tagPolicies:[...d,...p]}})),t.planPoliciesDeployment=(e,n)=>i(void 0,void 0,void 0,(function*(){const{currentOrganizationHasAllFeaturesEnabled:i,currentServiceControlPolicies:a,currentTagPolicies:s}=n,r=e.getLogger();if(!i)return r.debug("Organization does not have all features enabled, skip policies deployment planning"),{skip:!0,hasChanges:!1,tagPolicies:[],serviceControlPolicies:[]};const c=e.getOrganizationConfigFile(),u=e.getOptions(),l=o.default.join(u.getProjectDir(),"organization"),{serviceControlPolicies:d,tagPolicies:f}=c;return t.createPoliciesDeploymentPlan(d,f,a,s,l)}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prettyPrintJson=e=>JSON.stringify(JSON.parse(e),null,2),t.compactJson=e=>JSON.stringify(JSON.parse(e))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(68)),s=a(n(69)),r=a(n(16)),c=(e,t,n,i,a,c)=>{const u=e.Id,l=r.default([...a,...t.serviceControlPolicies]),d=r.default([...c,...t.tagPolicies]),f=n.get(u)||[],h=i.get(u)||[],m=o.default(f,...l),p=o.default(h,...d),g=o.default(l,...f),v=o.default(d,...h),y=s.default(h,d),C=s.default(f,l);return{operation:g.length>0||m.length>0||v.length>0||p.length>0?"update":"skip",id:e.Id,serviceControlPolicies:{add:g,retain:C,remove:m},tagPolicies:{add:v,retain:y,remove:p}}};t.createOrganizationalUnitsDeploymentPlan=(e,t,n,i,a,o,s,r,c,f)=>{if(!n&&i)return u(e,t,i,a,o,s,r);if(n&&!i)return l(e,t,n,a,o,s,r,c,f);if(n&&i)return d(e,t,n,i,a,o,s,r,c,f);throw new Error("Assertion error")};const u=(e,n,i,a,o,s,r)=>{const c=i.children.map(r=>t.createOrganizationalUnitsDeploymentPlan(e,`${n}/${r.ou.Name}`,null,r,a,o,s,i.ou.Id,[],[]));return{path:n,priority:0,children:c,parentId:r,id:i.ou.Id,currentName:i.ou.Name,newName:null,operation:"delete",serviceControlPolicies:{add:[],retain:[],remove:[]},tagPolicies:{add:[],retain:[],remove:[]},accounts:{add:[],retain:[],remove:i.accounts.map(e=>({id:e.Id,operation:"skip",serviceControlPolicies:{add:[],retain:[],remove:[]},tagPolicies:{add:[],retain:[],remove:[]}}))}}},l=(e,n,i,a,o,s,u,l,d)=>(e.debug(`Plan creation of organizational unit: '${n}'`),{children:i.children.slice().sort((e,t)=>e.priority-t.priority).map(n=>t.createOrganizationalUnitsDeploymentPlan(e,n.path,n,null,a,o,s,null,r.default([...l,...i.serviceControlPolicies]),r.default([...d,...i.tagPolicies]))),parentId:u,path:n,priority:i.priority,id:null,currentName:null,newName:i.name,operation:"add",serviceControlPolicies:{add:r.default([...i.serviceControlPolicies,...l]),retain:[],remove:[]},tagPolicies:{add:r.default([...i.tagPolicies,...d]),retain:[],remove:[]},accounts:{add:i.accounts.map(e=>c(a.find(t=>t.Id===e.id),e,o,s,l,d)),retain:[],remove:[]}}),d=(e,n,i,a,u,l,d,f,h,m)=>{e.debug(`Plan update for organizational unit: '${n}'`);const p=a.accounts.map(e=>e.Id),g=i.accounts.map(e=>e.id),v=l.get(a.ou.Id)||[],y=d.get(a.ou.Id)||[];e.debugObject(`Organizational unit '${n}' policy configuration:`,{current:{tagPolicies:y,serviceControlPolicies:v},inherited:{tagPolicies:m,serviceControlPolicies:h},local:{tagPolicies:i.tagPolicies,serviceControlPolicies:i.serviceControlPolicies}});const C=r.default([...h,...i.serviceControlPolicies]),w=r.default([...m,...i.tagPolicies]),P=o.default(v,...C),_=o.default(y,...w),S=o.default(C,...v),b=o.default(w,...y),O=s.default(y,w),E=s.default(v,C);e.debugObject(`Organizational unit '${n}' policy operations:`,{add:{tagPolicies:b,serviceControlPolicies:S},retain:{tagPolicies:O,serviceControlPolicies:E},remove:{tagPolicies:_,serviceControlPolicies:P}});const A=o.default(g,...p),k=o.default(p,...g),D=s.default(p,g),I=A.map(e=>c(u.find(t=>t.Id===e),i.accounts.find(t=>t.id===e),l,d,h,m)),T=D.map(e=>c(u.find(t=>t.Id===e),i.accounts.find(t=>t.id===e),l,d,h,m)),R=k.map(e=>({operation:"skip",id:e,serviceControlPolicies:{add:[],retain:[],remove:[]},tagPolicies:{add:[],retain:[],remove:[]}})),x=i.children.slice().sort((e,t)=>e.priority-t.priority).map(n=>{const i=a.children.find(e=>e.ou.Name===n.name)||null;return t.createOrganizationalUnitsDeploymentPlan(e,n.path,n,i,u,l,d,a.ou.Id,C,w)})||[],j=(null==a?void 0:a.children.filter(e=>void 0===i.children.find(t=>t.name===e.ou.Name)).map(i=>t.createOrganizationalUnitsDeploymentPlan(e,`${n}/${i.ou.Name}`,null,i,u,l,d,null==a?void 0:a.ou.Id,[],[])))||[];return{parentId:f,operation:(null==i?void 0:i.name)!==(null==a?void 0:a.ou.Name)||[P,_,S,b].reduce((e,t)=>e+t.length,0)>0||p.length!==g.length||p.slice().sort().join(",")!==g.slice().sort().join(",")||void 0!==[...I,...R,...T].find(e=>"update"===e.operation)?"update":"skip",children:[...x,...j],path:n,priority:i.priority,id:a.ou.Id,currentName:a.ou.Name,newName:i.name,serviceControlPolicies:{add:S,retain:E,remove:P},tagPolicies:{add:b,retain:O,remove:_},accounts:{add:I,retain:T,remove:R}}};t.planOrganizationUnitsDeployment=(e,n)=>i(void 0,void 0,void 0,(function*(){const{currentRootOrganizationalUnit:i,currentAccounts:a,currentServiceControlPoliciesByTarget:o,currentTagPoliciesByTarget:s}=n,r=e.getOrganizationConfigFile(),{organizationalUnits:{Root:c}}=r,u=t.createOrganizationalUnitsDeploymentPlan(e.getLogger(),"Root",c,i,a,o,s,null,[],[]),l=e=>"skip"!==e.operation||void 0!==e.children.find(e=>l(e));return{hasChanges:l(u),root:u}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(68)),s=a(n(69)),r=n(3);t.planOrganizationBasicConfigDeployment=(e,t)=>i(void 0,void 0,void 0,(function*(){const{currentOrganizationHasAllFeaturesEnabled:n,currentTrustedAwsServices:i,currentEnabledPolicies:a}=t,c=e.getLogger(),u=e.getOrganizationConfigFile();if(!n)return c.debug("Organization does not have all features enabled, skip basic config deployment planning"),{skip:!0,hasChanges:!1,enabledPolicies:{add:[],retain:[],remove:[]},trustedServices:{add:[],retain:[],remove:[]}};const l=u.trustedAwsServices||r.ORGANIZATION_SERVICE_PRINCIPALS,d=new Array;u.serviceControlPolicies.enabled&&d.push(r.SERVICE_CONTROL_POLICY_TYPE),u.tagPolicies.enabled&&d.push(r.TAG_POLICY_TYPE);const f=o.default(l,...i),h=o.default(i,...l),m=s.default(l,i),p=o.default(d,...a),g=o.default(a,...d),v=s.default(d,a),y=[...f,...h].length>0,C=[...p,...g].length>0;return{hasChanges:y||C,skip:!1,enabledPolicies:{add:p,retain:v,remove:g},trustedServices:{add:f,retain:m,remove:h}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(183),o=n(0),s=n(184);t.planLaunch=e=>i(void 0,void 0,void 0,(function*(){const{io:t,watch:n,ctx:i,organizationData:r,input:{organizationalUnits:c,accountIds:u,operation:l}}=e,d=n.startChild("plan");t.info("Plan operation");const f=yield a.planAccountsLaunch(i,r,c,u);if(!f.hasChanges){const e="No accounts to process";return t.info(e),d.stop(),{message:e,results:[],success:!0,status:o.CommandStatus.SKIPPED,watch:n.stop()}}return d.stop(),s.confirmOperation(Object.assign(Object.assign({},e),{plan:f}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(10)),s=a(n(49)),r=n(33),c=n(12);t.planAccountsLaunch=(e,t,n,a)=>i(void 0,void 0,void 0,(function*(){const{currentAccounts:i}=t,u=e.getLogger();u.debugObject("Plan accounts launch with parameters:",{organizationalUnits:n,accountIds:a});const l=0===n.length?[e.getOrganizationalUnit("Root")]:n.reduce((t,n)=>[...t,e.getOrganizationalUnit(n)],new Array),d=(e,t)=>{const n=e.priority-t.priority;return 0!==n?n:e.name.localeCompare(t.name)},f=o.default(l.map(e=>o.default(c.collectFromHierarchy(e,e=>e.children,{sortSiblings:d,filter:e=>e.status===r.OrganizationalUnitStatus.ACTIVE})))),h=s.default(f,e=>e.path).filter(e=>e.status===r.OrganizationalUnitStatus.ACTIVE),m=new Map(i.map(e=>[e.Id,e])),p=h.map(e=>({path:e.path,accountAdminRoleName:e.accountAdminRoleName,configSets:e.configSets,vars:e.vars,accounts:e.accounts.filter(e=>e.status===r.OrganizationAccountStatus.ACTIVE&&e.configSets.length>0&&(0===a.length||a.includes(e.id)))})).filter(e=>e.accounts.length>0).map(e=>{const t=e.accounts.map(e=>({account:m.get(e.id),config:e}));return Object.assign(Object.assign({},e),{accounts:t})});return u.debugObject("Organizational units to launch:",p.map(e=>e.path)),{hasChanges:p.length>0,organizationalUnits:p}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(185),o=n(6),s=n(0);t.confirmOperation=e=>i(void 0,void 0,void 0,(function*(){const{watch:t,io:n,ctx:i,plan:r}=e,c=t.startChild("confirm"),u=i.getOptions();return n.debug("Confirm operation"),u.isAutoConfirmEnabled()?(c.stop(),a.processOperation(e)):(yield n.confirmLaunch(r))===o.ConfirmResult.NO?{message:"Cancelled",results:[],success:!1,status:s.CommandStatus.CANCELLED,watch:t.stop()}:(c.stop(),a.processOperation(e))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(186);t.processOperation=e=>i(void 0,void 0,void 0,(function*(){const{watch:t,io:n,plan:i}=e,s=t.startChild("process"),r=new Array;n.info("Process operation");const c={failed:!1};for(const t of i.organizationalUnits){const n=yield o.processOrganizationalUnit(e,t,s.startChild(t.path),c);r.push(n)}return Object.assign(Object.assign({},a.resolveCommandOutputBase(r)),{results:r,watch:s.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(187);t.processOrganizationalUnit=(e,t,n,s)=>i(void 0,void 0,void 0,(function*(){const{io:i}=e;i.info(`Process organizational unit '${t.path}' with ${t.accounts.length} account(s)`);const r=new Array;for(const i of t.accounts){const a=yield o.processAccount(e,t,i,n.startChild(i.account.Id),s);r.push(a)}return Object.assign(Object.assign({},a.resolveCommandOutputBase(r)),{path:t.path,results:r,watch:n.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(188);t.processAccount=(e,t,n,s,r)=>i(void 0,void 0,void 0,(function*(){const{io:i}=e,c=n.config;i.info(`Process account ${c.id}`);const u=new Array;for(const i of c.configSets){const a=yield o.processConfigSet(e,t,n,i,s.startChild(i),r);u.push(a)}return Object.assign(Object.assign({},a.resolveCommandOutputBase(u)),{results:u,accountId:c.id,watch:s.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(189);t.processConfigSet=(e,t,n,s,r,c)=>i(void 0,void 0,void 0,(function*(){const{io:i,ctx:u}=e;i.info(`Process config set: ${s}`);const l=u.getConfigSet(s),d=new Array;for(const i of l.commandPaths){const a=yield o.processCommandPath(e,t,n,s,i,r.startChild(i),c);a.success||(c.failed=!0),d.push(a)}return Object.assign(Object.assign({},a.resolveCommandOutputBase(d)),{configSetName:s,results:d,watch:r.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(2),s=n(0),r=a(n(34)),c=n(36),u=a(n(42)),l=n(25),d=n(21),f=n(43),h=a(n(45)),m=n(23);t.processCommandPath=(e,t,n,a,p,g,v)=>i(void 0,void 0,void 0,(function*(){const{io:g,ctx:y,input:{variables:C,options:w,operation:P}}=e,_=n.config,S=y.getDefaultCredentialProvider(),b=y.getOrganizationConfigFile();if(g.info(`Process command path: ${p}`),v.failed)return{commandPath:p,result:{message:"Cancelled",status:s.CommandStatus.CANCELLED,watch:new o.StopWatch("total").stop(),success:!1,results:[]},status:s.CommandStatus.CANCELLED,success:!1};const O=_.accountAdminRoleName||t.accountAdminRoleName||b.accountAdminRoleName||b.accountCreation.defaults.roleName;g.info(`Using role name: ${O}`);const E=o.deepCopy(C.vars);r.default(E,b.vars,t.vars,_.vars);const A={variables:{env:C.env,vars:E,context:C.context},watch:new o.StopWatch("total"),options:w,commandPath:p,ignoreDependencies:!1},k=yield S.getCredentials(),D=new l.DefaultCredentialProvider(new d.CredentialProviderChain([()=>new d.ChainableTemporaryCredentials({params:{RoleArn:`arn:aws:iam::${_.id}:role/${O}`,DurationSeconds:3600,RoleSessionName:"bauble"},masterCredentials:k})]));try{const e=yield((e,t,n,a)=>i(void 0,void 0,void 0,(function*(){switch(e){case m.DeploymentOperation.DEPLOY:return c.launchStacksCommand(t,new u.default(t.options,n.id),a);case m.DeploymentOperation.UNDEPLOY:return f.deleteStacksCommand(t,new h.default(t.options,n.id),a);default:throw new Error(`Unsupported operation: ${e}`)}})))(P,A,_,D);return{result:e,commandPath:p,status:e.status,success:e.success}}catch(e){return g.error(`Unhandled error when deploying account: ${_.id}, config set: ${a}, command path: ${p}`,e),{commandPath:p,result:{message:e.message,status:s.CommandStatus.FAILED,watch:new o.StopWatch("total").stop(),success:!1,results:[]},success:!1,status:s.CommandStatus.FAILED}}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(70);class a extends i.CliAccountsOperationIO{constructor(e){super(e,{confirmHeader:"Accounts deployment plan",confirmQuestion:"Continue to deploy accounts?",outputHeader:"Accounts deployment summary",outputNoAccounts:"No accounts deployed"})}}t.CliDeployAccountsIO=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(5),a=n(65),o=n(192),s=n(23);t.default={command:"undeploy [organizationalUnits..]",desc:"Undeploy accounts",builder:e=>e.option("account-id",{description:"Account id to undeploy",alias:"a",string:!0,global:!1,demandOption:!1}),handler:e=>i.handle(e,t=>{return Object.assign(Object.assign({},t),{organizationalUnits:e.organizationalUnits||[],accountIds:(n=e["account-id"],n?Array.isArray(n)?n:[n]:[]),operation:s.DeploymentOperation.UNDEPLOY});var n},e=>a.accountsOperationCommand(e,new o.CliUndeployAccountsIO(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(70);class a extends i.CliAccountsOperationIO{constructor(e){super(e,{confirmHeader:"Accounts undeployment plan",confirmQuestion:"Continue to undeploy accounts?",outputHeader:"Accounts undeployment summary",outputNoAccounts:"No accounts undeployed"})}}t.CliUndeployAccountsIO=a},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(194),s=n(2),r=i(n(208));t.default={command:"launch",desc:"Launch organization",builder:{},handler:e=>a.handle(e,s.identity,e=>o.launchOrganizationCommand(e,new r.default(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(195);t.launchOrganizationCommand=i.launchOrganizationCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(4)),s=n(0),r=n(22),c=n(196),u=o.default.object({}).unknown(!0);t.launchOrganizationCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return s.validateInput(u,e).then(({options:e,variables:n})=>r.buildOrganizationContext(e,n,t)).then(n=>c.launchOrganization(n,t,e)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(197);t.launchOrganization=(e,t,n)=>i(void 0,void 0,void 0,(function*(){const{watch:i}=n;return a.loadData({ctx:e,watch:i,io:t,input:n,completed:!1})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(66),o=n(198);t.loadData=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,io:n,watch:i}=e,s=i.startChild("load-organization-data");n.info("Load organization data");const r=yield a.loadOrganizationData(t,n);return s.stop(),o.validateLocalConfiguration(Object.assign(Object.assign({},e),{organizationData:r}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(46),o=n(199);t.validateLocalConfiguration=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,io:n,watch:i,organizationData:s}=e,r=i.startChild("validate-configuration");return n.info("Validate configuration"),yield a.validateCommonLocalConfiguration(t,s.currentAccounts),r.stop(),o.planDeployment(e)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(67),o=n(200);t.planDeployment=e=>i(void 0,void 0,void 0,(function*(){const{io:t,watch:n,ctx:i,organizationData:s}=e,r=n.startChild("plan-deployment");t.info("Plan deployment");const c=yield a.planOrganizationLaunch(i,s);return r.stop(),o.confirmDeployment(Object.assign(Object.assign({},e),{plan:c}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(6),o=n(201);t.confirmDeployment=e=>i(void 0,void 0,void 0,(function*(){const{watch:t,io:n,ctx:i}=e,s=t.startChild("confirm-deployment"),r=i.getOptions();return n.debug("Confirm deployment"),r.isAutoConfirmEnabled()?(s.stop(),o.deployBasicConfiguration(e)):(yield n.confirmLaunch(e))===a.ConfirmResult.NO?o.deployBasicConfiguration(Object.assign(Object.assign({},e),{completed:!0})):(s.stop(),o.deployBasicConfiguration(e))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(202);t.deployBasicConfiguration=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,watch:n,io:i,plan:{organizationBasicConfigPlan:s},organizationData:{currentRootOrganizationalUnit:r},completed:c}=e,u=n.startChild("deploy-basic-config");if(c)return i.info("Launch already completed, cancel basic config deployment"),u.stop(),o.deployPolicies(Object.assign(Object.assign({},e),{organizationBasicConfigDeploymentResult:{success:!1,message:"Cancelled",status:a.CommandStatus.CANCELLED}}));if(!s.hasChanges)return i.info("No changes to basic config"),u.stop(),o.deployPolicies(Object.assign(Object.assign({},e),{organizationBasicConfigDeploymentResult:{success:!0,message:"Skipped",status:a.CommandStatus.SKIPPED}}));i.info("Deploy basic config");const l=t.getClient();for(const e of s.enabledPolicies.add)i.info(`Enable policy type: ${e}`),yield l.enablePolicyType({PolicyType:e,RootId:r.ou.Id}),yield l.waitUntilPolicyTypeIsEnabled(e,6e4);for(const e of s.enabledPolicies.remove)i.info(`Disable policy type: ${e}`),yield l.disablePolicyType({PolicyType:e,RootId:r.ou.Id}),yield l.waitUntilPolicyTypeIsDisabled(e,6e4);for(const e of s.trustedServices.add)i.info(`Enable AWS service: ${e}`),yield l.enableAWSServiceAccess(e);return u.stop(),o.deployPolicies(Object.assign(Object.assign({},e),{organizationBasicConfigDeploymentResult:{success:!0,message:"Success",status:a.CommandStatus.SUCCESS}}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(3),s=n(203);t.deployPolicies=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,watch:n,io:i,plan:{policiesPlan:r},completed:c,organizationData:u}=e,l=n.startChild("deploy-policies"),{currentTagPolicies:d,currentServiceControlPolicies:f}=u;if(c)return i.info("Launch already completed, cancel policies deployment"),l.stop(),s.deployOrganizationalUnits(Object.assign(Object.assign({},e),{policiesDeploymentResult:{results:[],message:"Cancelled",success:!1,status:a.CommandStatus.CANCELLED}}));const h=t.getClient();if(!r.hasChanges)return i.info("No changes to policies"),s.deployOrganizationalUnits(Object.assign(Object.assign({},e),{policiesDeploymentResult:{results:[],message:"Skipped",success:!0,status:a.CommandStatus.SKIPPED}}));i.info("Deploy policies");const m=[...r.serviceControlPolicies,...r.tagPolicies],p=m.filter(e=>"add"===e.operation),g=m.filter(e=>"skip"===e.operation),v=m.filter(e=>"update"===e.operation);i.info(`Skip ${g.length} policies`);const y=g.map(e=>({id:e.id,type:e.type,name:e.name,status:a.CommandStatus.SKIPPED,success:!0,awsManaged:e.awsManaged,message:"No changes",policy:null}));i.info(`Add ${p.length} policies`);const C=yield Promise.all(p.map(e=>h.createPolicy({Type:e.type,Name:e.name,Content:e.newContent,Description:e.newDescription}).then(t=>({id:t.PolicySummary.Id,type:e.type,name:e.name,status:a.CommandStatus.SUCCESS,awsManaged:e.awsManaged,success:!0,message:"Added",policy:t})).catch(t=>(i.error(`Failed to create policy '${e.name}' of type '${e.type}'`,t),{id:e.id,type:e.type,name:e.name,status:a.CommandStatus.FAILED,awsManaged:e.awsManaged,success:!1,message:`Failed to create policy '${e.name}' of type '${e.type}': ${t.message}`,policy:null}))));i.info(`Update ${v.length} policies`);const w=yield Promise.all(v.map(e=>h.updatePolicy({PolicyId:e.id,Name:e.name,Description:e.newDescription,Content:e.newContent}).then(t=>({id:e.id,type:e.type,name:e.name,status:a.CommandStatus.SUCCESS,awsManaged:e.awsManaged,success:!0,message:"Updated",policy:t})).catch(t=>(i.error(`Failed to update policy '${e.name}' of type '${e.type}'`,t),{id:e.id,type:e.type,name:e.name,status:a.CommandStatus.FAILED,awsManaged:e.awsManaged,success:!1,message:`Failed to update policy '${e.name}' of type '${e.type}': ${t.message}`,policy:null})))),P=C.filter(e=>e.type===o.SERVICE_CONTROL_POLICY_TYPE).map(e=>e.policy),_=C.filter(e=>e.type===o.TAG_POLICY_TYPE).map(e=>e.policy),S=[...y,...C,...w],b=S.filter(e=>!e.success),O=0===b.length,E=O?a.CommandStatus.SUCCESS:a.CommandStatus.FAILED,A=O?"Success":b.length>0?b[0].message:"Failed";return l.stop(),s.deployOrganizationalUnits(Object.assign(Object.assign({},e),{organizationData:Object.assign(Object.assign({},u),{currentServiceControlPolicies:[...f,...P],currentTagPolicies:[...d,..._]}),completed:!O,policiesDeploymentResult:{message:A,success:O,results:S,status:E}}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),s=n(3),r=a(n(10)),c=n(204),u=n(12);t.addOrUpdateOrganizationalUnits=(e,t,n,a,o,s,r,c,u)=>i(void 0,void 0,void 0,(function*(){switch(c.operation){case"add":return yield m(e,t,n,a,o,s,r,c,u);case"update":return p(e,t,n,a,o,s,r,c);case"skip":return g(e,t,n,a,o,s,r,c);default:return[]}}));const l=(e,t,n,a,o,s,r)=>i(void 0,void 0,void 0,(function*(){if(0===s.length)return e.debug(`No policies of type '${t}' to detach from ${a} '${o}'`),!0;e.debug(`About to detach ${s.length} policies of type '${t}' from ${a} '${o}'`);for(const i of s){const s=r.get(i);e.debugObject("Detach policy",{policyId:s,policyType:t,policyName:i,targetId:o});try{yield n.detachPolicy({TargetId:o,PolicyId:s})}catch(n){return e.error(`Failed to detach policy ${s} of type '${t}' from ${a} '${o}'`,n),!1}}return!0})),d=(e,t,n,a,o,s,r)=>i(void 0,void 0,void 0,(function*(){if(0===s.length)return e.debug(`No policies of type '${t}' to attach to ${a} '${o}'`),!0;e.debug(`About to attach ${s.length} policies of type '${t}' to ${a} '${o}'`);for(const i of s){const s=r.get(i);e.debugObject("Attach policy",{policyId:s,policyType:t,policyName:i,targetId:o});try{yield n.attachPolicy({TargetId:o,PolicyId:s})}catch(n){return e.error(`Failed to attach policy ${s} of type '${t}' to ${a} '${o}'`,n),!1}}return!0})),f=e=>{const t={id:e.id,name:e.newName,message:"Cancelled due to earlier failures",success:!1,status:o.CommandStatus.CANCELLED};return e.children.reduce((e,t)=>[...e,...f(t)],[t])},h=(e,t,n,a,o,r,c,u,f,h,m,p)=>i(void 0,void 0,void 0,(function*(){if(n.includes(s.SERVICE_CONTROL_POLICY_TYPE)){const n=a?f.filter(e=>e!==s.DEFAULT_SERVICE_CONTROL_POLICY_NAME):f;if(!(yield d(e,s.SERVICE_CONTROL_POLICY_TYPE,t,c,u,n,o)))return!1}return!(n.includes(s.TAG_POLICY_TYPE)&&!(yield d(e,s.TAG_POLICY_TYPE,t,c,u,m,r)))&&(!(n.includes(s.SERVICE_CONTROL_POLICY_TYPE)&&!(yield l(e,s.SERVICE_CONTROL_POLICY_TYPE,t,c,u,h,o)))&&!(n.includes(s.TAG_POLICY_TYPE)&&!(yield l(e,s.TAG_POLICY_TYPE,t,c,u,p,r))))})),m=(e,n,a,c,u,l,d,m,p)=>i(void 0,void 0,void 0,(function*(){const g=new Array;e.info(`Create new organizational unit with path '${m.path}'`);const v=yield((e,t,n,a)=>i(void 0,void 0,void 0,(function*(){return t.createOrganizationalUnit({Name:n.newName,ParentId:a}).then(e=>({id:e.Id,name:e.Name,message:"Added",success:!0,status:o.CommandStatus.SUCCESS})).catch(t=>(e.error(`Failed to create new organizational unit '${n.path}'`,t),{id:null,name:n.newName,message:t.message,success:!1,status:o.CommandStatus.FAILED}))})))(e,n,m,p);if(!v.success)return e.warn(`Creating of new organizational unit with path '${m.path}' failed, cancel the remaining organizational units`),[...g,v,...r.default(m.children.map(f))];e.info("Created new organizational unit",{path:m.path,id:v.id});const y=yield n.listAllPoliciesForTarget(v.id);e.debugObject("New organizational unit has following initial policies",y);const C=y.filter(e=>e.Type===s.SERVICE_CONTROL_POLICY_TYPE).map(e=>e.Name),w=y.filter(e=>e.Type===s.TAG_POLICY_TYPE).map(e=>e.Name),P=m.serviceControlPolicies.add.filter(e=>!C.includes(e)),_=C.filter(e=>!m.serviceControlPolicies.add.includes(e)),S=m.tagPolicies.add.filter(e=>!w.includes(e)),b=w.filter(e=>!m.tagPolicies.add.includes(e));if(!(yield h(e,n,a,c,u,l,"organizational unit",v.id,P,_,S,b)))return e.warn(`Attaching and detaching policies for new organizational unit with path '${m.path}' failed, cancel the remaining organizational units`),[...g,Object.assign(Object.assign({},v),{success:!1,status:o.CommandStatus.FAILED,message:"Policies failed"}),...r.default(m.children.map(f))];for(const t of m.accounts.add){const i=t.id,s=d.get(i),p=v.id;if(e.info(`Move account '${i}' from organizational unit ${s} to ${p}`),!(yield n.moveAccount({AccountId:i,DestinationParentId:p,SourceParentId:s})))return e.warn(`Moving account '${i}' to new organizational unit with path '${m.path}' failed, cancel the remaining organizational units`),[...g,Object.assign(Object.assign({},v),{success:!1,status:o.CommandStatus.FAILED,message:"Accounts failed"}),...r.default(m.children.map(f))];if(!(yield h(e,n,a,c,u,l,"account",i,t.serviceControlPolicies.add,t.serviceControlPolicies.remove,t.tagPolicies.add,t.tagPolicies.remove)))return e.warn(`Attaching and detaching policies for account '${i}' of new organizational unit with path '${m.path}' failed, cancel the remaining organizational units`),[...g,Object.assign(Object.assign({},v),{success:!1,status:o.CommandStatus.FAILED,message:"Accounts failed"}),...r.default(m.children.map(f))]}g.push(v);for(const i of m.children){(yield t.addOrUpdateOrganizationalUnits(e,n,a,c,u,l,d,i,v.id)).forEach(e=>g.push(e))}return g})),p=(e,n,a,s,c,u,l,d)=>i(void 0,void 0,void 0,(function*(){const i=new Array;if(e.info(`Update organizational unit: ${d.path}`),!(yield h(e,n,a,s,c,u,"organizational unit",d.id,d.serviceControlPolicies.add,d.serviceControlPolicies.remove,d.tagPolicies.add,d.tagPolicies.remove)))return e.warn(`Attaching and detaching policies for organizational unit with path '${d.path}' failed, cancel the remaining organizational units`),[...i,{id:d.id,name:d.newName,success:!1,status:o.CommandStatus.FAILED,message:"Policies failed"},...r.default(d.children.map(f))];for(const t of[...d.accounts.add]){const a=t.id,s=l.get(a),c=d.id;if(e.info(`Move account ${a} from organizational unit ${s} to ${c}`),!(yield n.moveAccount({AccountId:a,DestinationParentId:c,SourceParentId:s})))return e.warn(`Moving account '${a}' to organizational unit with path '${d.path}' failed, cancel the remaining organizational units`),[...i,{id:d.id,name:d.newName,success:!1,status:o.CommandStatus.FAILED,message:"Accounts failed"},...r.default(d.children.map(f))]}for(const t of[...d.accounts.add,...d.accounts.retain]){const l=t.id;if(!(yield h(e,n,a,s,c,u,"account",l,t.serviceControlPolicies.add,t.serviceControlPolicies.remove,t.tagPolicies.add,t.tagPolicies.remove)))return e.warn(`Attaching and detaching policies for account '${l}' of organizational unit with path '${d.path}' failed, cancel the remaining organizational units`),[...i,{id:d.id,name:d.newName,success:!1,status:o.CommandStatus.FAILED,message:"Accounts failed"},...r.default(d.children.map(f))]}i.push({id:d.id,name:d.currentName,message:"Updated",success:!0,status:o.CommandStatus.SUCCESS});for(const o of d.children){(yield t.addOrUpdateOrganizationalUnits(e,n,a,s,c,u,l,o,d.id)).forEach(e=>i.push(e))}return i})),g=(e,n,a,s,r,c,u,l)=>i(void 0,void 0,void 0,(function*(){const i=new Array;e.info(`Skip organizational unit: ${l.path}`),i.push({id:l.id,name:l.currentName,message:"No changes",success:!0,status:o.CommandStatus.SKIPPED});for(const o of l.children){(yield t.addOrUpdateOrganizationalUnits(e,n,a,s,r,c,u,o,l.id)).forEach(e=>i.push(e))}return i}));t.deployOrganizationalUnits=e=>i(void 0,void 0,void 0,(function*(){const{ctx:n,watch:i,io:a,organizationData:{currentRootOrganizationalUnit:l,currentTagPolicies:d,currentServiceControlPolicies:f},plan:{organizationalUnitsPlan:h,organizationBasicConfigPlan:m},completed:p}=e,g=i.startChild("deploy-organizational-units");if(p)return a.info("Launch already completed, cancel organizational units deployment"),g.stop(),c.cleanOrganizationalUnits(Object.assign(Object.assign({},e),{organizationalUnitsDeploymentResult:{message:"Cancelled",status:o.CommandStatus.CANCELLED,success:!1,results:[]}}));if(!h.hasChanges)return a.info("No changes to organizational units"),g.stop(),c.cleanOrganizationalUnits(Object.assign(Object.assign({},e),{organizationalUnitsDeploymentResult:{message:"Skipped",status:o.CommandStatus.SKIPPED,success:!0,results:[]}}));a.info("Deploy organizational units");const v=[...m.enabledPolicies.add,...m.enabledPolicies.retain],y=new Map(f.map(e=>[e.PolicySummary.Name,e.PolicySummary.Id])),C=new Map(d.map(e=>[e.PolicySummary.Name,e.PolicySummary.Id])),w=r.default(u.collectFromHierarchy(l,e=>e.children)),P=new Map(r.default(w.map(e=>e.accounts.map(t=>[t.Id,e.ou.Id])))),_=m.enabledPolicies.add.includes(s.SERVICE_CONTROL_POLICY_TYPE),S=yield t.addOrUpdateOrganizationalUnits(a,n.getClient(),v,_,y,C,P,h.root,null);a.debugObject("Organizational units deployment results:",S);const b=void 0===S.find(e=>!e.success),O=b?o.CommandStatus.SUCCESS:o.CommandStatus.FAILED,E=b?"Success":"Failed";return g.stop(),c.cleanOrganizationalUnits(Object.assign(Object.assign({},e),{completed:!b,organizationalUnitsDeploymentResult:{message:E,status:O,success:b,results:S}}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(205),s=n(12);t.removeOrganizationalUnits=(e,n)=>i(void 0,void 0,void 0,(function*(){const i=new Array;if("delete"===n.operation){const t=s.collectFromHierarchy(n,e=>e.children).reverse();let o=!1;for(const n of t){if(o){i.push({id:n.id,name:n.currentName,message:"Cancelled",success:!1,status:a.CommandStatus.CANCELLED});continue}const t=yield e.deleteOrganizationalUnit(n.id).then(()=>({id:n.id,name:n.currentName,message:"Deleted",success:!0,status:a.CommandStatus.SUCCESS})).catch(e=>({id:n.id,name:n.currentName,message:e.message,success:!1,status:a.CommandStatus.FAILED}));t.success||(o=!0),i.push(t)}}else for(const a of n.children){(yield t.removeOrganizationalUnits(e,a)).forEach(e=>i.push(e))}return i})),t.cleanOrganizationalUnits=e=>i(void 0,void 0,void 0,(function*(){const{ctx:n,watch:i,io:s,plan:{organizationalUnitsPlan:r},completed:c}=e,u=i.startChild("clean-organizational-units"),l=n.getClient();if(c)return s.info("Launch already completed, cancel organizational units clean"),u.stop(),o.cleanPolicies(Object.assign(Object.assign({},e),{organizationalUnitsCleanResult:{message:"Cancelled",status:a.CommandStatus.CANCELLED,success:!1,results:[]}}));if(!r.hasChanges)return s.info("No organizational units to clean"),u.stop(),o.cleanPolicies(Object.assign(Object.assign({},e),{organizationalUnitsCleanResult:{message:"Skipped",status:a.CommandStatus.SKIPPED,success:!0,results:[]}}));s.info("Clean organizational units");const d=yield t.removeOrganizationalUnits(l,r.root),f=void 0===d.find(e=>!e.success),h=f?a.CommandStatus.SUCCESS:a.CommandStatus.FAILED,m=f?"Success":"Failed";return u.stop(),o.cleanPolicies(Object.assign(Object.assign({},e),{completed:!f,organizationalUnitsCleanResult:{message:m,status:h,success:f,results:d}}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(206);t.cleanPolicies=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,watch:n,io:i,plan:{policiesPlan:s},completed:r}=e,c=n.startChild("clean-policies");if(r)return i.info("Launch already completed, cancel policies clean"),c.stop(),o.cleanBasicConfiguration(Object.assign(Object.assign({},e),{policiesCleanResult:{message:"Cancelled",success:!1,status:a.CommandStatus.CANCELLED,results:[]}}));if(!s.hasChanges)return i.info("No policies to clean"),c.stop(),o.cleanBasicConfiguration(Object.assign(Object.assign({},e),{policiesCleanResult:{message:"Skipped",success:!0,status:a.CommandStatus.SKIPPED,results:[]}}));i.info("Clean policies");const u=t.getClient(),l=[...s.serviceControlPolicies,...s.tagPolicies].filter(e=>!e.awsManaged).filter(e=>"delete"===e.operation);i.info(`Delete ${l.length} policies`);const d=yield Promise.all(l.map(e=>u.deletePolicy(e.id).then(()=>({id:e.id,type:e.type,name:e.name,status:a.CommandStatus.SUCCESS,awsManaged:e.awsManaged,success:!0,message:"Deleted",policy:null})).catch(t=>({id:e.id,type:e.type,name:e.name,status:a.CommandStatus.FAILED,awsManaged:e.awsManaged,success:!1,message:t.message,policy:null})))),f=void 0===d.find(e=>!e.success),h=f?a.CommandStatus.SUCCESS:a.CommandStatus.FAILED,m=f?"Success":"Failed";return c.stop(),o.cleanBasicConfiguration(Object.assign(Object.assign({},e),{policiesCleanResult:{message:m,success:f,status:h,results:d}}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(207);t.cleanBasicConfiguration=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,watch:n,io:i,plan:{organizationBasicConfigPlan:s},completed:r}=e,c=n.startChild("clean-basic-config");if(r)return i.info("Launch already completed, cancel basic configuration clean"),c.stop(),o.buildOutput(Object.assign(Object.assign({},e),{organizationBasicConfigCleanResult:{message:"Cancelled",success:!1,status:a.CommandStatus.CANCELLED}}));if(!s.hasChanges)return i.info("No basic configuration to clean"),c.stop(),o.buildOutput(Object.assign(Object.assign({},e),{organizationBasicConfigCleanResult:{message:"Skipped",success:!0,status:a.CommandStatus.SKIPPED}}));i.info("Clean policies");const u=t.getClient();for(const t of s.trustedServices.remove){i.info(`Disable AWS service: ${t}`);try{yield u.disableAWSServiceAccess(t)}catch(n){return i.error(`Failed to disable AWS service access: '${t}'`,n),o.buildOutput(Object.assign(Object.assign({},e),{organizationBasicConfigCleanResult:{message:"Failed to disable AWS service access",success:!1,status:a.CommandStatus.FAILED}}))}}return o.buildOutput(Object.assign(Object.assign({},e),{organizationBasicConfigCleanResult:{message:"Success",success:!0,status:a.CommandStatus.SUCCESS}}))}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(0);t.buildOutput=e=>{const{watch:t,organizationalUnitsDeploymentResult:n,organizationalUnitsCleanResult:a,policiesDeploymentResult:o,policiesCleanResult:s,organizationBasicConfigDeploymentResult:r,organizationBasicConfigCleanResult:c}=e,u=n.success&&a.success&&o.success&&s.success&&c.success;return{success:u,status:u?i.CommandStatus.SUCCESS:i.CommandStatus.FAILED,message:u?"Success":"Failed",watch:t.stop(),organizationalUnitsCleanResult:a,organizationalUnitsDeploymentResult:n,policiesCleanResult:s,policiesDeploymentResult:o,basicConfigDeploymentResult:r,basicConfigCleanResult:c}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(9)),s=n(6),r=a(n(11)),c=n(14),u=n(20),l=n(2);class d extends o.default{constructor(e){super(e),this.confirmLaunch=e=>i(this,void 0,void 0,(function*(){return this.printEnabledPolicyTypes(e.plan.organizationBasicConfigPlan),this.printTrustedServices(e.plan.organizationBasicConfigPlan),this.printPoliciesDeploymentPlan(e.plan.policiesPlan),this.printOrganizationalUnits(e.plan.organizationalUnitsPlan),(yield this.confirm("Continue to launch the organization?",!0))?s.ConfirmResult.YES:s.ConfirmResult.NO})),this.printOutput=e=>{const{policiesDeploymentResult:t,policiesCleanResult:n,organizationalUnitsDeploymentResult:i,organizationalUnitsCleanResult:a,basicConfigDeploymentResult:o,basicConfigCleanResult:s}=e;this.header("DEPLOYMENT SUMMARY",!0);const u=new r.default;return u.cell("Task","Deploy basic configuration"),u.cell("Status",c.formatCommandStatus(o.status)),u.cell("Message",o.message),u.newRow(),u.cell("Task","Deploy policies"),u.cell("Status",c.formatCommandStatus(t.status)),u.cell("Message",t.message),u.newRow(),u.cell("Task","Deploy organizational units"),u.cell("Status",c.formatCommandStatus(i.status)),u.cell("Message",i.message),u.newRow(),u.cell("Task","Clean organizational units"),u.cell("Status",c.formatCommandStatus(a.status)),u.cell("Message",a.message),u.newRow(),u.cell("Task","Clean policies"),u.cell("Status",c.formatCommandStatus(n.status)),u.cell("Message",n.message),u.newRow(),u.cell("Task","Clean basic config"),u.cell("Status",c.formatCommandStatus(s.status)),u.cell("Message",s.message),u.newRow(),this.message(u.toString(),!0),e},this.printPlannedAccounts=({retain:e,remove:t,add:n},i,a)=>{const o=" ".repeat(a),s=[...e.map(e=>({account:e,format:i.retain,nestedFormat:{header:l.identity,add:u.green,remove:u.red,retain:l.identity}})),...t.map(e=>({account:e,format:i.remove,nestedFormat:{header:u.red,add:u.red,remove:u.red,retain:u.red}})),...n.map(e=>({account:e,format:i.add,nestedFormat:{header:u.green,add:u.green,remove:u.green,retain:u.green}}))].sort((e,t)=>e.account.id.localeCompare(t.account.id));0!==s.length?(this.message(i.header(`${o}accounts:`)),s.forEach(({account:e,format:t,nestedFormat:n})=>{this.message(t(`${o}- id: ${e.id}`)),this.printPlannedPolicies("service control policies",e.serviceControlPolicies,n,a+2),this.printPlannedPolicies("tag policies",e.tagPolicies,n,a+2)})):this.message(i.header(`${o}accounts: []`))},this.printPlannedPolicies=(e,{remove:t,retain:n,add:i},a,o)=>{const s=" ".repeat(o),r=[...n.map(e=>({name:e,format:a.retain})),...t.map(e=>({name:e,format:a.remove})),...i.map(e=>({name:e,format:a.add}))].sort((e,t)=>e.name.localeCompare(t.name));if(0===r.length)return void this.message(a.header(`${s}${e}: []`));this.message(a.header(`${s}${e}:`));const c=" ".repeat(o+2);r.forEach(({name:e,format:t})=>this.message(t(`${c}- ${e}`)))},this.printOrganizationalUnits=e=>{this.message("organizational units:",!0);const t=e=>e.children.reduce((e,n)=>[...e,...t(n)],[e]);t(e.root).forEach(e=>{switch(e.operation){case"delete":this.message(u.red(`  ${e.path}:`));const t={header:u.red,add:u.red,remove:u.red,retain:u.red};this.printPlannedPolicies("service control policies",e.serviceControlPolicies,t,4),this.printPlannedPolicies("tag policies:",e.tagPolicies,t,4),this.printPlannedAccounts(e.accounts,t,4);break;case"add":this.message(u.green(`  ${e.path}:`));const n={header:u.green,add:u.green,remove:u.green,retain:u.green};this.printPlannedPolicies("service control policies",e.serviceControlPolicies,n,4),this.printPlannedPolicies("tag policies",e.tagPolicies,n,4),this.printPlannedAccounts(e.accounts,n,4);break;default:this.message(`  ${e.path}:`);const i={header:l.identity,add:u.green,retain:l.identity,remove:u.red};this.printPlannedPolicies("service control policies",e.serviceControlPolicies,i,4),this.printPlannedPolicies("tag policies",e.tagPolicies,i,4),this.printPlannedAccounts(e.accounts,i,4)}})},this.printPoliciesDeploymentPlan=e=>{const{serviceControlPolicies:t,tagPolicies:n}=e;this.message("policies:",!0),this.printPolicies("service control policies",t),this.printPolicies("tag policies",n)},this.printPolicies=(e,t)=>{0!==t.length?(this.message(`  ${e}:`),t.forEach(e=>{switch(e.operation){case"add":this.message(u.green(`    ${e.name}:`)),this.message(u.green(`      id: ${e.id}`)),this.message(u.green(`      description: ${e.newDescription}`));break;case"update":this.message(u.yellow(`    ${e.name}:`)),this.message(u.yellow(`      id: ${e.id}`)),this.message(u.yellow(`      description: ${e.newDescription}`));break;case"delete":this.message(u.red(`    ${e.name}:`)),this.message(u.red(`      id: ${e.id}`)),this.message(u.red(`      description: ${e.currentDescription}`));break;case"skip":this.message(`    ${e.name}:`),this.message(`      id: ${e.id}`),this.message(`      description: ${e.currentDescription}`);break;default:throw new Error(`Unsupported operation: '${e.operation}'`)}})):this.message(`  ${e}: []`)},this.printEnabledPolicyTypes=e=>{this.message("enabled policy types:",!0),[...e.enabledPolicies.retain.map(e=>({name:e,operation:"retain"})),...e.enabledPolicies.add.map(e=>({name:e,operation:"add"})),...e.enabledPolicies.remove.map(e=>({name:e,operation:"remove"}))].sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{switch(e.operation){case"add":this.message(u.green(`  - ${e.name}`));break;case"remove":this.message(u.red(`  - ${e.name}`));break;default:this.message(`  - ${e.name}`)}})},this.printTrustedServices=e=>{const t=[...e.trustedServices.retain.map(e=>({name:e,operation:"retain"})),...e.trustedServices.add.map(e=>({name:e,operation:"add"})),...e.trustedServices.remove.map(e=>({name:e,operation:"remove"}))].sort((e,t)=>e.name.localeCompare(t.name));0!==t.length?(this.message("trusted AWS services:",!0),t.forEach(e=>{switch(e.operation){case"add":this.message(u.green(`  - ${e.name}`));break;case"remove":this.message(u.red(`  - ${e.name}`));break;default:this.message(`  - ${e.name}`)}})):this.message("trusted AWS services: []",!0)}}}t.default=d},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(210),s=i(n(213));t.default={command:"describe",desc:"Describe organization",builder:{},handler:e=>a.handle(e,e=>e,e=>o.describeOrganizationCommand(e,new s.default(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(211);t.describeOrganizationCommand=i.describeOrganizationCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(4)),s=n(0),r=n(22),c=n(212),u=o.default.object({}).unknown(!0);t.describeOrganizationCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return s.validateInput(u,e).then(({options:e,variables:n})=>r.buildOrganizationContext(e,n,t)).then(e=>c.describeOrganization(e,t)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(2),o=n(0);t.describeOrganization=(e,t)=>i(void 0,void 0,void 0,(function*(){const t=new a.StopWatch("total"),n=e.getClient(),[i,s]=yield Promise.all([n.describeOrganization(),n.listOrganizationRoots()]),r=s[0].PolicyTypes.filter(e=>"ENABLED"===e.Status).map(e=>e.Type),c=yield n.describeAccount(i.MasterAccountId);return{organization:i,services:"ALL"===i.FeatureSet?yield n.listAWSServiceAccessForOrganization():[],enabledPolicies:r,masterAccount:c,success:!0,watch:t.stop(),status:o.CommandStatus.SUCCESS,message:"Success"}}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(9)),o=i(n(11)),s=n(3);class r extends a.default{constructor(e){super(e),this.printOutput=e=>{const{organization:t,services:n,enabledPolicies:i,masterAccount:a}=e,r=0===i.length?"-":i.join(", ");this.header("ORGANIZATION",!0),this.message(`id:              ${t.Id}`),this.message(`arn:             ${t.Arn}`),this.message(`feature set:     ${t.FeatureSet}`),this.message(`policy types:    ${r}`),this.header("MASTER ACCOUNT",!0),this.message(`id:            ${a.Id}`),this.message(`arn:           ${a.Arn}`),this.message(`email:         ${a.Email}`),this.message(`name:          ${a.Name}`),this.header("TRUSTED ACCESS FOR AWS SERVICES",!0);const c=new o.default;return s.ORGANIZATION_SERVICE_PRINCIPALS.forEach(e=>{const t=void 0!==n.find(t=>t.ServicePrincipal===e);c.cell("Service",e),c.cell("Enabled",t),c.newRow()}),this.message(c.print()),e}}}t.default=r},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(215),s=i(n(218));t.default={command:"create",desc:"Create a new organization",builder:e=>e.option("feature-set",{description:"Feature set",string:!0,global:!1,default:"ALL",demandOption:!1}),handler:e=>a.handle(e,t=>Object.assign(Object.assign({},t),{featureSet:e["feature-set"]}),e=>o.createOrganizationCommand(e,new s.default(e.options)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(216);t.createOrganizationCommand=i.createOrganizationCommand},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),s=a(n(4)),r=n(217),c=s.default.object({featureSet:s.default.string().valid("ALL","CONSOLIDATED_BILLING")}).unknown(!0);t.createOrganizationCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return o.validateInput(c,e).then(()=>r.createOrganization(e,t)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(2),o=n(25),s=n(0),r=n(62);t.createOrganization=(e,t)=>i(void 0,void 0,void 0,(function*(){const n=new a.StopWatch("total"),{options:c,featureSet:u}=e,l=yield o.initDefaultCredentialProviderChain(),d=new o.DefaultCredentialProvider(l);t.info("Validate credentials");const f=yield(e=>i(void 0,void 0,void 0,(function*(){return e.getCallerIdentity()})))(d);if(!c.isAutoConfirmEnabled()&&!(yield t.confirmOrganizationCreation(f.accountId,u)))return{message:"Cancelled",status:s.CommandStatus.CANCELLED,success:!0,organization:null,watch:n.stop()};const h=new r.OrganizationsClient({logger:t,credentialProvider:d,region:"us-east-1"});try{const e=yield h.createOrganization(u);return{message:"Success",status:s.CommandStatus.SUCCESS,success:!0,organization:e,watch:n.stop()}}catch(e){return t.error("Failed to create the organization",e),{message:e.message,status:s.CommandStatus.FAILED,success:!1,organization:null,watch:n.stop()}}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(9));class s extends o.default{constructor(e){super(e),this.printOutput=e=>{const{organization:t}=e;return t?(this.header("ORGANIZATION",!0),this.message(`id:            ${t.Id}`),this.message(`arn:           ${t.Arn}`),this.message(`feature set:   ${t.FeatureSet}`),this.header("MASTER ACCOUNT",!0),this.message(`id:            ${t.MasterAccountId}`),this.message(`arn:           ${t.MasterAccountArn}`),this.message(`email:         ${t.MasterAccountEmail}`),e):e},this.confirmOrganizationCreation=(e,t)=>i(this,void 0,void 0,(function*(){return this.longMessage(["Organization information:","",`  master account id:   ${e}`,`  feature set:         ${t}`],!0),this.confirm("Continue to create a new organization?",!0)}))}}t.default=s},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(220));t.default={command:"org-units <command>",desc:"Manage organizational units",builder:e=>e.command(a.default),handler:e=>{}}},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=n(221),s=i(n(223));t.default={command:"list",desc:"List organizational units",builder:{},handler:e=>a.handle(e,e=>e,e=>o.listOrganizationalUnitsCommand(e,new s.default(e.options)))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(4)),s=n(222),r=n(0),c=n(22),u=o.default.object({}).unknown(!0);t.listOrganizationalUnitsCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return r.validateInput(u,e).then(({options:e,variables:n})=>c.buildOrganizationContext(e,n,t)).then(e=>s.listOrganizationalUnits(e,t)).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(2),o=n(0);t.listOrganizationalUnits=(e,t)=>i(void 0,void 0,void 0,(function*(){const t=new a.StopWatch("total"),n=e.getClient(),[s,r,c]=yield Promise.all([n.listAllOrganizationUnitsWithDetails(),n.listPolicies("SERVICE_CONTROL_POLICY"),n.listPolicies("TAG_POLICY")]),u=yield Promise.all([...r,...c].map(e=>i(void 0,void 0,void 0,(function*(){const t=yield n.listTargetsAttachedToPolicy(e.Id);return{policy:e,targets:t}})))),l=new Map,d=new Map;return u.forEach(({targets:e,policy:t})=>{l.set(t.Id,e),e.forEach(e=>{const n=d.get(e.TargetId);n?n.push(t):d.set(e.TargetId,[t])})}),{organizationalUnits:s,serviceControlPolicies:r,tagPolicies:c,targetsByPolicyId:l,policiesByTargetId:d,success:!0,watch:t.stop(),status:o.CommandStatus.SUCCESS,message:"Success"}}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(9));class o extends a.default{constructor(e){super(e),this.printOu=(e,t,n,i)=>{this.message(`  ${t}:`,!0),this.message(""),this.message("")},this.printOutput=e=>{const{organizationalUnits:t,targetsByPolicyId:n}=e;return e}}}t.default=o},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(225)),o=i(n(235));t.default={command:"targets <command>",desc:"Deployment targets",builder:e=>e.command(a.default).command(o.default),handler:e=>{}}},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=i(n(71)),s=n(23),r=n(72);t.default={command:"deploy [groups..]",desc:"Deploy deployment targets",builder:e=>e.option("target",{description:"Targets to deploy",string:!0,global:!1,demandOption:!1}).option("config-file",{description:"Deployment config file",string:!0,global:!1,demandOption:!1}),handler:e=>a.handle(e,t=>{return Object.assign(Object.assign({},t),{targets:(n=e.target,n?Array.isArray(n)?n:[n]:[]),groups:e.groups||[],configFile:e["config-file"]||null,operation:s.DeploymentOperation.DEPLOY});var n},e=>r.deploymentTargetsOperationCommand(e,new o.default(e.options,s.DeploymentOperation.DEPLOY)))}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(4)),s=n(64),r=n(0),c=n(227),u=n(228),l=o.default.object({groups:o.default.array().items(s.deploymentGroupPath).unique(),targets:o.default.array().items(s.deploymentTargetName).unique()}).unknown(!0);t.deploymentTargetsOperationCommand=(e,t)=>i(void 0,void 0,void 0,(function*(){return r.validateInput(l,e).then(({options:n,variables:i})=>c.buildDeploymentTargetsContext(n,i,e.configFile,t)).then(n=>u.planDeployment({ctx:n,input:e,io:t,watch:e.watch})).then(t.printOutput)}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(25),s=a(n(13)),r=n(3),c=n(8),u=n(1),l=n(17),d=n(48),f=n(63);t.buildDeploymentTargetsContext=(e,t,n,a)=>i(void 0,void 0,void 0,(function*(){const h=yield o.initDefaultCredentialProviderChain(),m=new o.DefaultCredentialProvider(h);a.info("Validate credentials"),yield(e=>i(void 0,void 0,void 0,(function*(){return e.getCallerIdentity()})))(m);const p=e.getProjectDir();a.debug(`Current project dir: ${p}`);const g=s.default.join(p,r.DEPLOYMENT_DIR);if(!(yield c.dirExists(g)))throw new u.BaubleError(`Bauble deployment dir '${r.DEPLOYMENT_DIR}' not found from the project dir ${p}`);const v=n||r.DEPLOYMENT_CONFIG_FILE,y=s.default.join(g,v);if(!(yield c.fileExists(y)))throw new u.BaubleError(`Bauble deployment configuration file '${v}' not found from the deployment dir ${g}`);const C=new l.TemplateEngine,w=yield f.parseDeploymentConfigFile(a,e,t,y,C);return new d.DeploymentTargetsContext({configFile:w,defaultCredentialProvider:m,options:e,variables:t,logger:a})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(1),s=n(48),r=a(n(10)),c=n(12),u=a(n(49)),l=n(0),d=n(229);t.planDeployment=e=>i(void 0,void 0,void 0,(function*(){const{ctx:t,io:n,watch:i,input:{groups:a,targets:f}}=e;a.length>0&&a.forEach(e=>{if(!t.hasDeploymentGroup(e))throw new o.BaubleError(`Deployment group '${e}' not found`)});const h=0===a.length?t.getRootDeploymentGroups():a.reduce((e,n)=>[...e,t.getDeploymentGroup(n)],new Array),m=(e,t)=>{const n=e.priority-t.priority;return 0!==n?n:e.name.localeCompare(t.name)},p=r.default(h.map(e=>r.default(c.collectFromHierarchy(e,e=>e.children,{sortSiblings:m,filter:e=>e.status===s.DeploymentStatus.ACTIVE})))),g=u.default(p,e=>e.path).filter(e=>e.status===s.DeploymentStatus.ACTIVE).map(e=>Object.assign(Object.assign({},e),{targets:e.targets.filter(e=>e.status===s.DeploymentStatus.ACTIVE&&e.configSets.length>0&&(0===f.length||f.includes(e.name)))})).filter(e=>e.targets.length>0),v=g.length>0;if(!v)return n.info("No targets to deploy"),{results:[],watch:i.stop(),success:!0,status:l.CommandStatus.SKIPPED,message:"No targets to deploy"};const y={groups:g,hasChanges:v};return d.confirmOperation(Object.assign(Object.assign({},e),{plan:y}))}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(230);t.confirmOperation=e=>i(void 0,void 0,void 0,(function*(){const{io:t,input:n,watch:i,plan:s}=e,{options:r}=n;return r.isAutoConfirmEnabled()||(yield t.confirmOperation(s))?o.processOperation(e):{results:[],message:"Cancelled",status:a.CommandStatus.CANCELLED,success:!1,watch:i.stop()}}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(231);t.processOperation=e=>i(void 0,void 0,void 0,(function*(){const{watch:t,io:n,plan:i}=e,s=t.startChild("process"),r=new Array;n.info("Process operation");const c={failed:!1};for(const t of i.groups){const n=yield o.processDeploymentGroup(e,t,s.startChild(t.name),c);r.push(n)}return Object.assign(Object.assign({},a.resolveCommandOutputBase(r)),{results:r,watch:s.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(232);t.processDeploymentGroup=(e,t,n,s)=>i(void 0,void 0,void 0,(function*(){const{io:i}=e;i.info(`Execute deployment group: ${t.path}`);const r=new Array;for(const i of t.targets){const a=yield o.processDeploymentTarget(e,t,i,n.startChild(i.name),s);r.push(a)}return Object.assign(Object.assign({},a.resolveCommandOutputBase(r)),{results:r,path:t.path,watch:n.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(233);t.processDeploymentTarget=(e,t,n,s,r)=>i(void 0,void 0,void 0,(function*(){const{io:i,ctx:c}=e;i.info(`Execute deployment target: ${n.name}`);const u=new Array;for(const i of n.configSets){const a=c.getConfigSet(i),l=yield o.processConfigSet(e,t,n,a,s.startChild(i),r);u.push(l)}return Object.assign(Object.assign({},a.resolveCommandOutputBase(u)),{results:u,name:n.name,watch:s.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),o=n(234);t.processConfigSet=(e,t,n,s,r,c)=>i(void 0,void 0,void 0,(function*(){const{io:i}=e;i.info(`Execute config set: ${s.name}`);const u=new Array;for(const i of s.commandPaths){const a=yield o.processCommandPath(e,t,n,s,i,r.startChild(i),c);u.push(a),a.success||(c.failed=!0)}return Object.assign(Object.assign({},a.resolveCommandOutputBase(u)),{results:u,configSetName:s.name,watch:r.stop()})}))},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(23),s=n(2),r=n(0),c=a(n(34)),u=n(36),l=a(n(42)),d=n(43),f=a(n(45)),h=(e,t,n,a,s,r,c,h)=>i(void 0,void 0,void 0,(function*(){const m={variables:e,watch:h,options:t,commandPath:s,ignoreDependencies:!1};switch(a){case o.DeploymentOperation.DEPLOY:return((e,t,n,a,o,s)=>i(void 0,void 0,void 0,(function*(){const i=yield u.launchStacksCommand(s,new l.default(e,`${a}/${o}`),t);return{commandPath:n,result:i,status:i.status,success:i.success}})))(t,n,s,r,c,m);case o.DeploymentOperation.UNDEPLOY:return((e,t,n,a,o,s)=>i(void 0,void 0,void 0,(function*(){const i=yield d.deleteStacksCommand(s,new f.default(e,`${a}/${o}`),t);return{commandPath:n,result:i,status:i.status,success:i.success}})))(t,n,s,r,c,m);default:throw new Error(`Unknown operation: ${a}`)}}));t.processCommandPath=(e,t,n,a,o,u,l)=>i(void 0,void 0,void 0,(function*(){const{io:i,ctx:d,input:{operation:f}}=e,m=d.getConfigFile(),p=d.getDefaultCredentialProvider(),g=d.getVariables(),v=d.getOptions();if(i.info(`Execute command path: ${o}`),l.failed)return{commandPath:o,result:{message:"Cancelled",status:r.CommandStatus.CANCELLED,watch:u.startChild("total").stop(),success:!1,results:[]},status:r.CommandStatus.CANCELLED,success:!1};const y=s.deepCopy(g.vars);c.default(y,m.vars,t.vars,n.vars);const C={env:g.env,vars:y,context:g.context};try{return h(C,v,p,f,o,t.path,n.name,u.startChild("total"))}catch(e){return i.error(`Unhandled error when executing group: ${t.path}, target: ${n.name}, config set: ${a.name}, command path: ${o}`,e),{commandPath:o,result:{message:e.message,status:r.CommandStatus.FAILED,watch:u.startChild("total").stop(),success:!1,results:[]},success:!1,status:r.CommandStatus.FAILED}}}))},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(5),o=i(n(71)),s=n(23),r=n(72);t.default={command:"undeploy [groups..]",desc:"Undeploy deployment targets",builder:e=>e.option("target",{description:"Targets to undeploy",string:!0,global:!1,demandOption:!1}).option("config-file",{description:"Deployment config file",string:!0,global:!1,demandOption:!1}),handler:e=>a.handle(e,t=>{return Object.assign(Object.assign({},t),{targets:(n=e.target,n?Array.isArray(n)?n:[n]:[]),groups:e.groups||[],configFile:e["config-file"]||null,operation:s.DeploymentOperation.UNDEPLOY});var n},e=>r.deploymentTargetsOperationCommand(e,new o.default(e.options,s.DeploymentOperation.UNDEPLOY)))}}]);
//# sourceMappingURL=bundle.js.map